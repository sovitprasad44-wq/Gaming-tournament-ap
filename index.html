<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>  Tournament Hub</title>
    <link rel="icon" type="image/png" href="images/logoapp.png">
    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- CSS Styles --- */
        :root {
            --primary-bg: #0F172A;
            --secondary-bg: #1E293B;
            --card-bg: #1E293B;
            --text-primary: #E2E8F0;
            --text-secondary: #94A3B8;
            --accent-color: #FACC15;
            --accent-gradient: linear-gradient(135deg, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6;
            --border-color: #334155;
            --bottom-nav-bg: #1E293B;
            --success-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --info-color: #3B82F6;
        }


.header-menu-button:hover {
    color: var(--accent-color);
    transform: scale(1.1);
}


.friend-status-indicator {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #10B981;
    border: 2px solid var(--primary-bg);
    bottom: 2px;
    right: 2px;
}

.friend-status-indicator.offline {
    background: #6B7280;
}
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
            color: var(--text-primary); 
            padding-top: 70px; 
            padding-bottom: 75px; 
            min-height: 100vh; 
            overscroll-behavior-y: contain;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at top, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                        radial-gradient(ellipse at bottom, rgba(250, 204, 21, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        a { color: var(--accent-color); text-decoration: none; transition: all 0.3s ease; }
        a:hover { color: #FBBF24; transform: translateY(-1px); }
        
        .main-content { padding: 15px; position: relative; z-index: 1; }
        .section { 
            display: none; 
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .section.active { display: block; }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .section-title { 
            font-size: 1.1rem; 
            font-weight: 600; 
            margin-bottom: 15px; 
            color: var(--text-primary);
            position: relative;
            padding-left: 12px;
        }
        
        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 20px;
            background: var(--accent-gradient);
            border-radius: 2px;
        }
        
        .custom-card { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            backdrop-filter: blur(10px);
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 15px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .custom-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(250, 204, 21, 0.2);
        }
        
        .btn-custom { 
            border-radius: 12px; 
            font-size: 0.9rem; 
            font-weight: 600; 
            padding: 10px 20px; 
            border: none; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-custom::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-custom:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-custom-primary { 
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .btn-custom-primary:hover { 
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-custom-secondary { 
            background: rgba(30, 41, 59, 0.6);
            color: var(--text-primary); 
            border: 1px solid var(--border-color);
        }
        .btn-custom-secondary:hover { 
            background: rgba(51, 65, 85, 0.8);
            border-color: var(--accent-color);
        }
        
        .btn-custom-accent { 
            background: var(--accent-gradient);
            color: var(--primary-bg); 
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
        }
        .btn-custom-accent:hover { 
            box-shadow: 0 6px 25px rgba(250, 204, 21, 0.5);
            transform: translateY(-2px) scale(1.02);
        }
        
        .btn-custom-link { 
            background: none; 
            border: none; 
            color: var(--primary-button-bg); 
            font-size: 0.9rem; 
            font-weight: 500; 
            padding: 0; 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-custom-link:hover {
            color: var(--accent-color);
            transform: translateX(3px);
        }
        
        .text-accent { color: var(--accent-color); }
        .text-success { color: var(--success-color); }
        .text-danger { color: var(--danger-color); }
        .text-warning { color: var(--warning-color); }
        
        .form-control { 
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            border-radius: 10px;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        .form-control:focus { 
            background: rgba(15, 23, 42, 0.8);
            border-color: var(--accent-color); 
            color: var(--text-primary); 
            box-shadow: 0 0 0 0.3rem rgba(250, 204, 21, 0.15);
            transform: translateY(-1px);
        }
        .form-control::placeholder { 
            color: var(--text-secondary); 
            opacity: 0.7; 
        }
        
        .form-label { 
    color: var(--text-secondary); 
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 5px;
}
        
        .alert { 
            border-radius: 12px; 
            font-size: 0.9rem;
            border: none;
            backdrop-filter: blur(10px);
        }
        
        .list-group-item { 
            background: rgba(30, 41, 59, 0.5);
            color: var(--text-primary); 
            border: none; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 18px; 
            font-size: 0.95rem; 
            transition: all 0.3s ease;
        }
        .list-group-item:hover { 
            background: rgba(51, 65, 85, 0.6);
            transform: translateX(5px);
        }
        .list-group-item:last-child { border-bottom: none; }
        .list-group-item i:first-child { 
            color: var(--accent-color); 
            margin-right: 15px; 
            font-size: 1.2rem; 
            width: 24px; 
            text-align: center;
        }
        .list-group-item .bi-chevron-right { 
            color: var(--text-secondary); 
            font-size: 1rem;
            transition: transform 0.3s ease;
        }
        .list-group-item:hover .bi-chevron-right {
            transform: translateX(3px);
        }
        
        #globalLoaderEl { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            display: none;
        }
        
        .spinner-border { 
            color: var(--accent-color); 
            width: 3rem; 
            height: 3rem;
            border-width: 4px;
        }
        
        .placeholder-glow .placeholder { 
            background-color: rgba(51, 65, 85, 0.3);
            animation: placeholder-glow 2s ease-in-out infinite; 
        }
        .placeholder { 
            background-color: rgba(51, 65, 85, 0.3);
            border-radius: 8px; 
        }
        
        @keyframes placeholder-glow { 
            0% { background-color: rgba(51, 65, 85, 0.3); } 
            50% { background-color: rgba(51, 65, 85, 0.5); } 
            100% { background-color: rgba(51, 65, 85, 0.3); } 
        }
        
        .interactive-list-item { cursor: pointer; }
        .referral-code { 
            font-family: 'Courier New', monospace;
            letter-spacing: 2px; 
            user-select: all;
            font-weight: 700;
        }
        
        /* Header Styles */
        .app-header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 70px; 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            backdrop-filter: blur(20px);
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 20px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 1000; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 12px;
        }
        
        .header-logo { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, var(--accent-color), #FBBF24);
            object-fit: cover; 
            border: 2px solid var(--accent-color);
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
            animation: pulse 2s infinite;
        }
        
        .header-title { 
            font-size: 0.95rem; 
            font-weight: 600; 
            line-height: 1.3;
        }
        .header-title span { 
            font-size: 0.8rem; 
            color: var(--text-secondary); 
            display: block;
            font-weight: 400;
        }
        
        .header-back-button { 
            background: none; 
            border: none; 
            color: var(--text-primary); 
            font-size: 1.5rem; 
            margin-right: 8px; 
            display: none; 
            padding: 8px; 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .header-back-button:hover {
            color: var(--accent-color);
            transform: translateX(-3px);
        }
        
        .header-right { 
            display: flex; 
            align-items: center; 
            gap: 15px;
        }
        
        .notification-icon { 
            font-size: 1.4rem; 
            color: var(--text-primary); 
            position: relative; 
            background: none; 
            border: none; 
            padding: 8px; 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .notification-icon:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }
        
        .notification-badge { 
            position: absolute; 
            top: 2px; 
            right: 2px; 
            background: linear-gradient(135deg, var(--danger-color), #DC2626);
            color: white; 
            font-size: 0.65rem; 
            min-width: 18px;
            height: 18px; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            animation: pulse 2s infinite;
        }
        
        .wallet-chip { 
            background: var(--accent-gradient);
            color: var(--primary-bg); 
            padding: 8px 16px; 
            border-radius: 25px; 
            display: flex; 
            align-items: center; 
            font-size: 0.9rem; 
            font-weight: 700; 
            border: none; 
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .wallet-chip:hover {
            box-shadow: 0 6px 25px rgba(250, 204, 21, 0.5);
            transform: translateY(-2px) scale(1.05);
        }
        .wallet-chip i { 
            margin-right: 6px; 
            font-size: 1rem;
        }
        
        .header-game-title { 
            font-size: 1.05rem; 
            font-weight: 600; 
            color: var(--text-primary); 
            margin-left: 10px; 
            display: none;
        }
        
        /* Bottom Navigation */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 70px; 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            backdrop-filter: blur(20px);
            display: flex; 
            justify-content: space-around; 
            align-items: stretch; 
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
            z-index: 1000; 
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--text-secondary); 
            text-decoration: none; 
            flex-grow: 1; 
            padding: 8px 0; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none; 
            background: none; 
            cursor: pointer; 
            font-size: 0.75rem;
            position: relative;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--accent-gradient);
            transition: width 0.3s ease;
        }
        
        .nav-item.active::before {
            width: 60%;
        }
        
        .nav-item i { 
            font-size: 1.5rem; 
            margin-bottom: 4px; 
            line-height: 1;
            transition: all 0.3s ease;
        }
        .nav-item span { 
            font-size: 0.75rem; 
            font-weight: 500; 
            line-height: 1;
        }
        .nav-item.active { 
            color: var(--accent-color);
        }
        .nav-item.active i {
            transform: translateY(-2px);
        }
        .nav-item:not(.active):hover {
            color: var(--accent-color);
            transform: translateY(-2px);
        }
        
        /* Swiper Slider */
        .swiper-container#promotionSliderEl { 
    width: 100%; 
    height: 200px; 
    border-radius: 16px; 
    margin-bottom: 25px; 
    --swiper-pagination-color: var(--accent-color); 
    --swiper-pagination-bullet-inactive-color: var(--text-secondary); 
    --swiper-pagination-bullet-size: 10px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    padding: 0; /* Remove padding */
    overflow: hidden;
}
        
        .swiper-slide { 
    background: rgba(30, 41, 59, 0.5);
    border-radius: 16px;
    overflow: hidden;
    margin: 0; /* Remove gaps */
}
/* Premium Swiper Animations */
.swiper-slide {
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0.7;
    transform: scale(0.95);
}

.swiper-slide-active {
    opacity: 1 !important;
    transform: scale(1) !important;
}

.swiper-slide-next,
.swiper-slide-prev {
    opacity: 0.5;
}

/* Pagination Premium Style */
.swiper-pagination-bullet {
    width: 12px;
    height: 12px;
    background: var(--text-secondary);
    opacity: 0.5;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.swiper-pagination-bullet-active {
    width: 30px;
    border-radius: 6px;
    background: var(--accent-gradient);
    opacity: 1;
    box-shadow: 0 2px 12px rgba(250, 204, 21, 0.5);
}

/* Hover effect on slider */
.swiper-container#promotionSliderEl:hover .swiper-slide-active img {
    transform: scale(1.05);
}

/* Loading animation */
@keyframes shimmer {
    0% {
        background-position: -1000px 0;
    }
    100% {
        background-position: 1000px 0;
    }
}

.swiper-slide::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 50%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
    );
    animation: shimmer 3s infinite;
    pointer-events: none;
}
        .swiper-slide img { 
    display: block; 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    border-radius: 16px; /* Match parent radius */
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}
        .swiper-slide:hover img {
            transform: scale(1.05);
        }
        
        /* Game Cards */
        .game-card { 
            text-align: center; 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            border-radius: 16px; 
            overflow: hidden; 
            padding: 0; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .game-card:hover { 
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4), 0 0 0 2px rgba(250, 204, 21, 0.3);
        }
        .game-card img { 
            width: 100%; 
            height: 140px; 
            object-fit: cover; 
            display: block;
            transition: transform 0.3s ease;
        }
        .game-card:hover img {
            transform: scale(1.1);
        }
        .game-card span { 
            display: block; 
            padding: 12px 8px; 
            font-weight: 600; 
            font-size: 0.95rem; 
            color: var(--text-primary);
            background: rgba(15, 23, 42, 0.5);
        }
        
        /* Tournament Tabs */
        .tournament-tabs { 
            display: flex; 
            justify-content: space-around; 
            background: rgba(30, 41, 59, 0.5);
            padding: 6px; 
            border-radius: 12px; 
            margin-bottom: 15px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
.tournament-filter-chip {
    display: inline-block;
    padding: 8px 16px;
    background: rgba(250, 204, 21, 0.1);
    border: 2px solid rgba(250, 204, 21, 0.3);
    border-radius: 20px;
    color: var(--accent-color);
    font-size: 0.85rem;
    font-weight: 600;
    margin: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tournament-filter-chip:hover {
    background: rgba(250, 204, 21, 0.2);
    border-color: var(--accent-color);
    transform: translateY(-2px);
}

.tournament-filter-chip.active {
    background: var(--accent-gradient);
    color: var(--primary-bg);
    border-color: var(--accent-color);
}

        .tab-item { 
            color: var(--text-secondary); 
            background: none; 
            border: none; 
            padding: 10px 12px; 
            font-size: 0.85rem; 
            font-weight: 600; 
            border-radius: 8px; 
            flex-grow: 1; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tab-item.active { 
            background: var(--primary-button-bg);
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transform: scale(1.05);
        }
        .tab-item:not(.active):hover {
            background: rgba(51, 65, 85, 0.5);
            color: var(--text-primary);
        }
        .tab-item i { margin-right: 6px; }
        
        /* Tournament Cards */
        .tournament-card { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(30, 41, 59, 0.7) 100%);
            backdrop-filter: blur(10px);
            border-radius: 16px; 
            margin-bottom: 15px; 
            padding: 18px; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

.tournament-banner {
    position: relative;
    overflow: hidden;
}

.tournament-banner::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(to bottom, transparent, rgba(15, 23, 42, 0.8));
}

.tournament-banner img {
    transition: transform 0.3s ease;
}

.tournament-card:hover .tournament-banner img {
    transform: scale(1.05);
}
        
        .tournament-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent-gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .tournament-card:hover::before {
            transform: scaleX(1);
        }
        
        .tournament-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(250, 204, 21, 0.2);
        }
        
        .tournament-card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px; 
            flex-wrap: wrap; 
            gap: 8px;
        }
        
        .tournament-card-tags span { 
            background: rgba(15, 23, 42, 0.6);
            color: var(--text-secondary); 
            font-size: 0.7rem; 
            font-weight: 500; 
            padding: 4px 10px; 
            border-radius: 6px; 
            display: inline-block; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-right: 6px; 
            margin-bottom: 6px;
            transition: all 0.3s ease;
        }
        .tournament-card-tags span:hover {
            background: rgba(250, 204, 21, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .tournament-card-timer { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);
            color: var(--info-color);
            font-size: 0.75rem; 
            font-weight: 700; 
            padding: 5px 12px; 
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }
        
        .tournament-card-title { 
            font-size: 1.05rem; 
            font-weight: 700; 
            margin-bottom: 8px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: var(--text-primary);
        }
        .tournament-card-title i { 
            color: var(--accent-color);
            font-size: 1.2rem;
        }
        
        .tournament-card-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: stretch; 
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
            padding: 12px 0; 
            margin: 12px 0; 
            font-size: 0.85rem;
        }
        
        .info-item { 
            text-align: center; 
            flex: 1; 
            padding: 0 8px;
        }
        .info-item span { 
            display: block; 
            color: var(--text-secondary); 
            font-size: 0.75rem; 
            margin-bottom: 4px;
            font-weight: 500;
        }
        .info-item strong { 
            color: var(--text-primary); 
            font-weight: 700; 
            font-size: 0.95rem;
        }
        .info-item .prize-icon { 
            color: var(--accent-color); 
            font-size: 1.3rem;
            filter: drop-shadow(0 2px 4px rgba(250, 204, 21, 0.3));
        }
        
        .tournament-card-spots { 
            font-size: 0.85rem; 
            color: var(--text-secondary); 
            margin-bottom: 15px;
        }
        .tournament-card-spots span { 
            font-weight: 700;
        }
        
        .progress { 
            height: 8px; 
            background: rgba(15, 23, 42, 0.6);
            border-radius: 4px; 
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .progress-bar { 
            background: var(--accent-gradient);
            transition: width 0.6s ease;
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
        }
        
        .tournament-card-actions { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 12px;
        }
        .tournament-card-actions .btn-sm { 
            padding: 10px 12px; 
            font-size: 0.85rem; 
            width: 100%;
            font-weight: 600;
        }
        .tournament-card-actions .btn-join { 
            background: var(--accent-gradient);
            color: var(--primary-bg); 
            font-weight: 700; 
            grid-column: 2 / 3;
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
        }
        .tournament-card-actions .btn-join:hover {
            box-shadow: 0 6px 25px rgba(250, 204, 21, 0.5);
        }
        .tournament-card-actions .btn-details { 
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-color); 
            grid-column: 1 / 2;
        }
        .tournament-card-actions .btn-details:hover {
            background: rgba(51, 65, 85, 0.8);
            border-color: var(--accent-color);
        }
        .tournament-card-actions .btn-joined { 
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: var(--text-primary); 
            opacity: 0.9; 
            grid-column: 2 / 3;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        .tournament-card-actions .btn-disabled { 
            background: rgba(30, 41, 59, 0.4);
            opacity: 0.5; 
            cursor: not-allowed; 
            grid-column: 2 / 3;
        }
        
        .btn-idpass { 
            background: var(--accent-gradient);
            color: var(--primary-bg); 
            border: none; 
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
        }
        .btn-idpass:hover {
            box-shadow: 0 6px 25px rgba(250, 204, 21, 0.5);
        }
        
        .btn-result {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: white;
            border: none;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            margin-top: 10px;
            width: 100%;
        }
        .btn-result:hover {
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }
        
        /* Wallet Card */
        .wallet-card { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(10px);
            border-radius: 16px; 
            padding: 25px; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }
        
        .wallet-card h2 { 
            font-size: 1.3rem; 
            font-weight: 700; 
            margin-bottom: 25px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .balance-section {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .total-balance {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .total-balance-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .total-balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }
        
        .balance-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 18px; 
            padding: 15px;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .balance-item:hover {
            background: rgba(30, 41, 59, 0.5);
            transform: translateX(5px);
        }
        
        .balance-item:last-child { 
            margin-bottom: 0;
        }
        
        .balance-item-label { 
            font-size: 0.95rem; 
            color: var(--text-secondary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .balance-item-label i {
            font-size: 1.2rem;
            color: var(--accent-color);
        }
        
        .balance-item-value { 
            font-size: 1.15rem; 
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .balance-item-action { 
            min-width: 110px; 
            text-align: right;
        }
        
        .balance-item-action .btn-custom-link { 
            font-size: 0.85rem; 
            color: var(--accent-color); 
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .balance-item-action .btn-custom-link:hover {
            background: rgba(250, 204, 21, 0.1);
        }
        
        .balance-item-action .btn-withdraw { 
            background: linear-gradient(135deg, var(--primary-button-bg), #2563EB);
            color: #fff; 
            font-size: 0.85rem; 
            padding: 8px 16px; 
            border-radius: 10px; 
            border: none;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        .balance-item-action .btn-withdraw:hover {
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }
        
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .wallet-actions .btn-custom {
            padding: 14px 20px;
            font-size: 0.95rem;
        }
        
        /* Transaction Items */
        #recentTransactionsListEl .custom-card { 
            background: rgba(30, 41, 59, 0.5);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        #recentTransactionsListEl .custom-card:hover {
            background: rgba(30, 41, 59, 0.7);
            transform: translateX(5px);
        }
        
        /* Earnings Section */
        #earnings-section .custom-card { 
            text-align: center;
            padding: 30px;
        }
        
        #earnings-section .display-4 { 
            font-size: 3rem;
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        #earnings-section p strong { 
            color: var(--text-primary);
            font-weight: 600;
        }
        
        /* Profile Header Card */
        .profile-header-card { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(10px);
            border-radius: 16px; 
            padding: 25px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            margin-bottom: 20px; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }
        
        .profile-avatar { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            margin-bottom: 15px; 
            border: 3px solid var(--accent-color);
            object-fit: cover; 
            background: rgba(15, 23, 42, 0.5);
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
            transition: all 0.3s ease;
        }
        .profile-avatar:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 25px rgba(250, 204, 21, 0.5);
        }
        
        .profile-name { 
            font-size: 1.2rem; 
            font-weight: 700; 
            margin-bottom: 5px;
            color: var(--text-primary);
        }
        
        .profile-email { 
            font-size: 0.85rem; 
            color: var(--text-secondary); 
            margin-bottom: 20px; 
            word-break: break-all;
        }
        
        .profile-stats { 
            display: flex; 
            justify-content: space-around; 
            width: 100%; 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
            gap: 10px;
        }
        
        .stat-item { 
            text-align: center; 
            flex: 1;
            padding: 10px;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .stat-item:hover {
            background: rgba(15, 23, 42, 0.5);
            transform: translateY(-3px);
        }
        .stat-item strong { 
            display: block; 
            font-size: 1.2rem; 
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 5px;
        }
        .stat-item span { 
            font-size: 0.75rem; 
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .profile-links .list-group { 
            border-radius: 12px; 
            overflow: hidden; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(30, 41, 59, 0.5);
        }
        
        .profile-links .form-switch .form-check-input { 
            background-color: rgba(30, 41, 59, 0.6);
            border-color: var(--border-color); 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3c/svg%3e");
            width: 50px;
            height: 26px;
            cursor: pointer;
        }
        .profile-links .form-switch .form-check-input:checked { 
            background-color: var(--accent-color); 
            border-color: var(--accent-color); 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3c/svg%3e");
        }
        
        /* Login Section */
        #login-section { 
    margin-top: 0;
    padding: 20px 20px 40px 20px;
}
        
        #login-section .card { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            overflow: hidden;
        }
        
        #login-section .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            height: 4px;
            background: var(--accent-gradient);
        }
        
        #login-section .card-body {
            position: relative;
            z-index: 1;
        }
        
        #login-section .btn-primary { 
            background: linear-gradient(135deg, var(--primary-button-bg), #2563EB);
            border: none;
            padding: 12px;
            font-weight: 600;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }
        #login-section .btn-primary:hover {
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }
        
        #login-section .btn-link { 
            background: none; 
            border: none; 
            color: var(--accent-color); 
            text-decoration: none; 
            font-size: 0.9em; 
            padding: 8px 0;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        #login-section .btn-link:hover { 
            color: #FBBF24;
            text-decoration: underline;
        }
        
        #login-section .btn-success { 
            background: linear-gradient(135deg, var(--success-color), #059669);
            border: none;
            padding: 12px;
            font-weight: 600;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }
        #login-section .btn-success:hover {
            box-shadow: 0 6px 25px rgba(16, 185, 129, 0.5);
            transform: translateY(-2px);
        }
        
        #login-section .btn-danger { 
            background: linear-gradient(135deg, var(--danger-color), #DC2626);
            border: none;
            padding: 12px;
            font-weight: 600;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        #login-section .btn-danger:hover {
            box-shadow: 0 6px 25px rgba(239, 68, 68, 0.5);
            transform: translateY(-2px);
        }
        
        #login-section .form-divider { 
            text-align: center; 
            margin: 25px 0; 
            position: relative; 
            color: var(--text-secondary);
        }
        #login-section .form-divider::before, 
        #login-section .form-divider::after { 
            content: ""; 
            position: absolute; 
            top: 50%; 
            width: 40%; 
            height: 1px; 
            background: linear-gradient(to right, transparent, var(--border-color), transparent);
        }
        #login-section .form-divider::before { left: 0; }
        #login-section .form-divider::after { right: 0; }
        #login-section .form-divider span { 
            background-color: rgba(30, 41, 59, 0.9);
            padding: 0 15px; 
            position: relative; 
            z-index: 1; 
            font-size: 0.85rem; 
            font-weight: 600;
        }
        
        #login-section .card-title { 
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 25px;
        }
        
        #googleSignInBtnMainEl { display: none; }
        
        /* Modal Styles */
        .modal-content { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            backdrop-filter: blur(20px);
            color: var(--text-primary); 
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

/* âœ… FIX: Modal backdrop fix */
.modal-backdrop {
    background-color: rgba(0, 0, 0, 0.75) !important;
    backdrop-filter: blur(5px);
}

.modal.show {
    display: flex !important;
    align-items: center;
    justify-content: center;
}

.modal-dialog {
    margin: auto;
    z-index: 10001;
}
        
        .modal-header { 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 25px;
        }
        
        .modal-title {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer { 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 25px;
        }
        
        .btn-close-white { 
            filter: invert(1) grayscale(100%) brightness(200%);
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        .btn-close-white:hover {
            opacity: 1;
            transform: rotate(90deg);
        }
        
        .modal-body .phonepe-number { 
            color: var(--warning-color); 
            font-weight: 700; 
            user-select: text;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }
        
        #matchDetailsModalBodyEl pre { 
            background: rgba(15, 23, 42, 0.6);
            padding: 15px; 
            border-radius: 10px; 
            border: 1px solid var(--border-color); 
            color: var(--text-secondary); 
            font-size: 0.85rem; 
            white-space: pre-wrap; 
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        #policyModalBodyEl { 
            line-height: 1.8; 
            font-size: 0.95rem; 
            white-space: pre-wrap;
        }
        
        #idPasswordModalEl .copy-btn { 
            padding: 4px 10px; 
            font-size: 0.8rem; 
            margin-left: 10px; 
            vertical-align: middle;
            transition: all 0.3s ease;
        }
        #idPasswordModalEl .copy-btn:hover {
            transform: scale(1.05);
        }
        
        #policyModalBodyEl .copy-btn, 
        #policyModalBodyEl #shareReferralBtn { 
            padding: 8px 16px; 
            font-size: 0.9rem;
            border-radius: 8px;
        }
        #policyModalBodyEl #shareReferralBtn i, 
        #policyModalBodyEl .copy-btn i { 
            margin-right: 6px;
        }
        
        /* Notification Item */
        .notification-item { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            backdrop-filter: blur(10px);
            border-radius: 14px; 
            padding: 16px; 
            margin-bottom: 12px; 
            border-left: 4px solid var(--accent-color); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        } 
        .notification-item:hover { 
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.8) 0%, rgba(51, 65, 85, 0.6) 100%);
            transform: translateX(5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
        } 
        .notification-item.unread { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-left-color: var(--primary-button-bg);
        }
        
        .notification-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-color);
            flex-shrink: 0;
            background: rgba(15, 23, 42, 0.5);
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.2);
        }
        
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        
        .notification-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 8px; 
            gap: 10px;
        } 
        .notification-title { 
            font-weight: 600; 
            font-size: 0.95rem; 
            color: var(--text-primary); 
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        } 
        .notification-time { 
            font-size: 0.7rem; 
            color: var(--text-secondary);
            flex-shrink: 0;
            white-space: nowrap;
        } 
        .notification-message { 
            font-size: 0.85rem; 
            color: var(--text-secondary); 
            line-height: 1.5;
            word-wrap: break-word;
        }

        /* Transaction Item */
        .transaction-item { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            backdrop-filter: blur(10px);
            border-radius: 12px; 
            padding: 15px 18px; 
            margin-bottom: 12px; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .transaction-item:hover {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.8) 0%, rgba(51, 65, 85, 0.6) 100%);
            transform: translateX(5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
        }
        .transaction-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 8px;
        }
        .transaction-type { 
            font-weight: 600; 
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        .transaction-amount { 
            font-weight: 700; 
            font-size: 1.05rem;
        }
        .transaction-amount.credit { 
            color: var(--success-color);
        }
        .transaction-amount.debit { 
            color: var(--danger-color);
        }
        .transaction-details { 
            font-size: 0.8rem; 
            color: var(--text-secondary); 
            margin-top: 5px;
        }

        /* Earning Item */
        .earning-item { 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            backdrop-filter: blur(10px);
            border-radius: 12px; 
            padding: 15px 18px; 
            margin-bottom: 12px; 
            border-left: 4px solid var(--success-color);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .earning-item:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.08) 100%);
            transform: translateX(5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
        }
        .earning-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 8px;
        }
        .earning-type { 
            font-weight: 600; 
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        .earning-amount { 
            font-weight: 700; 
            font-size: 1.05rem; 
            color: var(--success-color);
        }
        .earning-details { 
            font-size: 0.8rem; 
            color: var(--text-secondary); 
            margin-top: 5px;
        }

        /* Edit Nickname Section */
        .edit-nickname-section { 
            background: rgba(15, 23, 42, 0.5);
            padding: 18px; 
            border-radius: 12px; 
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .edit-nickname-section .form-control { 
            margin-bottom: 12px;
        }

        /* Leaderboard Item */
        .leaderboard-item { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            backdrop-filter: blur(10px);
            border-radius: 14px; 
            padding: 15px 18px; 
            margin-bottom: 12px; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex; 
            align-items: center; 
            gap: 15px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .leaderboard-item:hover { 
            transform: translateX(8px) scale(1.02);
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.8) 0%, rgba(51, 65, 85, 0.6) 100%);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
        }
        .leaderboard-rank { 
            font-size: 1.6rem; 
            font-weight: 700; 
            min-width: 45px; 
            text-align: center;
        }
        .leaderboard-rank.gold { 
            color: #FFD700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }
        .leaderboard-rank.silver { 
            color: #C0C0C0;
            text-shadow: 0 0 15px rgba(192, 192, 192, 0.6);
        }
        .leaderboard-rank.bronze { 
            color: #CD7F32;
            text-shadow: 0 0 15px rgba(205, 127, 50, 0.6);
        }
        .leaderboard-avatar { 
            width: 55px; 
            height: 55px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 2px solid var(--accent-color);
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
        }
        .leaderboard-info { 
            flex-grow: 1;
        }
        .leaderboard-name { 
            font-weight: 600; 
            font-size: 1.05rem; 
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        .leaderboard-balance { 
            font-size: 1.15rem; 
            font-weight: 700; 
            color: var(--accent-color);
        }
        .crown-icon { 
            color: #FFD700; 
            font-size: 1.3rem; 
            margin-left: 8px;
            filter: drop-shadow(0 2px 8px rgba(255, 215, 0, 0.5));
            animation: pulse 2s infinite;
        }

        /* Toast Container */
        .toast-container { 
            position: fixed; 
            top: 90px; 
            right: 20px; 
            z-index: 10000;
            max-width: 400px;
        }
        .custom-toast { 
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            backdrop-filter: blur(20px);
            color: var(--text-primary); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; 
            padding: 16px 20px; 
            margin-bottom: 12px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; 
            align-items: center; 
            gap: 14px; 
            min-width: 320px; 
            max-width: 400px;
        }
        .custom-toast.success { 
            border-left: 4px solid var(--success-color);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(16, 185, 129, 0.2);
        }
        .custom-toast.error { 
            border-left: 4px solid var(--danger-color);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(239, 68, 68, 0.2);
        }
        .custom-toast.warning { 
            border-left: 4px solid var(--warning-color);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(245, 158, 11, 0.2);
        }
        .custom-toast.info { 
            border-left: 4px solid var(--info-color);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(59, 130, 246, 0.2);
        }
        .custom-toast i { 
            font-size: 1.6rem;
        }
        .custom-toast.success i { 
            color: var(--success-color);
        }
        .custom-toast.error i { 
            color: var(--danger-color);
        }
        .custom-toast.warning i { 
            color: var(--warning-color);
        }
        .custom-toast.info i { 
            color: var(--info-color);
        }
        .toast-message { 
            flex: 1; 
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .toast-close { 
            background: none; 
            border: none; 
            color: var(--text-secondary); 
            cursor: pointer; 
            font-size: 1.3rem; 
            padding: 0;
            transition: all 0.3s ease;
        }
        .toast-close:hover {
            color: var(--text-primary);
            transform: rotate(90deg);
        }
        
        @keyframes slideInRight { 
            from { 
                transform: translateX(400px); 
                opacity: 0; 
            } 
            to { 
                transform: translateX(0); 
                opacity: 1; 
            } 
        }
        @keyframes slideOutRight { 
            from { 
                transform: translateX(0); 
                opacity: 1; 
            } 
            to { 
                transform: translateX(400px); 
                opacity: 0; 
            } 
        }

/* ðŸ†• Notification Delete Animations */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Notification item active state */
.notification-item {
    transition: transform 0.2s ease;
}

.notification-item:active {
    transform: scale(0.98);
}

/* Delete button hover effect */
.delete-notif-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.6);
}

@keyframes confettiFall {
            0% {
                top: -10px;
                opacity: 1;
            }
            100% {
                top: 100vh;
                opacity: 0;
                transform: translateX(${Math.random() * 200 - 100}px) rotate(${Math.random() * 720}deg);
            }
        }

/* ðŸ†• PREMIUM BADGE ANIMATIONS */

@keyframes silverShine {
    0%, 100% {
        box-shadow: 0 2px 8px rgba(192, 192, 192, 0.4);
    }
    50% {
        box-shadow: 0 4px 16px rgba(192, 192, 192, 0.8), 0 0 20px rgba(192, 192, 192, 0.4);
    }
}

@keyframes goldGlow {
    0%, 100% {
        box-shadow: 0 2px 8px rgba(255, 215, 0, 0.6);
    }
    50% {
        box-shadow: 0 4px 20px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 215, 0, 0.6);
    }
}

@keyframes platinumGlow {
    0%, 100% {
        box-shadow: 
            0 0 20px rgba(229, 228, 226, 0.8),
            0 0 40px rgba(229, 228, 226, 0.5),
            inset 0 0 20px rgba(255, 255, 255, 0.3);
    }
    50% {
        box-shadow: 
            0 0 30px rgba(229, 228, 226, 1),
            0 0 60px rgba(229, 228, 226, 0.7),
            inset 0 0 30px rgba(255, 255, 255, 0.5);
    }
}

@keyframes platinumShine {
    0% {
        background-position: -200% center;
    }
    100% {
        background-position: 200% center;
    }
}

.premium-badge::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
    );
    transform: rotate(45deg);
}

.premium-badge-platinum::before {
    animation: platinumShine 3s linear infinite;
}

.premium-badge:hover {
    transform: scale(1.05);
    transition: transform 0.3s ease;
}

        /* Update Notification Banner */
        .update-banner { 
            position: fixed; 
            bottom: 85px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: calc(100% - 30px); 
            max-width: 500px; 
            background: linear-gradient(135deg, var(--primary-button-bg), #1E40AF);
            color: white; 
            padding: 18px 22px; 
            border-radius: 16px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            z-index: 9998; 
            display: none; 
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .update-banner-content { 
            display: flex; 
            flex-direction: column; 
            gap: 12px;
        }
        .update-banner-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px;
        }
        .update-banner-title { 
            font-size: 1.05rem; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        .update-banner-title i { 
            font-size: 1.3rem;
        }
        .update-banner-close { 
            background: none; 
            border: none; 
            color: white; 
            cursor: pointer; 
            font-size: 1.4rem; 
            padding: 0; 
            opacity: 0.8; 
            transition: all 0.3s ease;
        }
        .update-banner-close:hover { 
            opacity: 1;
            transform: rotate(90deg);
        }
        .update-banner-description { 
            font-size: 0.9rem; 
            opacity: 0.95; 
            line-height: 1.5; 
            margin-bottom: 5px;
        }
        .update-banner-version { 
            font-size: 0.8rem; 
            opacity: 0.85; 
            margin-bottom: 10px;
        }
        .update-banner-actions { 
            display: flex; 
            gap: 12px;
        }
        .update-banner-btn { 
            flex: 1; 
            padding: 10px 18px; 
            border: none; 
            border-radius: 10px; 
            font-size: 0.9rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .update-banner-download { 
            background: white; 
            color: var(--primary-button-bg);
        }
        .update-banner-download:hover { 
            transform: scale(1.05); 
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.4);
        }
        .update-banner-ignore { 
            background: rgba(255, 255, 255, 0.2); 
            color: white;
        }
        .update-banner-ignore:hover { 
            background: rgba(255, 255, 255, 0.3);
        }
        
        @keyframes slideUp { 
            from { 
                transform: translate(-50%, 120px); 
                opacity: 0; 
            } 
            to { 
                transform: translate(-50%, 0); 
                opacity: 1; 
            } 
        }

        /* Quick Amount Buttons */
        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .quick-amount {
            padding: 14px;
            background: linear-gradient(135deg, rgba(250, 204, 21, 0.15), rgba(250, 204, 21, 0.05));
            border: 2px solid rgba(250, 204, 21, 0.3);
            border-radius: 12px;
            color: var(--accent-color);
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }

        .quick-amount:hover {
            background: linear-gradient(135deg, rgba(250, 204, 21, 0.25), rgba(250, 204, 21, 0.15));
            border-color: var(--accent-color);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(250, 204, 21, 0.3);
        }

        .quick-amount:active {
            transform: translateY(-1px) scale(1);
        }

        /* Info Box for Modals */
        .info-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 14px 18px;
            margin: 18px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .info-box i {
            color: var(--info-color);
            font-size: 1.3rem;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            margin: 0;
        }

        /* Enhanced Modal Styles */
        #addAmountModalEl .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        #addAmountModalEl .form-control {
            font-size: 1rem;
            padding: 14px 18px;
        }

        #addAmountModalEl .form-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        #addAmountModalEl .form-label i {
            color: var(--accent-color);
            font-size: 1.1rem;
        }

        /* QR Code Display */
        .qr-code-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            border: 2px dashed rgba(250, 204, 21, 0.3);
        }

        .qr-code-image {
            max-width: 250px;
            width: 100%;
            height: auto;
            border-radius: 10px;
            border: 3px solid var(--accent-color);
            box-shadow: 0 8px 30px rgba(250, 204, 21, 0.3);
            margin-bottom: 15px;
        }

        .qr-code-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upi-id-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .upi-id-text {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-color);
            letter-spacing: 1px;
        }

        .copy-upi-btn {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
        }

        .copy-upi-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(250, 204, 21, 0.5);
        }

        /* UTR Type Selection */
        .utr-type-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .utr-type-btn {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }

        .utr-type-btn:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(59, 130, 246, 0.15));
            border-color: var(--primary-button-bg);
            transform: translateY(-2px);
        }

        .utr-type-btn.active {
            background: linear-gradient(135deg, var(--primary-button-bg), #2563EB);
            border-color: var(--primary-button-bg);
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .utr-type-btn i {
            display: block;
            font-size: 1.6rem;
            margin-bottom: 6px;
        }

        /* UTR Input specific styling */
        #addUtrInputEl {
            letter-spacing: 2px;
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 700;
        }

        #addAmountInputEl {
            font-size: 1.4rem;
            font-weight: 700;
            text-align: center;
            color: var(--accent-color);
        }

        /* UTR Validation Feedback */
        .form-control.is-valid {
            border-color: var(--success-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2310B981' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
            padding-right: calc(1.5em + 0.75rem);
        }

        .form-control.is-invalid {
            border-color: var(--danger-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23EF4444'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23EF4444' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
            padding-right: calc(1.5em + 0.75rem);
        }

        /* Team Details Input Styles */
        .team-details-section {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.02));
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 12px;
            padding: 18px;
            margin: 18px 0;
        }

        .team-details-section .section-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .team-details-section .section-title i {
            color: var(--info-color);
            font-size: 1.2rem;
        }

        .team-member-input {
            margin-bottom: 15px;
        }

        .team-member-input label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .team-member-input .form-control {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .team-member-input .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(250, 204, 21, 0.15);
        }

        .slot-number-display {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            padding: 18px;
            border-radius: 12px;
            text-align: center;
            margin: 18px 0;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .slot-number-display h4 {
            margin: 0 0 10px 0;
            font-size: 1.15rem;
            font-weight: 600;
        }

        .slot-number-display .slot-value {
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Live Chat Styles */
        .chat-container {
    position: fixed;
    top: 70px;
    left: 0;
    right: 0;
    bottom: 70px;
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.98) 100%);
    backdrop-filter: blur(20px);
    padding: 0;
    margin: 0;
    border: none;
    box-shadow: none;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    z-index: 999;
}

        .chat-header {
    background: linear-gradient(135deg, var(--accent-color), #FBBF24);
    color: var(--primary-bg);
    padding: 12px 15px;
    font-weight: 700;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
    flex-shrink: 0;
    min-height: 50px;
    max-height: 50px;
}

        .chat-header i {
            font-size: 1.3rem;
        }

        .chat-messages {
    flex: 1 1 auto;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 15px;
    padding-bottom: 100px; /* âœ… Increased padding for new bottom position */
    display: flex;
    flex-direction: column;
    gap: 12px;
    height: 100%;
    -webkit-overflow-scrolling: touch;
}

        .chat-message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: fadeInUp 0.3s ease;
        }
/* âœ… FIX: Instant load - no animation delay */
.chat-message {
    opacity: 1;
    transform: translateY(0);
    /* Animation only on new messages added after initial load */
}

.chat-message.new-message {
    animation: messageSlideIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Smooth scroll behavior */
.chat-messages {
    scroll-behavior: smooth;
}

/* Better scrollbar for chat */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: rgba(15, 23, 42, 0.3);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--accent-gradient);
    border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #FBBF24, var(--accent-color));
}

/* Loading state improvement */
.chat-messages .spinner-border {
    color: var(--accent-color);
    width: 2rem;
    height: 2rem;
}

        .chat-message.own-message {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--accent-color);
            flex-shrink: 0;
            object-fit: cover;
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.2);
        }

.online-indicator {
    position: absolute;
    bottom: 2px;
    right: 2px;
    width: 12px;
    height: 12px;
    background: #10B981;
    border: 2px solid var(--primary-bg);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.offline-indicator {
    background: #6B7280;
}

        .chat-bubble {
            background: rgba(30, 41, 59, 0.8);
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 70%;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .chat-message.own-message .chat-bubble {
            background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.1));
            border: 1px solid rgba(250, 204, 21, 0.3);
        }

        .chat-user-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--accent-color);
            margin-bottom: 4px;
        }

        .chat-message.own-message .chat-user-name {
            text-align: right;
        }

        .chat-text {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.5;
            word-wrap: break-word;
        }

        .chat-time {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .chat-input-container {
    position: fixed;
    bottom: 0; /* âœ… Direct bottom par */
    left: 0;
    right: 0;
    padding: 15px 20px 20px 20px; /* âœ… Extra bottom padding for safe area */
    background: rgba(15, 23, 42, 0.98);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    gap: 12px;
    align-items: center;
    height: 80px; /* âœ… Increased height */
    z-index: 1001;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
}

.chat-input {
    flex: 1;
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 12px 16px;
    border-radius: 25px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    min-width: 0;
}

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 0.25rem rgba(250, 204, 21, 0.15);
        }

        .chat-send-btn {
    background: var(--accent-gradient);
    color: var(--primary-bg);
    border: none;
    width: 45px;
    height: 45px;
    min-width: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
    flex-shrink: 0;
}

        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(250, 204, 21, 0.5);
        }

        .chat-send-btn i {
            font-size: 1.2rem;
        }

/* User Profile Modal Styles */
.user-profile-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10002;
    animation: fadeIn 0.3s ease;
}

.user-profile-modal.active {
    display: flex;
}

.user-profile-modal-content {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.98) 100%);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 0;
    min-width: 320px;
    max-width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    border: 2px solid rgba(250, 204, 21, 0.3);
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    animation: slideUp 0.3s ease;
}

.user-profile-modal-header {
    background: linear-gradient(135deg, var(--accent-color), #FBBF24);
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 20px 20px 0 0;
}

.user-profile-modal-close {
    background: rgba(0, 0, 0, 0.3);
    border: none;
    color: var(--primary-bg);
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.3rem;
}

.user-profile-modal-close:hover {
    background: rgba(0, 0, 0, 0.5);
    transform: rotate(90deg);
}

.user-profile-modal-body {
    padding: 25px;
}

.user-profile-avatar-section {
    text-align: center;
    margin-bottom: 25px;
}

.user-profile-avatar-large {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid var(--accent-color);
    object-fit: cover;
    box-shadow: 0 8px 30px rgba(250, 204, 21, 0.4);
    margin-bottom: 15px;
}

.user-profile-name-display {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.user-profile-tier-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.1));
    padding: 8px 16px;
    border-radius: 20px;
    border: 2px solid rgba(250, 204, 21, 0.3);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--accent-color);
}

.user-profile-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin: 25px 0;
}

.user-profile-stat-card {
    background: rgba(30, 41, 59, 0.5);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.user-profile-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-color);
    margin-bottom: 5px;
}

.user-profile-stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.user-profile-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 25px;
}

.user-profile-action-btn {
    width: 100%;
    padding: 14px 20px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.user-profile-action-btn i {
    font-size: 1.2rem;
}

.user-profile-action-btn.friend-request {
    background: linear-gradient(135deg, #3B82F6, #2563EB);
    color: white;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.user-profile-action-btn.friend-request:hover {
    box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
    transform: translateY(-2px);
}

.user-profile-action-btn.chat {
    background: var(--accent-gradient);
    color: var(--primary-bg);
    box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
}

.user-profile-action-btn.chat:hover {
    box-shadow: 0 6px 25px rgba(250, 204, 21, 0.5);
    transform: translateY(-2px);
}

.user-profile-action-btn:disabled {
    background: rgba(30, 41, 59, 0.5);
    color: var(--text-secondary);
    cursor: not-allowed;
    opacity: 0.6;
}

@keyframes slideUp {
    from {
        transform: translateY(50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

        /* My Games Section */
        .my-games-tabs {
            display: flex;
            justify-content: space-around;
            background: rgba(30, 41, 59, 0.5);
            padding: 6px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .my-games-tab {
            color: var(--text-secondary);
            background: none;
            border: none;
            padding: 10px 12px;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 8px;
            flex-grow: 1;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .my-games-tab.active {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
            transform: scale(1.05);
        }

        .my-games-tab:not(.active):hover {
            background: rgba(51, 65, 85, 0.5);
            color: var(--text-primary);
        }

        /* Latest Tournaments */
        .latest-tournaments-container {
            margin-top: 20px;
        }

        .latest-tournament-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .latest-tournament-card:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(139, 92, 246, 0.08) 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        /* Result Claim Styles */
        .result-prizes-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .prize-item {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 14px;
            padding: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .prize-item:hover {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.8) 0%, rgba(51, 65, 85, 0.6) 100%);
            transform: translateX(5px);
        }

        .prize-info {
            flex: 1;
        }

        .prize-rank {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 5px;
        }

        .prize-amount {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--success-color);
        }

        .prize-claim-btn {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            border: none;
            padding: 10px 24px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
        }

        .prize-claim-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(250, 204, 21, 0.5);
        }

        .prize-claim-btn:disabled {
            background: rgba(30, 41, 59, 0.6);
            color: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Settings Page Styles */
        .settings-section {
            margin-bottom: 25px;
        }

        .settings-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .settings-item {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .settings-item:hover {
            background: rgba(30, 41, 59, 0.6);
            transform: translateX(5px);
            border-color: var(--accent-color);
        }

        .settings-item-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .settings-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-color);
            font-size: 1.3rem;
        }

        .settings-item-text h4 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .settings-item-text p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .settings-arrow {
            color: var(--text-secondary);
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }

        .settings-item:hover .settings-arrow {
            transform: translateX(5px);
            color: var(--accent-color);
        }

        /* Change Password Modal */
        .password-form-group {
            margin-bottom: 18px;
        }

        .password-form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .password-input-wrapper {
            position: relative;
        }

        .password-input-wrapper input {
            padding-right: 45px;
        }

        .password-toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .password-toggle-btn:hover {
            color: var(--accent-color);
        }

        /* Three Column Grid for Games */
        .games-grid-three {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .games-grid-three .game-card {
            padding: 0;
        }

        .games-grid-three .game-card img {
            height: 110px;
        }

        .games-grid-three .game-card span {
            font-size: 0.85rem;
            padding: 10px 5px;
        }

        /* Match History Styles */
        .match-history-item {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .match-history-item:hover {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.8) 0%, rgba(51, 65, 85, 0.6) 100%);
            transform: translateX(5px);
        }

        .match-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .match-tournament-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .match-result-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .match-result-badge.win {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .match-result-badge.loss {
            background: linear-gradient(135deg, var(--danger-color), #DC2626);
            color: white;
        }

        .match-history-details {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .match-detail-item {
            text-align: center;
            flex: 1;
        }

        .match-detail-item span {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .match-detail-item strong {
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .games-grid-three {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .games-grid-three .game-card img {
                height: 100px;
            }
            
            .games-grid-three .game-card span {
                font-size: 0.8rem;
                padding: 8px 4px;
            }
        }

        @media (max-width: 480px) {
            .chat-container {
                height: 500px;
            }
            
            .chat-bubble {
                max-width: 80%;
            }
            
            .wallet-actions {
                grid-template-columns: 1fr;
            }
            
            .quick-amounts {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

.vip-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: var(--primary-bg);
    padding: 3px 10px;
    border-radius: 14px;
    font-size: 0.7rem;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
    position: relative;
    overflow: hidden;
}

/* âœ… Premium Diamond Badge (Platinum) */
.vip-badge.platinum {
    background: linear-gradient(135deg, #E5E4E2 0%, #B9B8B6 50%, #E5E4E2 100%);
    border: 2px solid #FFFFFF;
    box-shadow: 
        0 0 20px rgba(229, 228, 226, 0.8),
        0 0 40px rgba(229, 228, 226, 0.5),
        inset 0 0 20px rgba(255, 255, 255, 0.3);
    animation: platinumGlow 2s ease-in-out infinite;
    position: relative;
}

.vip-badge.platinum::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent,
        rgba(255, 255, 255, 0.4),
        transparent
    );
    animation: platinumShine 3s linear infinite;
}

.vip-badge.platinum::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(
        circle at 30% 30%,
        rgba(255, 255, 255, 0.5) 0%,
        transparent 50%
    );
    animation: platinumSparkle 2s ease-in-out infinite alternate;
}

@keyframes platinumGlow {
    0%, 100% {
        box-shadow: 
            0 0 20px rgba(229, 228, 226, 0.8),
            0 0 40px rgba(229, 228, 226, 0.5),
            inset 0 0 20px rgba(255, 255, 255, 0.3);
    }
    50% {
        box-shadow: 
            0 0 30px rgba(229, 228, 226, 1),
            0 0 60px rgba(229, 228, 226, 0.7),
            inset 0 0 30px rgba(255, 255, 255, 0.5);
    }
}

@keyframes platinumShine {
    0% {
        transform: translate(-50%, -50%) rotate(0deg);
    }
    100% {
        transform: translate(-50%, -50%) rotate(360deg);
    }
}

@keyframes platinumSparkle {
    0% {
        opacity: 0.3;
    }
    100% {
        opacity: 0.7;
    }
}

/* âœ… Gold Badge */
.vip-badge.gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    border: 2px solid #FFE55C;
    box-shadow: 
        0 0 15px rgba(255, 215, 0, 0.6),
        0 0 30px rgba(255, 215, 0, 0.4);
    animation: goldGlow 2s ease-in-out infinite;
}

@keyframes goldGlow {
    0%, 100% {
        box-shadow: 
            0 0 15px rgba(255, 215, 0, 0.6),
            0 0 30px rgba(255, 215, 0, 0.4);
    }
    50% {
        box-shadow: 
            0 0 25px rgba(255, 215, 0, 0.8),
            0 0 50px rgba(255, 215, 0, 0.6);
    }
}

/* âœ… Silver Badge */
.vip-badge.silver {
    background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
    border: 1px solid #DCDCDC;
    box-shadow: 0 2px 10px rgba(192, 192, 192, 0.4);
}

/* âœ… Bronze Badge */
.vip-badge.bronze {
    background: linear-gradient(135deg, #CD7F32, #8B4513);
    border: 1px solid #D4A574;
    box-shadow: 0 2px 10px rgba(205, 127, 50, 0.4);
}

.vip-tier-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    border: 2px solid;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.vip-tier-card::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: inherit;
    border-radius: 16px;
    z-index: -1;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.vip-tier-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
}

.vip-tier-card:hover::before {
    opacity: 0.3;
}

.vip-tier-card.bronze {
    border-color: #CD7F32;
}

.vip-tier-card.bronze::before {
    background: linear-gradient(135deg, #CD7F32, #8B4513);
}

.vip-tier-card.silver {
    border-color: #C0C0C0;
}

.vip-tier-card.silver::before {
    background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
}

.vip-tier-card.gold {
    border-color: #FFD700;
}

.vip-tier-card.gold::before {
    background: linear-gradient(135deg, #FFD700, #FFA500);
}

.vip-tier-card.platinum {
    border-color: #E5E4E2;
}

.vip-tier-card.platinum::before {
    background: linear-gradient(135deg, #E5E4E2, #B9B8B6);
}

.vip-tier-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.vip-tier-name {
    font-size: 1.3rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.vip-tier-icon {
    font-size: 1.5rem;
}

.vip-progress-bar {
    background: rgba(15, 23, 42, 0.6);
    height: 12px;
    border-radius: 6px;
    overflow: hidden;
    margin: 15px 0;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}

.vip-progress-fill {
    height: 100%;
    background: var(--accent-gradient);
    transition: width 0.6s ease;
    box-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
}

.vip-benefits-list {
    list-style: none;
    padding: 0;
    margin: 15px 0 0 0;
}

.vip-benefits-list li {
    padding: 8px 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.vip-benefits-list li i {
    color: var(--accent-color);
    font-size: 1.1rem;
}

/* Achievement Styles */
.achievement-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(30, 41, 59, 0.6));
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 15px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.achievement-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(250, 204, 21, 0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.achievement-card:hover::before {
    opacity: 1;
}

.achievement-card.completed {
    border-color: var(--accent-color);
    box-shadow: 0 4px 15px rgba(250, 204, 21, 0.2);
}

.achievement-card.locked {
    opacity: 0.6;
}

.achievement-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    flex-shrink: 0;
    position: relative;
    z-index: 1;
    overflow: hidden;
}

.achievement-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.achievement-icon.completed {
    background: var(--accent-gradient);
    color: var(--primary-bg);
    box-shadow: 0 4px 15px rgba(250, 204, 21, 0.4);
    animation: pulse 2s infinite;
}

.achievement-icon.locked {
    background: rgba(51, 65, 85, 0.5);
    color: var(--text-secondary);
}

.achievement-icon.locked::after {
    content: 'ðŸ”’';
    position: absolute;
    font-size: 1.5rem;
}

.achievement-content {
    flex: 1;
    position: relative;
    z-index: 1;
}

.achievement-title {
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--text-primary);
    margin-bottom: 5px;
}

.achievement-description {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.achievement-progress {
    display: flex;
    align-items: center;
    gap: 10px;
}

.achievement-progress-bar {
    flex: 1;
    height: 6px;
    background: rgba(51, 65, 85, 0.5);
    border-radius: 3px;
    overflow: hidden;
}

.achievement-progress-fill {
    height: 100%;
    background: var(--accent-gradient);
    transition: width 0.6s ease;
    box-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
}

.achievement-progress-text {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--accent-color);
    min-width: 45px;
    text-align: right;
}

.achievement-reward {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--accent-gradient);
    color: var(--primary-bg);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(250, 204, 21, 0.3);
    z-index: 1;
}

.achievement-card.completed .achievement-reward {
    background: linear-gradient(135deg, var(--success-color), #059669);
}

.achievement-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.achievement-actions .btn {
    font-size: 0.8rem;
    padding: 6px 14px;
}

/* Badge Card Styles */
.badge-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(30, 41, 59, 0.6));
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    text-align: center;
    border: 2px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
    cursor: pointer;
}

.badge-card:hover {
    transform: translateY(-5px);
    border-color: var(--accent-color);
    box-shadow: 0 8px 25px rgba(250, 204, 21, 0.3);
}

.badge-card.active {
    border-color: var(--accent-color);
    background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.1));
    box-shadow: 0 4px 15px rgba(250, 204, 21, 0.4);
}

.badge-card.active::before {
    content: 'âœ“';
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--accent-gradient);
    color: var(--primary-bg);
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
}

.badge-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 10px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid var(--accent-color);
    box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
}

.badge-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.badge-name {
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--text-primary);
    margin-bottom: 5px;
}

.badge-description {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* Congratulations Modal */
.congrats-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10003;
    animation: fadeIn 0.3s ease;
}

.congrats-modal.active {
    display: flex;
}

.congrats-content {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.98) 100%);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    max-width: 400px;
    border: 2px solid var(--accent-color);
    box-shadow: 0 10px 50px rgba(250, 204, 21, 0.5);
    animation: scaleIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes scaleIn {
    0% {
        transform: scale(0.5);
        opacity: 0;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

.congrats-badge {
    width: 120px;
    height: 120px;
    margin: 0 auto 20px;
    border-radius: 50%;
    border: 4px solid var(--accent-color);
    overflow: hidden;
    box-shadow: 0 8px 30px rgba(250, 204, 21, 0.5);
    animation: rotate 2s linear infinite;
}

@keyframes rotate {
    0% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
    100% { transform: rotate(360deg) scale(1); }
}

.congrats-badge img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.congrats-title {
    font-size: 1.8rem;
    font-weight: 700;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 15px;
}

.congrats-message {
    color: var(--text-secondary);
    font-size: 1rem;
    margin-bottom: 20px;
}

.congrats-reward {
    background: var(--accent-gradient);
    color: var(--primary-bg);
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 1.2rem;
    font-weight: 700;
    display: inline-block;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(250, 204, 21, 0.4);
}

.congrats-close {
    background: linear-gradient(135deg, #3B82F6, #2563EB);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
}

.congrats-close:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
}

.current-tier-badge {
    background: var(--accent-gradient);
    color: var(--primary-bg);
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(250, 204, 21, 0.4);
}

        ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent-color), #FBBF24);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #FBBF24, var(--accent-color));
        }

        /* Loading States */
        .skeleton-loader {
            background: linear-gradient(90deg, rgba(51, 65, 85, 0.3) 25%, rgba(51, 65, 85, 0.5) 50%, rgba(51, 65, 85, 0.3) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Premium Button Styles */
        .btn-premium {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.95rem;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-premium:hover {
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }

        /* Confetti Animation */
@keyframes confettiFall {
    0% {
        top: -10px;
        opacity: 1;
    }
    100% {
        top: 100vh;
        opacity: 0;
        transform: translateX(var(--tx)) rotate(var(--rot));
    }
}

/* Badge Styles */
.badge-new {
            background: linear-gradient(135deg, var(--danger-color), #DC2626);
            color: white;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 700;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        .badge-hot {
            background: linear-gradient(135deg, var(--warning-color), #F59E0B);
            color: white;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 700;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 4rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Success Animation */
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .success-animation {
            animation: successPulse 0.6s ease;
        }

        /* Gradient Text */
        .gradient-text {
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        /* Card Hover Glow Effect */
        .card-glow {
            position: relative;
        }

        .card-glow::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--accent-gradient);
            border-radius: 16px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card-glow:hover::after {
            opacity: 0.3;
        }

        /* Floating Animation */
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        /* Shimmer Effect */
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(250, 204, 21, 0.3), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* Ripple Effect */
        .ripple {
            position: relative;
            overflow: hidden;
        }

        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .ripple:active::after {
            width: 300px;
            height: 300px;
        }

    </style>
</head>

<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainerEl"></div>

    <!-- Update Banner -->
    <div class="update-banner" id="updateBannerEl">
        <div class="update-banner-content">
            <div class="update-banner-header">
                <div class="update-banner-title">
                    <i class="bi bi-arrow-up-circle-fill"></i>
                    <span id="updateBannerTitleEl">New Update Available</span>
                </div>
                <button class="update-banner-close" id="updateBannerCloseEl">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="update-banner-description" id="updateBannerDescriptionEl">
                A new version is available with exciting features and improvements!
            </div>
            <div class="update-banner-version" id="updateBannerVersionEl">
                Version: 1.0.0
            </div>
            <div class="update-banner-actions">
                <button class="update-banner-btn update-banner-download" id="updateBannerDownloadEl">
                    <i class="bi bi-download me-1"></i> Download
                </button>
                <button class="update-banner-btn update-banner-ignore" id="updateBannerIgnoreEl">
                    Ignore
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
<header class="app-header">    
        <button class="header-menu-button" id="headerMenuBtnEl" style="display: none;">
            <i class="bi bi-list"></i>
        </button>
        <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
        <img src="https://via.placeholder.com/45/FACC15/0F172A?text=V" alt="Logo" class="header-logo" id="appLogoEl">
        
            <div class="header-title" id="headerTitleContainerEl">
    <span class="app-name-dynamic"> </span> <span id="headerUserGreetingEl">Guest</span>
</div>
            <div class="header-game-title" id="headerGameTitleEl">Game Title</div>
        </div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl" aria-label="Notifications">
                <i class="bi bi-bell-fill"></i>
                <span class="notification-badge" id="notificationBadgeEl" style="display: none;"></span>
            </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;" aria-label="Wallet Balance">
                <i class="bi bi-wallet-fill"></i> â‚¹<span id="headerChipBalanceEl">0</span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="globalLoaderEl">
            <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <!-- Login Section -->
        <section id="login-section" class="section active" style="padding-top: 2rem;">
            <div class="container" style="max-width: 450px;">
                <div class="card shadow-sm custom-card">
                    <div class="card-body px-3 py-4">
                        <!-- Login Form -->
                        <form id="emailLoginForm">
                            <h2 class="card-title text-center mb-4">Welcome Back!</h2>
                            <div class="mb-2">
    <label for="loginEmailInputEl" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="loginEmailInputEl" placeholder="Enter your email" required>
                            </div>
                            <div class="mb-2">
                                <label for="loginPasswordInputEl" class="form-label">Password</label>
                                <div class="password-input-wrapper">
                                    <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="Enter your password" required>
                                    <button type="button" class="password-toggle-btn" onclick="togglePassword('loginPasswordInputEl', this)">
                                        <i class="bi bi-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-2">
                                <button type="button" class="btn btn-custom btn-custom-primary ripple" id="loginEmailBtnEl">
                                    <i class="bi bi-box-arrow-in-right"></i> Login
                                </button>
                                <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showSignupToggleBtnEl">
                                    Don't have an account? <span class="gradient-text">Sign Up</span>
                                </button>
                                <a href="#" id="forgotPasswordLinkEl" class="text-center small mt-2 d-block" style="color: var(--text-secondary);">
                                    <i class="bi bi-key"></i> Forgot Password?
                                </a>
                            </div>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" style="display: none;">
                            <h2 class="card-title text-center mb-4">Create Account</h2>
                            <div class="mb-3">
                                <label for="signupEmailInputEl" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="signupEmailInputEl" placeholder="Enter your email" required>
                            </div>
                            <div class="mb-3">
                                <label for="signupPasswordInputEl" class="form-label">Password (min 6 chars)</label>
                                <div class="password-input-wrapper">
                                    <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Create password" required minlength="6">
                                    <button type="button" class="password-toggle-btn" onclick="togglePassword('signupPasswordInputEl', this)">
                                        <i class="bi bi-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="signupConfirmPasswordInputEl" class="form-label">Confirm Password</label>
                                <div class="password-input-wrapper">
                                    <input type="password" class="form-control" id="signupConfirmPasswordInputEl" placeholder="Confirm password" required>
                                    <button type="button" class="password-toggle-btn" onclick="togglePassword('signupConfirmPasswordInputEl', this)">
                                        <i class="bi bi-eye-slash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="signupGameNameInputEl" class="form-label">Game Nickname</label>
                                <input type="text" class="form-control" id="signupGameNameInputEl" placeholder="Your in-game name" required>
                            </div>
                            <div class="mb-3">
                                <label for="signupReferralCodeInputEl" class="form-label">Referral Code (Optional)</label>
                                <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Enter referral code">
                            </div>
                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3">
                                <button type="button" class="btn btn-custom btn-custom-accent ripple" id="signupEmailBtnEl">
                                    <i class="bi bi-person-plus-fill"></i> Create Account
                                </button>
                                <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block" id="showLoginToggleBtnEl">
                                    Already have account? <span class="gradient-text">Login</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <!-- Promotion Slider -->
            <div class="swiper-container" id="promotionSliderEl">
                <div class="swiper-wrapper placeholder-glow">
                    <div class="swiper-slide">
                        <span class="placeholder skeleton-loader" style="display: block; width: 100%; height: 100%; border-radius: 16px;"></span>
                    </div>
                </div>
                <div class="swiper-pagination"></div>
            </div>

            <!-- My Games Section -->
            <div class="mb-4">
                <h2 class="section-title">My Games</h2>
                <div class="my-games-tabs">
                    <button class="my-games-tab active" data-my-games-status="ongoing">
                        <i class="bi bi-play-circle-fill"></i> Ongoing
                    </button>
                    <button class="my-games-tab" data-my-games-status="upcoming">
                        <i class="bi bi-clock-fill"></i> Upcoming
                    </button>
                    <button class="my-games-tab" data-my-games-status="completed">
                        <i class="bi bi-check-circle-fill"></i> Completed
                    </button>
                </div>
                <div id="myGamesListEl" class="placeholder-glow">
                    <div class="tournament-card placeholder-glow mb-3">
                        <span class="placeholder col-6" style="height: 18px;"></span>
                        <span class="placeholder col-12 mt-2" style="height: 24px;"></span>
                        <span class="placeholder col-10 mt-2" style="height: 16px;"></span>
                        <div class="d-flex justify-content-between mt-3">
                            <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span>
                            <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span>
                        </div>
                    </div>
                </div>
                <p id="noMyGamesMessageEl" class="text-secondary text-center mt-3" style="display: none;">No games found</p>
            </div>

            <!-- Esport Games -->
            <h2 class="section-title">Esport Games</h2>
            <div class="games-grid-three mb-4 placeholder-glow" id="gamesListEl">
                <div class="game-card custom-card">
                    <span class="placeholder skeleton-loader d-block" style="height: 110px; border-top-left-radius: 16px; border-top-right-radius: 16px;"></span>
                    <span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span>
                </div>
                <div class="game-card custom-card">
                    <span class="placeholder skeleton-loader d-block" style="height: 110px; border-top-left-radius: 16px; border-top-right-radius: 16px;"></span>
                    <span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span>
                </div>
                <div class="game-card custom-card">
                    <span class="placeholder skeleton-loader d-block" style="height: 110px; border-top-left-radius: 16px; border-top-right-radius: 16px;"></span>
                    <span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span>
                </div>
            </div>

            <!-- My Contests -->
            <h2 class="section-title">My Contests</h2>
            <div id="myContestsListEl" class="placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3">
                    <span class="placeholder col-6" style="height: 18px;"></span>
                    <span class="placeholder col-12 mt-2" style="height: 24px;"></span>
                    <span class="placeholder col-10 mt-2" style="height: 16px;"></span>
                    <div class="d-flex justify-content-between mt-3">
                        <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span>
                        <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span>
                    </div>
                </div>
                <p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't joined any contests yet.</p>
            </div>

            <!-- Latest Tournaments -->
            <div class="latest-tournaments-container">
                <h2 class="section-title">Latest Tournaments <span class="badge-new">NEW</span></h2>
                <div id="latestTournamentsListEl" class="placeholder-glow">
                    <div class="latest-tournament-card placeholder-glow mb-3">
                        <span class="placeholder col-8" style="height: 20px;"></span>
                        <span class="placeholder col-12 mt-2" style="height: 16px;"></span>
                    </div>
                </div>
                <p id="noLatestTournamentsMessageEl" class="text-secondary text-center mt-3" style="display: none;">No latest tournaments</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs">
                <button class="tab-item active" data-status="upcoming">
                    <i class="bi bi-calendar-event-fill"></i> Upcoming
                </button>
                <button class="tab-item" data-status="ongoing">
                    <i class="bi bi-play-circle-fill"></i> Ongoing
                </button>
                <button class="tab-item" data-status="completed">
                    <i class="bi bi-trophy-fill"></i> Results
                </button>
            </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3">
                    <span class="placeholder col-6" style="height: 18px;"></span>
                    <span class="placeholder col-12 mt-2" style="height: 24px;"></span>
                    <span class="placeholder col-10 mt-2" style="height: 16px;"></span>
                    <div class="d-flex justify-content-between mt-3">
                        <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span>
                        <span class="placeholder col-4" style="height: 30px; border-radius: 6px;"></span>
                    </div>
                </div>
            </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments found.</p>
        </section>

        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">
                    <i class="bi bi-wallet-fill"></i> My Wallet
                </h2>
                
                <div class="balance-section">
                    <div class="total-balance">
                        <div class="total-balance-label">Total Balance</div>
                        <div class="total-balance-amount" id="walletTotalBalanceEl">
                            <span class="placeholder col-3"></span>
                        </div>
                        <button class="btn-custom-link" id="allTransactionsBtnEl">
                            <i class="bi bi-clock-history"></i> View History
                        </button>
                    </div>
                    
                    <div class="balance-item placeholder-glow">
    <div>
        <span class="balance-item-label">
            <i class="bi bi-trophy-fill"></i> Winning Cash
        </span>
    </div>
    <span class="balance-item-value" id="walletWinningCashEl">
        <span class="placeholder col-3"></span>
    </span>
</div>
                    
                    <div class="balance-item placeholder-glow">
                        <div>
                            <span class="balance-item-label">
                                <i class="bi bi-wallet2"></i> Cash Balance
                            </span>
                        </div>
                        <span class="balance-item-value" id="walletCashBalanceEl">
                            <span class="placeholder col-3"></span>
                        </span>
                    </div>
                    
                    <div class="balance-item placeholder-glow">
                        <div>
                            <span class="balance-item-label">
                                <i class="bi bi-gift-fill"></i> Bonus Cash
                            </span>
                        </div>
                        <span class="balance-item-value" id="walletBonusCashEl">
                            <span class="placeholder col-3"></span>
                        </span>
                    </div>
                </div>

                <div class="wallet-actions">
                    <button class="btn btn-custom btn-custom-accent ripple" id="addAmountWalletBtnEl">
                        <i class="bi bi-plus-circle-fill"></i> Add Amount
                    </button>
                    <button class="btn btn-custom btn-custom-primary ripple" id="withdrawBtnEl2">
                        <i class="bi bi-arrow-up-circle-fill"></i> Withdraw
                    </button>
                </div>
            </div>

            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow">
                <div class="custom-card p-2 mb-2 placeholder-glow">
                    <div class="d-flex justify-content-between">
                        <span class="placeholder col-5" style="height: 16px;"></span>
                        <span class="placeholder col-3" style="height: 16px;"></span>
                    </div>
                    <div class="small text-secondary mt-1">
                        <span class="placeholder col-6" style="height: 14px;"></span>
                    </div>
                </div>
                <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p>
            </div>
        </section>

        <!-- Live Chat Section -->
        <section id="chat-section" class="section">
            <div class="chat-container custom-card">
                <div class="chat-header">
                    <i class="bi bi-chat-dots-fill"></i>
                    <span>Live Chat</span>
                </div>
                <div class="chat-messages" id="chatMessagesEl">
                    <!-- Chat messages will be dynamically loaded here -->
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-chat-text"></i>
                        </div>
                        <div class="empty-state-title">Start Chatting!</div>
                        <div class="empty-state-text">Send a message to start conversation with other players</div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInputEl" placeholder="Type your message..." maxlength="500">
                    <button class="chat-send-btn ripple" id="chatSendBtnEl">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section id="leaderboard-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-trophy-fill"></i> Top Players
            </h2>
            <div id="leaderboardListEl" class="placeholder-glow">
                <div class="leaderboard-item placeholder-glow mb-2">
                    <div class="leaderboard-rank">
                        <span class="placeholder" style="width: 30px; height: 30px; display: inline-block;"></span>
                    </div>
                    <div class="leaderboard-avatar">
                        <span class="placeholder" style="width: 55px; height: 55px; border-radius: 50%; display: inline-block;"></span>
                    </div>
                    <div class="leaderboard-info">
                        <div class="leaderboard-name">
                            <span class="placeholder col-6"></span>
                        </div>
                        <div class="leaderboard-balance">
                            <span class="placeholder col-4"></span>
                        </div>
                    </div>
                </div>
            </div>
            <p id="noLeaderboardMessageEl" class="text-secondary text-center mt-4" style="display: none;">No players to display.</p>
        </section>

        <!-- Earnings Section -->
        <section id="earnings-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-coin"></i> Earnings
            </h2>
            <div class="custom-card text-center mb-4">
                <i class="bi bi-coin display-4 text-accent mb-3 floating"></i>
                <p class="text-secondary mb-4">Track your earnings from tournaments, referrals, and coupons here.</p>
                <div class="placeholder-glow">
                    <p>Total Earned: <strong class="gradient-text" id="earningsTotalEl">
                        <span class="placeholder col-3"></span>
                    </strong></p>
                    <p>From Referrals: <strong id="earningsReferralEl">
                        <span class="placeholder col-3"></span>
                    </strong></p>
                    <p>From Coupons: <strong id="earningsCouponEl">
                        <span class="placeholder col-3"></span>
                    </strong></p>
                </div>
                <button class="btn btn-custom btn-custom-link mt-3 ripple" id="viewEarningsHistoryBtn">
                    <i class="bi bi-clock-history"></i> View History
                </button>
            </div>
            <div id="earningsHistoryContainerEl" style="display: none;">
                <h3 class="section-title">Earnings History</h3>
                <div id="earningsHistoryListEl"></div>
                <p id="noEarningsMessageEl" class="text-secondary text-center mt-3" style="display: none;">No earnings yet.</p>
            </div>
        </section>

        <!-- Notifications Section -->
        <section id="notifications-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-bell-fill"></i> Notifications
            </h2>
            <div id="notificationsListEl" class="placeholder-glow">
                <div class="notification-item placeholder-glow mb-2">
                    <div class="notification-avatar">
                        <span class="placeholder" style="width: 50px; height: 50px; border-radius: 50%; display: inline-block;"></span>
                    </div>
                    <div class="notification-content">
                        <div class="notification-header">
                            <span class="placeholder col-6" style="height: 18px;"></span>
                            <span class="placeholder col-3" style="height: 14px;"></span>
                        </div>
                        <div class="notification-message">
                            <span class="placeholder col-12" style="height: 16px;"></span>
                            <span class="placeholder col-8 mt-1" style="height: 16px;"></span>
                        </div>
                    </div>
                </div>
            </div>
            <p id="noNotificationsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No notifications yet.</p>
        </section>

        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow">
    <img src="https://via.placeholder.com/80" alt="Avatar" class="profile-avatar" id="profileAvatarEl" style="cursor: pointer;">
    <h3 class="profile-name mt-2" id="profileNameEl">
        <span class="placeholder col-6"></span>
    </h3>
                <p class="profile-email" id="profileEmailEl">
                    <span class="placeholder col-8"></span>
                </p>
                <div class="profile-stats w-100">
                    <div class="stat-item">
                        <strong id="profileTotalMatchesEl">
                            <span class="placeholder col-4"></span>
                        </strong>
                        <span>Matches Played</span>
                    </div>
                    <div class="stat-item">
                        <strong id="profileWonMatchesEl">
                            <span class="placeholder col-4"></span>
                        </strong>
                        <span>Matches Won</span>
                    </div>
                    <div class="stat-item">
                        <strong id="profileTotalEarningsEl">
                            <span class="placeholder col-4"></span>
                        </strong>
                        <span>Total Winnings</span>
                    </div>
                </div>
            </div>

<div class="profile-links">
    <!-- ðŸ”¥ NEW SECTION - NOW AT TOP -->
    <h5 class="section-title mb-3" style="font-size: 0.9rem; color: var(--warning-color); text-transform: uppercase; letter-spacing: 1px;">
        <i class="bi bi-fire"></i> New ðŸ”¥
    </h5>
    <div class="list-group custom-card mb-3">
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="view-achievements">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1)); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-trophy-fill" style="font-size: 1.3rem; color: #8B5CF6;"></i>
                </div>
                <div>
                    <h5 style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">Achievements</h5>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">Complete challenges & earn rewards</p>
                </div>
            </div>
            <i class="bi bi-chevron-right"></i>
        </a>
        
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="view-my-badges">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.1)); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-award-fill" style="font-size: 1.3rem; color: var(--accent-color);"></i>
                </div>
                <div>
                    <h5 style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">My Badges</h5>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">View & equip your earned badges</p>
                </div>
            </div>
            <i class="bi bi-chevron-right"></i>
        </a>
        
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="view-vip-program">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.1)); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-trophy-fill" style="font-size: 1.3rem; color: var(--accent-color);"></i>
                </div>
                <div>
                    <h5 style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">VIP Loyalty Program</h5>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">Unlock exclusive rewards</p>
                </div>
            </div>
            <i class="bi bi-chevron-right"></i>
        </a>
        
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="view-socials">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-people-fill" style="font-size: 1.3rem; color: var(--info-color);"></i>
                </div>
                <div>
                    <h5 style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">Socials</h5>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">Friends & Chat</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="badge bg-danger" id="socialNotificationBadge" style="display: none;">0</span>
                <i class="bi bi-chevron-right"></i>
            </div>
        </a>
    </div>

    <!-- ðŸ§â€â™‚ï¸ Account Section -->
    <h5 class="section-title mt-4 mb-3" style="font-size: 0.9rem; color: var(--text-accent); text-transform: uppercase; letter-spacing: 1px;">
        <i class="bi bi-person-circle"></i> Account Section
    </h5>
<div class="list-group custom-card mb-3">
    <!-- âœ… REMOVED: Update Profile Avatar -->
    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="edit-nickname">
        <span><i class="bi bi-pencil-square"></i> Edit Nickname</span>
        <i class="bi bi-chevron-right"></i>
    </a>
    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="change-password">
        <span><i class="bi bi-key-fill"></i> Change Password</span>
        <i class="bi bi-chevron-right"></i>
    </a>
</div>

    <!-- ðŸ’° Earnings & Transactions -->
    <h5 class="section-title mt-4 mb-3" style="font-size: 0.9rem; color: var(--text-accent); text-transform: uppercase; letter-spacing: 1px;">
        <i class="bi bi-wallet2"></i> Earnings & Transactions
    </h5>
    <div class="list-group custom-card mb-3">
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refer">
            <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span>
            <i class="bi bi-chevron-right"></i>
        </a>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="redeem-coupon">
            <span><i class="bi bi-gift-fill"></i> Redeem Coupon</span>
            <i class="bi bi-chevron-right"></i>
        </a>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="match-history">
            <span><i class="bi bi-clock-history"></i> Match History</span>
            <i class="bi bi-chevron-right"></i>
        </a>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="withdraw-history">
            <span><i class="bi bi-arrow-up-circle"></i> Withdraw History</span>
            <i class="bi bi-chevron-right"></i>
        </a>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="transaction-history">
            <span><i class="bi bi-receipt"></i> Transaction History</span>
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>

    <!-- ðŸ›¡ï¸ Support & Policies -->
    <h5 class="section-title mt-4 mb-3" style="font-size: 0.9rem; color: var(--text-accent); text-transform: uppercase; letter-spacing: 1px;">
        <i class="bi bi-shield-check"></i> Support & Policies
    </h5>
    <div class="list-group custom-card mb-3">
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="fairPlay">
            <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span>
            <i class="bi bi-chevron-right"></i>
        </a>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="privacy">
            <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span>
            <i class="bi bi-chevron-right"></i>
        </a>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="terms">
            <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span>
            <i class="bi bi-chevron-right"></i>
        </a>
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-policy="refund">
            <span><i class="bi bi-arrow-repeat"></i> Refund and Cancellation</span>
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>

    <!-- ðŸ“ž Support & Feedback -->
    <h5 class="section-title mt-4 mb-3" style="font-size: 0.9rem; color: var(--text-accent); text-transform: uppercase; letter-spacing: 1px;">
        <i class="bi bi-headset"></i> Support & Feedback
    </h5>
    <div class="list-group custom-card mb-3">
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" data-action="send-feedback">
            <span><i class="bi bi-chat-dots-fill"></i> Send Feedback</span>
            <i class="bi bi-chevron-right"></i>
        </a>
        <a href="mailto:sovitprasad98@gmail.com" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" id="contactUsLinkEl">
            <span><i class="bi bi-envelope-fill"></i> Contact Us</span>
            <i class="bi bi-chevron-right"></i>
        </a>
        <a href="http://instavault.page.gd/" target="_blank" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
            <span><i class="bi bi-person-badge-fill"></i> Apply for Staff</span>
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>

    <!-- ðŸšª Logout Section -->
    <h5 class="section-title mt-4 mb-3" style="font-size: 0.9rem; color: var(--danger-color); text-transform: uppercase; letter-spacing: 1px;">
        <i class="bi bi-box-arrow-right"></i> Logout Section
    </h5>
    <div class="list-group custom-card mb-3">
        <button class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item" id="logoutProfileBtnEl">
            <span><i class="bi bi-box-arrow-right"></i> Logout</span>
            <span></span>
        </button>
    </div>
</div>
        </section>

<!-- Socials Section - NEW -->
<section id="socials-section" class="section">
    <h2 class="section-title">
        <i class="bi bi-people-fill"></i> Socials
    </h2>

    <!-- Social Stats Cards -->
    <div class="row mb-4">
        <div class="col-6">
            <div class="custom-card text-center" style="padding: 15px;">
                <i class="bi bi-people-fill" style="font-size: 2rem; color: var(--accent-color);"></i>
                <h4 id="totalFriendsCount" style="margin: 10px 0 5px 0; font-weight: 700; color: var(--text-primary);">0</h4>
                <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">Friends</p>
            </div>
        </div>
        <div class="col-6">
            <div class="custom-card text-center" style="padding: 15px;">
                <i class="bi bi-person-plus-fill" style="font-size: 2rem; color: var(--warning-color);"></i>
                <h4 id="pendingRequestsCount" style="margin: 10px 0 5px 0; font-weight: 700; color: var(--text-primary);">0</h4>
                <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">Requests</p>
            </div>
        </div>
    </div>

    <!-- Social Action Cards -->
    <div class="list-group custom-card">
        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" onclick="showSection('friend-requests-section'); loadFriendRequestsPage(); return false;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1)); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-person-plus-fill" style="font-size: 1.3rem; color: var(--warning-color);"></i>
                </div>
                <div>
                    <h5 style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">Friend Requests</h5>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">Pending invitations</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="badge bg-warning" id="requestsBadge1" style="display: none;">0</span>
                <i class="bi bi-chevron-right"></i>
            </div>
        </a>

        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" onclick="showSection('my-friends-list-section'); loadMyFriendsPage(); return false;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1)); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-people-fill" style="font-size: 1.3rem; color: var(--success-color);"></i>
                </div>
                <div>
                    <h5 style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">My Friends</h5>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">View all friends</p>
                </div>
            </div>
            <i class="bi bi-chevron-right"></i>
        </a>

        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" onclick="showSection('private-chats-section'); return false;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1)); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-chat-dots-fill" style="font-size: 1.3rem; color: var(--info-color);"></i>
                </div>
                <div>
                    <h5 style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">Chats</h5>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">Private messages</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="badge bg-success" id="chatsBadge1" style="display: none;">0</span>
                <i class="bi bi-chevron-right"></i>
            </div>
        </a>

        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item" onclick="showSection('find-friends-section'); setupFindFriendsPage(); return false;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.1)); display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-search" style="font-size: 1.3rem; color: var(--accent-color);"></i>
                </div>
                <div>
                    <h5 style="margin: 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">Find Friends</h5>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">Search & add new friends</p>
                </div>
            </div>
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>
</section>

<!-- Friend Requests Page - SEPARATE -->
<section id="friend-requests-section" class="section">
    <h2 class="section-title">
        <i class="bi bi-person-plus-fill"></i> Friend Requests
    </h2>
    <div id="friendRequestsPageListEl" class="placeholder-glow">
        <p class="text-center">Loading...</p>
    </div>
</section>

<!-- My Friends List Page - SEPARATE -->
<section id="my-friends-list-section" class="section">
    <h2 class="section-title">
        <i class="bi bi-people-fill"></i> My Friends
    </h2>
    <div id="myFriendsPageListEl" class="placeholder-glow">
        <p class="text-center">Loading...</p>
    </div>
</section>

<!-- Private Chats Page - SEPARATE -->
<section id="private-chats-section" class="section">
    <h2 class="section-title">
        <i class="bi bi-chat-dots-fill"></i> Private Chats
    </h2>
    <div class="custom-card text-center" style="padding: 60px 20px;">
        <i class="bi bi-chat-dots" style="font-size: 4rem; color: var(--text-secondary); opacity: 0.5;"></i>
        <h4 style="margin-top: 20px; color: var(--text-primary); font-weight: 600;">Private Chat Coming Soon! ðŸ”œ</h4>
        <p style="margin-top: 10px; color: var(--text-secondary);">
            We're working on private messaging between friends.<br>
            For now, use the <strong>Live Chat</strong> to communicate!
        </p>
        <button class="btn btn-custom btn-custom-accent mt-3 ripple" onclick="showSection('chat-section')">
            <i class="bi bi-chat-dots-fill"></i> Go to Live Chat
        </button>
    </div>
</section>

<!-- Find Friends Page - SEPARATE -->
<section id="find-friends-section" class="section">
    <h2 class="section-title">
        <i class="bi bi-search"></i> Find Friends
    </h2>
    <div class="custom-card">
        <div class="mb-3">
            <input type="text" class="form-control" id="findFriendsSearchInputEl" placeholder="Search by username or email...">
        </div>
        <div id="findFriendsResultsEl">
            <p class="text-secondary text-center small">Enter at least 2 characters to search</p>
        </div>
    </div>
</section>

<!-- Update Profile Picture Section (Hidden by default) -->
        <section id="update-profile-picture-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-image-fill"></i> Update Profile Picture
            </h2>
            <div class="custom-card">
                <div class="text-center mb-4">
                    <img src="https://via.placeholder.com/120" alt="Preview" id="profilePicturePreview" style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--accent-color); object-fit: cover; box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);">
                </div>
                
                <div class="info-box">
                    <i class="bi bi-info-circle-fill"></i>
                    <p style="margin: 0;">Enter a direct image URL (e.g., from Imgur, ImgBB, or any image hosting service). The image should be publicly accessible.</p>
                </div>

                <div class="mb-3">
                    <label for="profilePictureUrlInput" class="form-label">
                        <i class="bi bi-link-45deg"></i>
                        Image URL
                    </label>
                    <input type="url" class="form-control" id="profilePictureUrlInput" placeholder="https://example.com/your-image.jpg">
                    <small class="text-secondary d-block mt-2">
                        <i class="bi bi-exclamation-circle"></i> Paste the direct URL of your image
                    </small>
                </div>

                <div class="mb-3">
                    <button type="button" class="btn btn-custom btn-custom-secondary w-100 mb-2" id="previewImageBtn">
                        <i class="bi bi-eye-fill"></i> Preview Image
                    </button>
                </div>

                <div id="updatePictureStatusMessage" class="alert mt-3" style="display: none;"></div>

                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-custom btn-custom-accent ripple flex-1" id="saveProfilePictureBtn">
                        <i class="bi bi-check-circle"></i> Save Picture
                    </button>
                    <button type="button" class="btn btn-custom btn-custom-secondary" onclick="showSection('profile-section')">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>

                <div class="alert alert-warning mt-3" style="font-size: 0.85rem;">
                    <strong><i class="bi bi-shield-exclamation"></i> Tips:</strong>
                    <ul class="mb-0 mt-2" style="padding-left: 20px;">
                        <li>Use image hosting sites like <a href="https://imgur.com" target="_blank" style="color: var(--accent-color);">Imgur</a> or <a href="https://imgbb.com" target="_blank" style="color: var(--accent-color);">ImgBB</a></li>
                        <li>Image should be square (1:1 ratio) for best results</li>
                        <li>Recommended size: 500x500 pixels or larger</li>
                        <li>Supported formats: JPG, PNG, GIF, WebP</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Transaction History Section -->
        <section id="transaction-history-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-receipt"></i> Transaction History
            </h2>
            <div id="fullTransactionsListEl" class="placeholder-glow">
                <div class="transaction-item placeholder-glow mb-2">
                    <div class="transaction-header">
                        <span class="placeholder col-5" style="height: 18px;"></span>
                        <span class="placeholder col-3" style="height: 20px;"></span>
                    </div>
                    <div class="transaction-details">
                        <span class="placeholder col-8" style="height: 14px;"></span>
                    </div>
                </div>
            </div>
            <p id="noFullTransactionsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No transactions found.</p>
        </section>

        <!-- Withdraw History Section -->
        <section id="withdraw-history-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-arrow-up-circle"></i> Withdraw History
            </h2>
            <div id="withdrawHistoryListEl" class="placeholder-glow">
                <div class="transaction-item placeholder-glow mb-2">
                    <div class="transaction-header">
                        <span class="placeholder col-5" style="height: 18px;"></span>
                        <span class="placeholder col-3" style="height: 20px;"></span>
                    </div>
                    <div class="transaction-details">
                        <span class="placeholder col-8" style="height: 14px;"></span>
                    </div>
                </div>
            </div>
            <p id="noWithdrawHistoryMessageEl" class="text-secondary text-center mt-4" style="display: none;">No withdraw history found.</p>
        </section>

<!-- VIP Program Section -->
        <section id="vip-program-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-trophy-fill"></i> VIP Loyalty Program
            </h2>
            
            <div class="custom-card mb-3">
                <!-- Current Tier Card -->
                <div class="vip-current-tier-card" id="vipCurrentTierCard" style="background: linear-gradient(135deg, rgba(250, 204, 21, 0.2), rgba(250, 204, 21, 0.05)); border: 2px solid var(--accent-color); border-radius: 16px; padding: 20px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">
                        <i class="bi bi-trophy-fill" style="color: var(--accent-color);"></i>
                    </div>
                    <h3 style="color: var(--accent-color); font-weight: 700; margin-bottom: 10px;" id="vipCurrentTierNameEl">Loading...</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;" id="vipCurrentTierDescEl">Calculating your tier...</p>
                    
                    <div style="background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 15px; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span style="color: var(--text-secondary); font-size: 0.85rem;">Progress to Next Tier</span>
                            <span style="color: var(--accent-color); font-weight: 700; font-size: 0.85rem;" id="vipTierProgressTextEl">0%</span>
                        </div>
                        <div class="vip-progress-bar">
                            <div class="vip-progress-fill" id="vipTierProgressFillEl" style="width: 0%;"></div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 8px; margin-bottom: 0;" id="vipTierProgressHintEl">Complete more tournaments to level up!</p>
                    </div>
                </div>

                <!-- All Tiers List -->
                <div id="vipAllTiersList">
                    <h5 style="color: var(--text-primary); font-weight: 600; margin-bottom: 15px; font-size: 1rem;">
                        <i class="bi bi-stars"></i> All VIP Tiers
                    </h5>
                    
                    <!-- Bronze Tier -->
                    <div class="vip-tier-card bronze" style="margin-bottom: 15px;">
                        <div class="vip-tier-header">
                            <div class="vip-tier-name">
                                <span class="vip-tier-icon" style="color: #CD7F32;">ðŸ¥‰</span>
                                Bronze
                            </div>
                            <span class="tier-requirement" style="font-size: 0.8rem; color: var(--text-secondary);">0+ tournaments</span>
                        </div>
                        <ul class="vip-benefits-list">
                            <li><i class="bi bi-check-circle-fill"></i> Basic tournament access</li>
                            <li><i class="bi bi-check-circle-fill"></i> Standard support</li>
                            <li><i class="bi bi-check-circle-fill"></i> 1% bonus on wins</li>
                        </ul>
                    </div>

                    <!-- Silver Tier -->
                    <div class="vip-tier-card silver" style="margin-bottom: 15px;">
                        <div class="vip-tier-header">
                            <div class="vip-tier-name">
                                <span class="vip-tier-icon" style="color: #C0C0C0;">ðŸ¥ˆ</span>
                                Silver
                            </div>
                            <span class="tier-requirement" style="font-size: 0.8rem; color: var(--text-secondary);">10+ tournaments</span>
                        </div>
                        <ul class="vip-benefits-list">
                            <li><i class="bi bi-check-circle-fill"></i> Priority tournament slots</li>
                            <li><i class="bi bi-check-circle-fill"></i> Faster withdrawals</li>
                            <li><i class="bi bi-check-circle-fill"></i> 3% bonus on wins</li>
                            <li><i class="bi bi-check-circle-fill"></i> Exclusive tournaments</li>
                        </ul>
                    </div>

                    <!-- Gold Tier -->
                    <div class="vip-tier-card gold" style="margin-bottom: 15px;">
                        <div class="vip-tier-header">
                            <div class="vip-tier-name">
                                <span class="vip-tier-icon" style="color: #FFD700;">ðŸ¥‡</span>
                                Gold
                            </div>
                            <span class="tier-requirement" style="font-size: 0.8rem; color: var(--text-secondary);">50+ tournaments</span>
                        </div>
                        <ul class="vip-benefits-list">
                            <li><i class="bi bi-check-circle-fill"></i> VIP customer support</li>
                            <li><i class="bi bi-check-circle-fill"></i> Instant withdrawals</li>
                            <li><i class="bi bi-check-circle-fill"></i> 5% bonus on wins</li>
                            <li><i class="bi bi-check-circle-fill"></i> VIP tournaments</li>
                            <li><i class="bi bi-check-circle-fill"></i> Monthly rewards</li>
                        </ul>
                    </div>

                    <!-- Platinum Tier -->
                    <div class="vip-tier-card platinum">
                        <div class="vip-tier-header">
                            <div class="vip-tier-name">
                                <span class="vip-tier-icon" style="color: #E5E4E2;">ðŸ’Ž</span>
                                Platinum
                            </div>
                            <span class="tier-requirement" style="font-size: 0.8rem; color: var(--text-secondary);">100+ tournaments</span>
                        </div>
                        <ul class="vip-benefits-list">
                            <li><i class="bi bi-check-circle-fill"></i> Dedicated account manager</li>
                            <li><i class="bi bi-check-circle-fill"></i> Premium tournaments</li>
                            <li><i class="bi bi-check-circle-fill"></i> 10% bonus on wins</li>
                            <li><i class="bi bi-check-circle-fill"></i> No withdrawal limits</li>
                            <li><i class="bi bi-check-circle-fill"></i> Exclusive events</li>
                            <li><i class="bi bi-check-circle-fill"></i> Birthday rewards</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Achievements Section -->
        <section id="achievements-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-trophy-fill"></i> Achievements
            </h2>
            <div id="achievementsListEl" class="placeholder-glow">
                <div class="achievement-card placeholder-glow mb-3">
                    <div class="achievement-icon">
                        <span class="placeholder" style="width: 60px; height: 60px; border-radius: 50%; display: inline-block;"></span>
                    </div>
                    <div class="achievement-content" style="flex: 1;">
                        <div class="achievement-title">
                            <span class="placeholder col-8" style="height: 18px;"></span>
                        </div>
                        <div class="achievement-description mt-2">
                            <span class="placeholder col-12" style="height: 14px;"></span>
                        </div>
                    </div>
                </div>
            </div>
            <p id="noAchievementsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No achievements available</p>
        </section>

        <!-- My Badges Section -->
        <section id="my-badges-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-award-fill"></i> My Badges
            </h2>
            
            <div class="info-box mb-3">
                <i class="bi bi-info-circle-fill"></i>
                <p>Click on a badge to equip it. Your active badge will be displayed on your profile.</p>
            </div>

            <div class="current-badge-display mb-4" style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(250, 204, 21, 0.1), rgba(250, 204, 21, 0.05)); border-radius: 12px; border: 2px dashed var(--accent-color);">
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px;">Active Badge</p>
                <div id="activeBadgeDisplayEl" style="width: 100px; height: 100px; margin: 0 auto; border-radius: 50%; border: 3px solid var(--accent-color); overflow: hidden; box-shadow: 0 4px 15px rgba(250, 204, 21, 0.4);">
                    <img src="https://ui-avatars.com/api/?name=No+Badge&background=334155&color=94A3B8&size=100" alt="No Badge" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <p id="activeBadgeNameEl" style="margin-top: 10px; font-weight: 600; color: var(--text-primary);">No Badge Equipped</p>
            </div>

            <div id="badgesGridEl" class="row g-3">
                <div class="col-6 col-md-4 placeholder-glow">
                    <div class="badge-card">
                        <div class="badge-icon">
                            <span class="placeholder" style="width: 80px; height: 80px; border-radius: 50%; display: inline-block;"></span>
                        </div>
                        <div class="badge-name mt-2">
                            <span class="placeholder col-8"></span>
                        </div>
                    </div>
                </div>
            </div>
            <p id="noBadgesMessageEl" class="text-secondary text-center mt-4" style="display: none;">No badges earned yet. Complete achievements to unlock badges!</p>
        </section>

<!-- Achievement Details Modal -->
    <div class="modal fade" id="achievementDetailsModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Achievement Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div class="achievement-icon" id="detailsBadgeIconEl" style="width: 100px; height: 100px; margin: 0 auto;">
                            <img src="" alt="Badge" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
                        </div>
                    </div>
                    <h4 class="text-center mb-3" id="detailsAchievementNameEl">Achievement Name</h4>
                    <div class="info-box">
                        <i class="bi bi-target"></i>
                        <div>
                            <strong>Objective:</strong>
                            <p id="detailsAchievementDetailsEl" style="margin-top: 5px;">Details here</p>
                        </div>
                    </div>
                    <div class="info-box mt-3" style="background: linear-gradient(135deg, rgba(250, 204, 21, 0.15), rgba(250, 204, 21, 0.05)); border-color: rgba(250, 204, 21, 0.3);">
                        <i class="bi bi-gift-fill" style="color: var(--accent-color);"></i>
                        <div>
                            <strong style="color: var(--accent-color);">Reward:</strong>
                            <p id="detailsAchievementRewardEl" style="margin-top: 5px; color: var(--text-primary);">â‚¹0 + Badge</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <strong>Progress:</strong>
                        <div class="achievement-progress mt-2">
                            <div class="achievement-progress-bar">
                                <div class="achievement-progress-fill" id="detailsProgressFillEl" style="width: 0%;"></div>
                            </div>
                            <span class="achievement-progress-text" id="detailsProgressTextEl">0%</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary ripple" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Congratulations Modal -->
        <div class="congrats-modal" id="congratsModalEl">
            <div class="congrats-content">
                <div class="congrats-badge" id="congratsBadgeEl">
                    <img src="" alt="Badge">
                </div>
                <h2 class="congrats-title">ðŸŽ‰ Congratulations! ðŸŽ‰</h2>
                <p class="congrats-message" id="congratsMessageEl">You've completed an achievement!</p>
                <div class="congrats-reward" id="congratsRewardEl">+â‚¹0</div>
                <button class="congrats-close ripple" id="congratsCloseEl">Awesome!</button>
            </div>
        </div>

        <!-- Match History Section -->
        <section id="match-history-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-clock-history"></i> Match History
            </h2>
            <div id="matchHistoryListEl" class="placeholder-glow">
                <div class="match-history-item placeholder-glow mb-2">
                    <div class="match-history-header">
                        <span class="placeholder col-6" style="height: 18px;"></span>
                        <span class="placeholder col-3" style="height: 20px; border-radius: 20px;"></span>
                    </div>
                    <div class="match-history-details mt-2">
                        <div class="match-detail-item">
                            <span class="placeholder col-8" style="height: 14px;"></span>
                            <span class="placeholder col-6 mt-1" style="height: 16px;"></span>
                        </div>
                    </div>
                </div>
            </div>
            <p id="noMatchHistoryMessageEl" class="text-secondary text-center mt-4" style="display: none;">No match history found.</p>
        </section>

<!-- Tournament Result Section -->
        <section id="tournament-result-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-trophy-fill"></i> Tournament Results
            </h2>
            
            <div class="custom-card mb-3">
                <h3 class="text-center mb-3" id="resultTournamentNameEl">Tournament Name</h3>
                
                <!-- Winner Podium -->
                <div class="result-podium" style="display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin: 30px 0;">
                    <!-- Second Place -->
                    <div class="podium-position" style="text-align: center; flex: 1; max-width: 150px;">
                        <div class="position-badge" style="background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 1.5rem; font-weight: 700; box-shadow: 0 4px 15px rgba(192, 192, 192, 0.4);">
                            2
                        </div>
                        <div class="position-bar" style="background: linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(192, 192, 192, 0.1)); border-radius: 12px 12px 0 0; padding: 20px 15px; height: 120px; display: flex; flex-direction: column; justify-content: center; border: 2px solid rgba(192, 192, 192, 0.3);">
                            <div class="winner-name" id="resultSecondNameEl" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: var(--text-primary);">-</div>
                            <div class="winner-prize" id="resultSecondPrizeEl" style="font-weight: 700; font-size: 1.1rem; color: #C0C0C0;">â‚¹0</div>
                        </div>
                    </div>

                    <!-- First Place (Winner) -->
                    <div class="podium-position" style="text-align: center; flex: 1; max-width: 150px;">
                        <div class="position-badge" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: var(--primary-bg); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 2rem; font-weight: 700; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.6); animation: pulse 2s infinite;">
                            <i class="bi bi-trophy-fill"></i>
                        </div>
                        <div class="position-bar" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1)); border-radius: 12px 12px 0 0; padding: 25px 15px; height: 160px; display: flex; flex-direction: column; justify-content: center; border: 2px solid rgba(255, 215, 0, 0.5);">
                            <div class="winner-name" id="resultFirstNameEl" style="font-weight: 700; font-size: 1rem; margin-bottom: 10px; color: var(--text-primary);">-</div>
                            <div class="winner-prize" id="resultFirstPrizeEl" style="font-weight: 700; font-size: 1.3rem; color: #FFD700;">â‚¹0</div>
                        </div>
                    </div>

                    <!-- Third Place -->
                    <div class="podium-position" style="text-align: center; flex: 1; max-width: 150px;">
                        <div class="position-badge" style="background: linear-gradient(135deg, #CD7F32, #8B4513); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 1.5rem; font-weight: 700; box-shadow: 0 4px 15px rgba(205, 127, 50, 0.4);">
                            3
                        </div>
                        <div class="position-bar" style="background: linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(205, 127, 50, 0.1)); border-radius: 12px 12px 0 0; padding: 20px 15px; height: 100px; display: flex; flex-direction: column; justify-content: center; border: 2px solid rgba(205, 127, 50, 0.3);">
                            <div class="winner-name" id="resultThirdNameEl" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: var(--text-primary);">-</div>
                            <div class="winner-prize" id="resultThirdPrizeEl" style="font-weight: 700; font-size: 1.1rem; color: #CD7F32;">â‚¹0</div>
                        </div>
                    </div>
                </div>

                <!-- Full Results List -->
                <div class="mt-4">
                    <h5 class="mb-3" style="color: var(--text-primary);">
                        <i class="bi bi-list-ol"></i> Complete Rankings
                    </h5>
                    <div id="fullResultsListEl">
                        <p class="text-secondary text-center">Loading results...</p>
                    </div>
                </div>

                <button class="btn btn-custom btn-custom-secondary w-100 mt-3 ripple" onclick="showSection('home-section')">
                    <i class="bi bi-arrow-left"></i> Back to Home
                </button>
            </div>
        </section>

<!-- Tournament Result Section -->
<section id="tournament-result-section" class="section">
    <h2 class="section-title">
        <i class="bi bi-trophy-fill"></i> Tournament Results
    </h2>
    
    <div class="custom-card mb-3">
        <h3 class="text-center mb-3" id="resultTournamentNameEl">Tournament Name</h3>
        
        <!-- Winner Podium -->
        <div class="result-podium" style="display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin: 30px 0;">
            <!-- Second Place -->
            <div class="podium-position" style="text-align: center; flex: 1; max-width: 150px;">
                <div class="position-badge" style="background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 1.5rem; font-weight: 700; box-shadow: 0 4px 15px rgba(192, 192, 192, 0.4);">
                    2
                </div>
                <div class="position-bar" style="background: linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(192, 192, 192, 0.1)); border-radius: 12px 12px 0 0; padding: 20px 15px; height: 120px; display: flex; flex-direction: column; justify-content: center; border: 2px solid rgba(192, 192, 192, 0.3);">
                    <div class="winner-name" id="resultSecondNameEl" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: var(--text-primary);">-</div>
                    <div class="winner-prize" id="resultSecondPrizeEl" style="font-weight: 700; font-size: 1.1rem; color: #C0C0C0;">â‚¹0</div>
                </div>
            </div>

            <!-- First Place (Winner) -->
            <div class="podium-position" style="text-align: center; flex: 1; max-width: 150px;">
                <div class="position-badge" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: var(--primary-bg); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 2rem; font-weight: 700; box-shadow: 0 4px 20px rgba(255, 215, 0, 0.6); animation: pulse 2s infinite;">
                    <i class="bi bi-trophy-fill"></i>
                </div>
                <div class="position-bar" style="background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1)); border-radius: 12px 12px 0 0; padding: 25px 15px; height: 160px; display: flex; flex-direction: column; justify-content: center; border: 2px solid rgba(255, 215, 0, 0.5);">
                    <div class="winner-name" id="resultFirstNameEl" style="font-weight: 700; font-size: 1rem; margin-bottom: 10px; color: var(--text-primary);">-</div>
                    <div class="winner-prize" id="resultFirstPrizeEl" style="font-weight: 700; font-size: 1.3rem; color: #FFD700;">â‚¹0</div>
                </div>
            </div>

            <!-- Third Place -->
            <div class="podium-position" style="text-align: center; flex: 1; max-width: 150px;">
                <div class="position-badge" style="background: linear-gradient(135deg, #CD7F32, #8B4513); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 1.5rem; font-weight: 700; box-shadow: 0 4px 15px rgba(205, 127, 50, 0.4);">
                    3
                </div>
                <div class="position-bar" style="background: linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(205, 127, 50, 0.1)); border-radius: 12px 12px 0 0; padding: 20px 15px; height: 100px; display: flex; flex-direction: column; justify-content: center; border: 2px solid rgba(205, 127, 50, 0.3);">
                    <div class="winner-name" id="resultThirdNameEl" style="font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: var(--text-primary);">-</div>
                    <div class="winner-prize" id="resultThirdPrizeEl" style="font-weight: 700; font-size: 1.1rem; color: #CD7F32;">â‚¹0</div>
                </div>
            </div>
        </div>

        <!-- Full Results List -->
        <div class="mt-4">
            <h5 class="mb-3" style="color: var(--text-primary);">
                <i class="bi bi-list-ol"></i> Complete Rankings
            </h5>
            <div id="fullResultsListEl">
                <p class="text-secondary text-center">Loading results...</p>
            </div>
        </div>

        <button class="btn btn-custom btn-custom-secondary w-100 mt-3 ripple" onclick="showSection('home-section')">
            <i class="bi bi-arrow-left"></i> Back to Home
        </button>
    </div>
</section>

        <!-- Edit Nickname Page -->
        <section id="edit-nickname-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-pencil-square"></i> Edit Nickname
            </h2>
            <div class="custom-card">
                <div class="mb-3">
                    <label for="editNicknameInputEl" class="form-label">New Nickname</label>
                    <input type="text" class="form-control" id="editNicknameInputEl" placeholder="Enter new nickname">
                </div>
                <div id="nicknameStatusMessageEl" class="alert mt-2" style="display: none;"></div>
                <div class="d-flex gap-2">
                    <button class="btn btn-custom btn-custom-accent ripple flex-1" id="updateNicknameBtnEl">
                        <i class="bi bi-check-circle"></i> Update Nickname
                    </button>
                    <button class="btn btn-custom btn-custom-secondary" onclick="showSection('profile-section')">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </div>
        </section>

        <!-- Redeem Coupon Page -->
        <section id="redeem-coupon-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-gift-fill"></i> Redeem Coupon
            </h2>
            <div class="custom-card">
                <div class="mb-3">
                    <label for="couponCodeInputEl" class="form-label">Coupon Code</label>
                    <input type="text" class="form-control" id="couponCodeInputEl" placeholder="Enter coupon code" style="text-transform: uppercase;">
                </div>
                <div id="couponStatusMessageEl" class="alert mt-2" style="display: none;"></div>
                <div class="d-flex gap-2">
                    <button class="btn btn-custom btn-custom-accent ripple flex-1" id="redeemCouponBtnEl">
                        <i class="bi bi-gift-fill"></i> Redeem Coupon
                    </button>
                    <button class="btn btn-custom btn-custom-secondary" onclick="showSection('profile-section')">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </div>
        </section>

        <!-- Send Feedback Page -->
        <section id="send-feedback-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-chat-dots-fill"></i> Send Feedback
            </h2>
            <div class="custom-card">
                <div class="mb-3">
                    <label for="feedbackMessageEl" class="form-label">Your Feedback</label>
                    <textarea class="form-control" id="feedbackMessageEl" rows="6" placeholder="Share your thoughts, suggestions, or report issues..."></textarea>
                </div>
                <div id="feedbackStatusMessageEl" class="alert mt-2" style="display: none;"></div>
                <div class="d-flex gap-2">
                    <button class="btn btn-custom btn-custom-primary ripple flex-1" id="sendFeedbackBtnEl">
                        <i class="bi bi-send-fill"></i> Send Feedback
                    </button>
                    <button class="btn btn-custom btn-custom-secondary" onclick="showSection('profile-section')">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
            </div>
        </section>

        <!-- Change Password Page -->
        <section id="change-password-section" class="section">
            <h2 class="section-title">
                <i class="bi bi-key-fill"></i> Change Password
            </h2>
            <div class="custom-card">
                <div class="password-form-group">
                    <label for="currentPasswordInputEl">Current Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" class="form-control" id="currentPasswordInputEl" placeholder="Enter current password">
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('currentPasswordInputEl', this)">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                    </div>
                </div>
                <div class="password-form-group">
                    <label for="newPasswordInputEl">New Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" class="form-control" id="newPasswordInputEl" placeholder="Enter new password" minlength="6">
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('newPasswordInputEl', this)">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                    </div>
                </div>
                <div class="password-form-group">
                    <label for="confirmNewPasswordInputEl">Confirm New Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" class="form-control" id="confirmNewPasswordInputEl" placeholder="Confirm new password">
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('confirmNewPasswordInputEl', this)">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                    </div>
                </div>
                <div id="changePasswordStatusMessageEl" class="alert mt-2" style="display: none;"></div>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-custom btn-custom-primary ripple flex-1" id="changePasswordBtnEl">
                        <i class="bi bi-check-circle"></i> Change Password
                    </button>
                    <button class="btn btn-custom btn-custom-secondary" onclick="showSection('profile-section')">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                </div>
                <div class="text-center mt-3">
                    <button class="btn-custom-link" id="forgotPasswordFromSettingsEl">
                        <i class="bi bi-question-circle"></i> Forgot Password?
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="policyModalTitleEl">Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Add Amount Modal with QR Code -->
    <div class="modal fade" id="addAmountModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-wallet-fill me-2"></i> Add Amount</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="info-box">
                        <i class="bi bi-info-circle-fill"></i>
                        <p><strong>Step 1:</strong> Scan QR or Copy UPI ID<br>
                        <strong>Step 2:</strong> Transfer money via UPI/Other method<br>
                        <strong>Step 3:</strong> Select TID type<br>
                        <strong>Step 4:</strong> Enter transaction ID<br>
                        <strong>Step 5:</strong> Submit for verification</p>
                    </div>

                    <!-- QR Code Display -->
                    <div class="qr-code-container">
                        <div class="qr-code-label">Scan QR Code to Pay</div>
                        <img src="https://i.ibb.co/0jgtbwVQ/Screenshot-20251022-204904-3.webp" alt="QR Code" class="qr-code-image" id="qrCodeImageEl">
                        <div class="qr-code-label mt-3">Or Use UPI ID</div>
                        <div class="upi-id-display">
                            <span class="upi-id-text" id="upiDisplayEl">Loading...</span>
                            <button class="copy-upi-btn ripple" onclick="copyToClipboard('#upiDisplayEl')">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                    </div>

                    <hr style="border-color: var(--border-color); margin: 25px 0;">

                    <div class="mb-3">
    <label for="addAmountInputEl" class="form-label">
        <i class="bi bi-currency-exchange"></i>
        Enter Amount
    </label>
    <input type="number" class="form-control" id="addAmountInputEl" placeholder="Enter amount" min="1" step="1">
</div>

                    <!-- Quick Amount Buttons -->
                    <div class="quick-amounts">
                        <button type="button" class="quick-amount ripple" data-amount="50">â‚¹50</button>
                        <button type="button" class="quick-amount ripple" data-amount="500">â‚¹500</button>
                        <button type="button" class="quick-amount ripple" data-amount="1000">â‚¹1000</button>
                        <button type="button" class="quick-amount ripple" data-amount="5000">â‚¹5000</button>
                        <button type="button" class="quick-amount ripple" data-amount="10000">â‚¹10000</button>
                        <button type="button" class="quick-amount ripple" data-amount="25000">â‚¹25000</button>
                    </div>

                    <!-- UTR Type Selection -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="bi bi-credit-card-2-front"></i>
                            Select Transaction Type
                        </label>
                        <div class="utr-type-selector">
    <button type="button" class="utr-type-btn active ripple" data-utr-type="12">
    <i class="bi bi-phone-fill"></i>
    <span>PhonePe</span>
    <small class="d-block text-secondary" style="font-size: 0.75rem;">12-35 Chars</small>
</button>
<button type="button" class="utr-type-btn ripple" data-utr-type="16">
    <i class="bi bi-credit-card-2-front"></i>
    <span>Other Method</span>
    <small class="d-block text-secondary" style="font-size: 0.75rem;">10-50 Chars</small>
</button>
</div>
                    </div>

                    <div class="mb-3">
                        <label for="addUtrInputEl" class="form-label">
                            <i class="bi bi-receipt"></i>
                            Enter Transaction ID (<span id="utrDigitDisplayEl">12</span> digits)
                        </label>
                        <input type="text" class="form-control" id="addUtrInputEl" placeholder="Enter 12-digit TID" maxlength="12" pattern="[0-9]*" inputmode="numeric">
                        <small class="text-secondary d-block mt-2" id="utrHelperTextEl">
                            <i class="bi bi-exclamation-circle"></i> TID must be exactly 12 digits (numbers only)
                        </small>
                    </div>

                    <div id="addAmountStatusMessageEl" class="alert mt-3" style="display: none;"></div>

                    <div class="info-box" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
                        <i class="bi bi-exclamation-triangle-fill" style="color: var(--danger-color);"></i>
                        <p style="color: var(--text-primary);"><strong>IMPORTANT:</strong> After payment, submit the form with your amount and UTR ID. Amount will be added after admin verification within 10-15 minutes.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary ripple" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-custom btn-custom-primary ripple" id="submitAddAmountBtnEl">
                        <i class="bi bi-check-circle"></i> Submit Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal fade" id="withdrawModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-secondary">Withdrawable balance: <strong class="text-light" id="withdrawModalBalanceEl">â‚¹0.00</strong></p>
                    <div class="mb-3">
                        <label for="withdrawAmountInputEl" class="form-label">Amount (Min â‚¹<span id="minWithdrawAmountEl">50</span>)</label>
                        <input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="Enter amount">
                    </div>
                    <div class="mb-3">
                        <label for="withdrawMethodInputEl" class="form-label">Withdrawal Method (UPI ID/Other method)</label>
                        <input type="text" class="form-control" id="withdrawMethodInputEl" placeholder="Enter UPI ID/UPI number">
                    </div>
                    <div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary ripple" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary ripple" id="submitWithdrawRequestBtnEl">Submit Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Match Details Modal -->
    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="matchDetailsModalBodyEl">
                    <div class="text-center p-5">
                        <div class="spinner-border spinner-border-sm"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Details Modal (UPDATED WITH DYNAMIC INPUTS) -->
    <div class="modal fade" id="teamDetailsModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="teamDetailsModalTitleEl">
                        <i class="bi bi-people-fill me-2"></i>Enter Team Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="info-box">
                        <i class="bi bi-info-circle-fill"></i>
                        <p id="teamDetailsInfoTextEl">Enter your Game UID to join this tournament.</p>
                    </div>

                    <div class="team-details-section" id="teamDetailsInputSectionEl">
                        <!-- Dynamic inputs will be added here based on match type -->
                    </div>

                    <div id="teamDetailsStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary ripple" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-custom btn-custom-primary ripple" id="submitTeamDetailsBtnEl">
                        <i class="bi bi-check-circle"></i> Join Tournament
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ID Password Modal -->
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-key-fill me-2"></i> Room ID & Password</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="small text-secondary">ID/Pass shown shortly before match start.</p>
                    <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                        <p class="mb-1">Room ID:</p>
                        <h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block">
                            <span class="placeholder col-6"></span>
                        </h4>
                        <button class="btn btn-sm btn-outline-warning ms-2 copy-btn ripple" onclick="copyToClipboard('#roomIdDisplayEl')" title="Copy Room ID">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                        <p class="mb-1">Password:</p>
                        <h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block">
                            <span class="placeholder col-6"></span>
                        </h4>
                        <button class="btn btn-sm btn-outline-warning ms-2 copy-btn ripple" onclick="copyToClipboard('#roomPasswordDisplayEl')" title="Copy Password">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <p class="small text-warning">
                        <i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Claim Modal -->
    <div class="modal fade" id="resultClaimModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-trophy-fill me-2"></i> Claim Prize</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="info-box">
                        <i class="bi bi-info-circle-fill"></i>
                        <p>Select your achieved rank to claim your prize. Admin will verify and approve your claim.</p>
                    </div>

                    <h6 class="mb-3" style="color: var(--text-primary);">Tournament: <span id="claimTournamentNameEl" class="text-accent">-</span></h6>

                    <div class="result-prizes-container" id="prizesListEl">
                        <!-- Prizes will be dynamically loaded here -->
                    </div>

                    <div id="claimStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item active ripple" data-section="home-section">
            <i class="bi bi-house-door-fill"></i>
            <span>Home</span>
        </button>
        <button class="nav-item ripple" data-section="wallet-section">
            <i class="bi bi-wallet-fill"></i>
            <span>Wallet</span>
        </button>
        <button class="nav-item ripple" data-section="leaderboard-section">
            <i class="bi bi-trophy-fill"></i>
            <span>Leaderboard</span>
        </button>
        <button class="nav-item ripple" data-section="chat-section">
            <i class="bi bi-chat-dots-fill"></i>
            <span>Live Chat</span>
        </button>
        <button class="nav-item ripple" data-section="profile-section">
            <i class="bi bi-person-fill"></i>
            <span>Profile</span>
        </button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Friends System Modal - NEW -->
    <div class="modal fade" id="friendsSystemModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-people-fill me-2"></i>
                        <span id="friendsModalTitleEl">Friends & Chat</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <!-- Friends Tabs -->
                    <div class="friends-tabs" style="display: flex; background: rgba(30, 41, 59, 0.5); padding: 8px; margin: 15px; border-radius: 12px; gap: 8px;">
                        <button class="friends-tab active" data-friends-tab="requests" style="flex: 1; padding: 10px; background: none; border: none; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            <i class="bi bi-person-plus-fill"></i> Requests
                        </button>
                        <button class="friends-tab" data-friends-tab="friends" style="flex: 1; padding: 10px; background: none; border: none; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            <i class="bi bi-people-fill"></i> Friends
                        </button>
                        <button class="friends-tab" data-friends-tab="chats" style="flex: 1; padding: 10px; background: none; border: none; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            <i class="bi bi-chat-dots-fill"></i> Chats
                        </button>
                        <button class="friends-tab" data-friends-tab="search" style="flex: 1; padding: 10px; background: none; border: none; color: var(--text-secondary); font-weight: 600; font-size: 0.85rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>

                    <!-- Friend Requests Tab -->
                    <div class="friends-tab-content" id="friendRequestsTabEl" style="padding: 20px;">
                        <div id="friendRequestsListEl">
                            <p class="text-secondary text-center">Loading...</p>
                        </div>
                    </div>

                    <!-- My Friends Tab -->
                    <div class="friends-tab-content" id="myFriendsTabEl" style="padding: 20px; display: none;">
                        <div id="myFriendsListEl">
                            <p class="text-secondary text-center">Loading...</p>
                        </div>
                    </div>

                    <!-- Chats Tab -->
                    <div class="friends-tab-content" id="chatsTabEl" style="padding: 20px; display: none;">
                        <div id="chatsListEl">
                            <p class="text-secondary text-center">Private chat coming soon!</p>
                        </div>
                    </div>

                    <!-- Search Friends Tab -->
                    <div class="friends-tab-content" id="searchFriendsTabEl" style="padding: 20px; display: none;">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="searchFriendsInputEl" placeholder="Search by username or email...">
                        </div>
                        <div id="searchFriendsResultsEl">
                            <p class="text-secondary text-center small">Enter a username or email to search</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- User Profile Modal -->
    <div class="user-profile-modal" id="userProfileModalEl">
        <div class="user-profile-modal-content">
            <div class="user-profile-modal-header">
                <h5 style="margin: 0; color: var(--primary-bg); font-weight: 700;">User Profile</h5>
                <button class="user-profile-modal-close" id="closeUserProfileModalEl">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="user-profile-modal-body">
                <div class="user-profile-avatar-section">
                    <img src="https://via.placeholder.com/120" alt="User Avatar" class="user-profile-avatar-large" id="modalUserAvatarEl">
                    <div class="user-profile-name-display" id="modalUserNameEl">Loading...</div>
                    <div class="user-profile-tier-badge" id="modalUserTierEl">
                        <i class="bi bi-trophy-fill"></i>
                        <span>Loading...</span>
                    </div>
                </div>
                
                <div class="user-profile-stats-grid">
                    <div class="user-profile-stat-card">
                        <div class="user-profile-stat-value" id="modalUserMatchesEl">0</div>
                        <div class="user-profile-stat-label">Matches Played</div>
                    </div>
                    <div class="user-profile-stat-card">
                        <div class="user-profile-stat-value" id="modalUserWinsEl">0</div>
                        <div class="user-profile-stat-label">Matches Won</div>
                    </div>
                    <div class="user-profile-stat-card">
                        <div class="user-profile-stat-value" id="modalUserBalanceEl">â‚¹0</div>
                        <div class="user-profile-stat-label">Total Balance</div>
                    </div>
                    <div class="user-profile-stat-card">
                        <div class="user-profile-stat-value" id="modalUserEarningsEl">â‚¹0</div>
                        <div class="user-profile-stat-label">Total Earnings</div>
                    </div>
                </div>
                
                <div class="user-profile-actions">
                    <button class="user-profile-action-btn friend-request ripple" id="sendFriendRequestBtnEl">
                        <i class="bi bi-person-plus-fill"></i>
                        <span>Send Friend Request</span>
                    </button>
                    <button class="user-profile-action-btn chat ripple" id="openPrivateChatBtnEl">
                        <i class="bi bi-chat-dots-fill"></i>
                        <span>Start Chat</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, off, runTransaction, serverTimestamp, limitToLast } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updatePassword, EmailAuthProvider, reauthenticateWithCredential, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAxdxcKJiJU5pU06mjYHxOPW3_SZeopcG4",
            authDomain: "free-fire-turnament-1d93f.firebaseapp.com",
            databaseURL: "https://free-fire-turnament-1d93f-default-rtdb.firebaseio.com",
            projectId: "free-fire-turnament-1d93f",
            storageBucket: "free-fire-turnament-1d93f.firebasestorage.app",
            messagingSenderId: "8052881561",
            appId: "1:8052881561:web:0606ddd156a7d935311a58",
            measurementId: "G-QCCFGSWWHK"
        };

        let app, db, auth;
        let isSignupInProgress = false;
        let authStateInitialized = false;
        let selectedUtrType = '12';
        let currentJoiningTournament = null;

        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            
            // âœ… CRITICAL FIX: Force auth to use session-only storage
            auth.setPersistence({
                type: 'SESSION' // This makes auth expire when browser closes
            }).catch(err => console.warn("Persistence warning:", err));
            
            console.log("âœ… Firebase Initialized Successfully");
        } catch (error) {
            console.error("âŒ Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0" style="z-index: 10000;"><strong>Critical Error:</strong> Could not connect to Firebase. Check console for details.<br><small>${error.message}</small></div>`;
            throw error;
        }

        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);

        const elements = {
            sections: querySelAll('.section'),
            bottomNavItems: querySelAll('.bottom-nav .nav-item'),
            globalLoader: getElement('globalLoaderEl'),
            headerBackBtn: getElement('headerBackBtnEl'),
            headerTitleContainer: getElement('headerTitleContainerEl'),
            headerGameTitle: getElement('headerGameTitleEl'),
            headerWalletChip: getElement('headerWalletChipEl'),
            headerChipBalance: getElement('headerChipBalanceEl'),
            headerUserGreeting: getElement('headerUserGreetingEl'),
            appLogo: getElement('appLogoEl'),
            notificationBtn: getElement('notificationBtnEl'),
            notificationBadge: getElement('notificationBadgeEl'),
            toastContainer: getElement('toastContainerEl'),
            updateBanner: getElement('updateBannerEl'),
            updateBannerTitle: getElement('updateBannerTitleEl'),
            updateBannerDescription: getElement('updateBannerDescriptionEl'),
            updateBannerVersion: getElement('updateBannerVersionEl'),
            updateBannerClose: getElement('updateBannerCloseEl'),
            updateBannerDownload: getElement('updateBannerDownloadEl'),
            updateBannerIgnore: getElement('updateBannerIgnoreEl'),
            loginSection: getElement('login-section'),
            emailLoginForm: getElement('emailLoginForm'),
            loginEmailInput: getElement('loginEmailInputEl'),
            loginPasswordInput: getElement('loginPasswordInputEl'),
            loginEmailBtn: getElement('loginEmailBtnEl'),
            showSignupToggleBtn: getElement('showSignupToggleBtnEl'),
            loginStatusMessage: getElement('loginStatusMessageEl'),
            forgotPasswordLink: getElement('forgotPasswordLinkEl'),
            emailSignupForm: getElement('emailSignupForm'),
            signupEmailInput: getElement('signupEmailInputEl'),
            signupPasswordInput: getElement('signupPasswordInputEl'),
            signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'),
            signupGameNameInput: getElement('signupGameNameInputEl'),
            signupReferralCodeInput: getElement('signupReferralCodeInputEl'),
            signupEmailBtn: getElement('signupEmailBtnEl'),
            showLoginToggleBtn: getElement('showLoginToggleBtnEl'),
            signupStatusMessage: getElement('signupStatusMessageEl'),
            homeSection: getElement('home-section'),
            promotionSlider: getElement('promotionSliderEl'),
            gamesList: getElement('gamesListEl'),
            myContestsList: getElement('myContestsListEl'),
            noContestsMessage: getElement('noContestsMessageEl'),
            myGamesList: getElement('myGamesListEl'),
            noMyGamesMessage: getElement('noMyGamesMessageEl'),
            latestTournamentsList: getElement('latestTournamentsListEl'),
            noLatestTournamentsMessage: getElement('noLatestTournamentsMessageEl'),
            tournamentsSection: getElement('tournaments-section'),
            tournamentsListContainer: getElement('tournamentsListContainerEl'),
            noTournamentsMessage: getElement('noTournamentsMessageEl'),
            tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
            myGamesTabs: querySelAll('.my-games-tab'),
            walletSection: getElement('wallet-section'),
            walletTotalBalance: getElement('walletTotalBalanceEl'),
            walletWinningCash: getElement('walletWinningCashEl'),
            walletCashBalance: getElement('walletCashBalanceEl'),
            walletBonusCash: getElement('walletBonusCashEl'),
            allTransactionsBtn: getElement('allTransactionsBtnEl'),
            withdrawBtn: getElement('withdrawBtnEl'),
            withdrawBtn2: getElement('withdrawBtnEl2'),
            addAmountWalletBtn: getElement('addAmountWalletBtnEl'),
            recentTransactionsList: getElement('recentTransactionsListEl'),
            noTransactionsMessage: getElement('noTransactionsMessageEl'),
            chatSection: getElement('chat-section'),
            chatMessages: getElement('chatMessagesEl'),
            chatInput: getElement('chatInputEl'),
            chatSendBtn: getElement('chatSendBtnEl'),
            leaderboardSection: getElement('leaderboard-section'),
            leaderboardList: getElement('leaderboardListEl'),
            noLeaderboardMessage: getElement('noLeaderboardMessageEl'),
            earningsSection: getElement('earnings-section'),
            earningsTotal: getElement('earningsTotalEl'),
            earningsReferral: getElement('earningsReferralEl'),
            earningsCoupon: getElement('earningsCouponEl'),
            viewEarningsHistoryBtn: getElement('viewEarningsHistoryBtn'),
            earningsHistoryContainer: getElement('earningsHistoryContainerEl'),
            earningsHistoryList: getElement('earningsHistoryListEl'),
            noEarningsMessage: getElement('noEarningsMessageEl'),
            notificationsSection: getElement('notifications-section'),
            notificationsList: getElement('notificationsListEl'),
            noNotificationsMessage: getElement('noNotificationsMessageEl'),
            profileSection: getElement('profile-section'),
            profileAvatar: getElement('profileAvatarEl'),
            profileName: getElement('profileNameEl'),
            profileEmail: getElement('profileEmailEl'),
            profileTotalMatches: getElement('profileTotalMatchesEl'),
            profileWonMatches: getElement('profileWonMatchesEl'),
            profileTotalEarnings: getElement('profileTotalEarningsEl'),
            logoutProfileBtn: getElement('logoutProfileBtnEl'),
            policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'),
            notificationSwitch: getElement('notificationSwitchEl'),
            editNicknameSection: getElement('edit-nickname-section'),
            editNicknameInput: getElement('editNicknameInputEl'),
            updateNicknameBtn: getElement('updateNicknameBtnEl'),
            nicknameStatusMessage: getElement('nicknameStatusMessageEl'),
            redeemCouponSection: getElement('redeem-coupon-section'),
            couponCodeInput: getElement('couponCodeInputEl'),
            redeemCouponBtn: getElement('redeemCouponBtnEl'),
            couponStatusMessage: getElement('couponStatusMessageEl'),
            sendFeedbackSection: getElement('send-feedback-section'),
            feedbackMessage: getElement('feedbackMessageEl'),
            sendFeedbackBtn: getElement('sendFeedbackBtnEl'),
            feedbackStatusMessage: getElement('feedbackStatusMessageEl'),
            changePasswordSection: getElement('change-password-section'),
            currentPasswordInput: getElement('currentPasswordInputEl'),
            newPasswordInput: getElement('newPasswordInputEl'),
            confirmNewPasswordInput: getElement('confirmNewPasswordInputEl'),
            changePasswordBtn: getElement('changePasswordBtnEl'),
            changePasswordStatusMessage: getElement('changePasswordStatusMessageEl'),
            forgotPasswordFromSettings: getElement('forgotPasswordFromSettingsEl'),
            transactionHistorySection: getElement('transaction-history-section'),
            fullTransactionsList: getElement('fullTransactionsListEl'),
            noFullTransactionsMessage: getElement('noFullTransactionsMessageEl'),
            withdrawHistorySection: getElement('withdraw-history-section'),
            withdrawHistoryList: getElement('withdrawHistoryListEl'),
            noWithdrawHistoryMessage: getElement('noWithdrawHistoryMessageEl'),
            matchHistorySection: getElement('match-history-section'),
            matchHistoryList: getElement('matchHistoryListEl'),
            noMatchHistoryMessage: getElement('noMatchHistoryMessageEl'),
            policyModalInstance: null,
            policyModalTitle: getElement('policyModalTitleEl'),
            policyModalBody: getElement('policyModalBodyEl'),
            addAmountModalInstance: null,
            addAmountInput: getElement('addAmountInputEl'),
            addUtrInput: getElement('addUtrInputEl'),
            submitAddAmountBtn: getElement('submitAddAmountBtnEl'),
            addAmountStatusMessage: getElement('addAmountStatusMessageEl'),
            upiDisplay: getElement('upiDisplayEl'),
            qrCodeImage: getElement('qrCodeImageEl'),
            utrDigitDisplay: getElement('utrDigitDisplayEl'),
            utrHelperText: getElement('utrHelperTextEl'),
            withdrawModalInstance: null,
            withdrawModalBalance: getElement('withdrawModalBalanceEl'),
            withdrawAmountInput: getElement('withdrawAmountInputEl'),
            withdrawMethodInput: getElement('withdrawMethodInputEl'),
            minWithdrawAmount: getElement('minWithdrawAmountEl'),
            withdrawStatusMessage: getElement('withdrawStatusMessageEl'),
            submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
            matchDetailsModalInstance: null,
            matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'),
            matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
            teamDetailsModalInstance: null,
            teamDetailsModalTitle: getElement('teamDetailsModalTitleEl'),
            teamDetailsInfoText: getElement('teamDetailsInfoTextEl'),
            teamDetailsInputSection: getElement('teamDetailsInputSectionEl'),
            submitTeamDetailsBtn: getElement('submitTeamDetailsBtnEl'),
            teamDetailsStatusMessage: getElement('teamDetailsStatusMessageEl'),
            idPasswordModalInstance: null,
            roomIdDisplay: getElement('roomIdDisplayEl'),
            roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
            resultClaimModalInstance: null,
            claimTournamentName: getElement('claimTournamentNameEl'),
            prizesList: getElement('prizesListEl'),
            claimStatusMessage: getElement('claimStatusMessageEl'),
            contactUsLink: getElement('contactUsLinkEl'),
            achievementsContainer: getElement('achievementsContainerEl'),
            achievementProgress: getElement('achievementProgressEl'),
            currentVipTierCard: getElement('currentVipTierCard'),
            currentTierName: getElement('currentTierNameEl'),
            currentTierDesc: getElement('currentTierDescEl'),
            tierProgressText: getElement('tierProgressTextEl'),
            vipProgressFill: getElement('vipProgressFillEl'),
            tierProgressHint: getElement('tierProgressHintEl')
        };

        let currentUser = null;
        let userProfile = {};
        let currentSectionId = 'login-section';
        let dbListeners = {};
        let swiperInstance;
        let currentTournamentGameId = null;
        let appSettings = {};
        let unreadNotificationsCount = 0;
        let isAppInitialized = false;
        let retryAttempts = {};
        let cachedData = {
            games: null,
            promotions: null,
            lastFetch: {}
        };

        const CACHE_EXPIRY = 5 * 60 * 1000;
        const MAX_RETRIES = 3;
        const RETRY_DELAY = 3000;

        const defaultTheme = {
            '--primary-bg': '#0F172A',
            '--secondary-bg': '#1E293B',
            '--card-bg': '#1E293B',
            '--text-primary': '#E2E8F0',
            '--text-secondary': '#94A3B8',
            '--accent-color': '#FACC15',
            '--accent-gradient': 'linear-gradient(135deg, #FACC15, #FBBF24)',
            '--primary-button-bg': '#3B82F6',
            '--border-color': '#334155',
            '--bottom-nav-bg': '#1E293B',
            '--success-color': '#10B981',
            '--danger-color': '#EF4444',
            '--warning-color': '#F59E0B',
            '--info-color': '#3B82F6'
        };

        function applyTheme(theme) {
            const root = document.documentElement;
            if (theme && typeof theme === 'object') {
                console.log("ðŸŽ¨ Applying custom theme");
                for (const property in defaultTheme) {
                    if (theme[property]) {
                        root.style.setProperty(property, theme[property]);
                    }
                }
            } else {
                for (const property in defaultTheme) {
                    root.style.removeProperty(property);
                }
            }
        }

        const showLoader = (show) => {
            if (elements.globalLoader) elements.globalLoader.style.display = show ? 'flex' : 'none';
        };

        function showToast(message, type = 'info', duration = 4000) {
            if (!elements.toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;

            let icon = 'bi-info-circle-fill';
            if (type === 'success') icon = 'bi-check-circle-fill';
            else if (type === 'error') icon = 'bi-x-circle-fill';
            else if (type === 'warning') icon = 'bi-exclamation-triangle-fill';

            toast.innerHTML = `
                <i class="bi ${icon}"></i>
                <div class="toast-message">${message}</div>
                <button class="toast-close"><i class="bi bi-x"></i></button>
            `;

            elements.toastContainer.appendChild(toast);

            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', () => removeToast(toast));

            setTimeout(() => removeToast(toast), duration);
        }

        function removeToast(toast) {
            if (!toast) return;
            toast.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }

        function showStatusMessage(element, message, type = 'danger', autohide = true) {
            if (!element) return;
            element.innerHTML = message;
            element.className = `alert alert-${type} mt-3`;
            element.style.display = 'block';
            if (autohide) {
                setTimeout(() => {
                    if (element.innerHTML === message) element.style.display = 'none';
                }, 5000);
            }
        }

        function clearStatusMessage(element) {
            if (!element) return;
            element.style.display = 'none';
            element.innerHTML = '';
        }

        function copyToClipboard(targetSelector) {
    if (!targetSelector) {
        showToast('Copy target not defined', 'error');
        return;
    }
    const targetElement = querySel(targetSelector);
    if (!targetElement) {
        showToast('Element not found', 'error');
        return;
    }
    
    // âœ… FIX: Extract text from element
    const textToCopy = targetElement.textContent.trim();
    
    if (!textToCopy) {
        showToast('Nothing to copy', 'warning');
        return;
    }
    
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy).then(() => showToast('âœ… Copied to clipboard!', 'success')).catch(err => {
            console.error('Copy failed:', err);
            fallbackCopy(textToCopy);
        });
    } else {
        fallbackCopy(textToCopy);
    }
}

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('âœ… Copied to clipboard!', 'success');
                } else {
                    showToast('Failed to copy', 'error');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showToast('Failed to copy', 'error');
            }
            document.body.removeChild(textArea);
        }

        function shareReferral(code) {
            if (!navigator.share) {
                showToast('Sharing not supported on this device. Copy manually.', 'warning');
                return;
            }
            if (!code || code === 'N/A') {
                showToast('Referral code not available', 'warning');
                return;
            }
            navigator.share({
                title: 'Join   Tournament!',
                text: `Use my referral code: ${code}`,
                url: window.location.origin
            }).catch((error) => console.log('Share cancelled', error));
        }

        async function generateReferralCode(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let attempts = 0;
            const maxAttempts = 10;

            while (attempts < maxAttempts) {
                let code = '';
                for (let i = 0; i < length; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }

                const usersRef = ref(db, 'users');
                const q = query(usersRef, orderByChild('referralCode'), equalTo(code));
                const snapshot = await get(q);

                if (!snapshot.exists()) {
                    return code;
                }

                attempts++;
            }

            return chars.substr(0, 6) + Date.now().toString(36).toUpperCase().substr(-2);
        }

        function getTimeRemaining(startTime) {
            if (!startTime) return 'TBA';
            const now = Date.now();
            const diff = startTime - now;
            if (diff <= 0) return 'Starting Soon';
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            let output = '';
            if (days > 0) output += `${days}d `;
            if (hours > 0 || days > 0) output += `${hours}h `;
            output += `${minutes}m`;
            return output.trim() || 'Now';
        }

        const removePlaceholders = (parentElement) => {
            if (!parentElement) return;
            parentElement.classList.remove('placeholder-glow');
            parentElement.querySelectorAll('.placeholder').forEach(el => el.remove());
        };

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

window.togglePassword

        // ========================================
// ðŸ†• SEPARATE PAGES FUNCTIONS
// ========================================

async function loadFriendRequestsPage() {
    console.log("ðŸ“¨ Loading Friend Requests Page");
    
    if (!currentUser) {
        console.log("âš ï¸ User not logged in");
        return;
    }

    const listEl = document.getElementById('friendRequestsPageListEl');
    if (!listEl) {
        console.error("âŒ Friend requests list element not found");
        return;
    }

    // Show loading
    listEl.innerHTML = '<div class="text-center p-4"><div class="spinner-border spinner-border-sm text-accent"></div><p class="mt-2 text-secondary small">Loading friend requests...</p></div>';

    try {
        const requestsRef = ref(db, `friendRequests/${currentUser.uid}`);
        const snapshot = await get(requestsRef);

        listEl.innerHTML = '';

        if (snapshot.exists()) {
            const requests = snapshot.val();
            const pendingRequests = Object.entries(requests)
                .filter(([, req]) => req.status === 'pending')
                .sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));

            console.log(`âœ… Found ${pendingRequests.length} pending requests`);

            if (pendingRequests.length > 0) {
    for (const [reqId, req] of pendingRequests) {
        // Fetch sender's full data
        const senderRef = ref(db, `users/${req.fromUserId}`);
        const senderSnap = await get(senderRef);
        
        let senderData = {
            displayName: req.fromUserName || 'Unknown User',
            photoURL: req.fromUserAvatar || 'https://ui-avatars.com/api/?name=User',
            totalMatches: 0
        };
        
        if (senderSnap.exists()) {
            const userData = senderSnap.val();
            senderData = {
                displayName: userData.displayName || req.fromUserName || 'Unknown User',
                photoURL: userData.photoURL || req.fromUserAvatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(userData.displayName || 'User'),
                totalMatches: userData.totalMatches || 0
            };
        }

        const avatar = senderData.photoURL;
        const tier = getUserBadgeTier(senderData.totalMatches);
        const badge = createBadgeHTML(tier, 'small');

        const requestCard = document.createElement('div');
        requestCard.className = 'custom-card mb-3';
        requestCard.style.cssText = 'padding: 15px; display: flex; align-items: center; gap: 15px;';

        requestCard.innerHTML = `
            <img src="${avatar}" alt="${senderData.displayName}" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--accent-color); object-fit: cover;" onerror="this.src='https://ui-avatars.com/api/?name=User'">
            <div style="flex: 1;">
                <h5 style="margin: 0 0 5px 0; font-weight: 700; color: var(--text-primary);">${senderData.displayName}${badge}</h5>
                <p style="margin: 0; color: var(--text-secondary); font-size: 0.85rem;">
                    <i class="bi bi-trophy-fill"></i> ${senderData.totalMatches} matches
                </p>
                <p style="margin: 5px 0 0 0; color: var(--text-secondary); font-size: 0.75rem;">
                    ${new Date(req.timestamp).toLocaleDateString()}
                </p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button class="btn btn-sm btn-custom-accent ripple accept-request-btn" data-request-id="${reqId}" data-user-id="${req.fromUserId}" style="padding: 8px 20px; font-size: 0.85rem; white-space: nowrap;">
                    <i class="bi bi-check-circle"></i> Accept
                </button>
                <button class="btn btn-sm btn-custom-secondary ripple reject-request-btn" data-request-id="${reqId}" style="padding: 8px 20px; font-size: 0.85rem; white-space: nowrap;">
                    <i class="bi bi-x-circle"></i> Reject
                </button>
            </div>
        `;

        const acceptBtn = requestCard.querySelector('.accept-request-btn');
        acceptBtn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const reqId = this.dataset.requestId;
            const userId = this.dataset.userId;
            
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            await acceptFriendRequestPage(reqId, userId);
        });

        const rejectBtn = requestCard.querySelector('.reject-request-btn');
        rejectBtn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const reqId = this.dataset.requestId;
            
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            await rejectFriendRequestPage(reqId);
        });

        listEl.appendChild(requestCard);
    }
} else {
    // âœ… IMPROVED EMPTY STATE
    listEl.innerHTML = `
        <div class="empty-state" style="text-align: center; padding: 60px 20px;">
            <i class="bi bi-inbox empty-state-icon" style="font-size: 4rem; color: var(--text-secondary); opacity: 0.5;"></i>
            <div class="empty-state-title" style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin: 20px 0 10px 0;">
                No Friend Requests Yet
            </div>
            <div class="empty-state-text" style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
                You haven't received any friend requests yet.<br>
                Search for friends and start connecting!
            </div>
            <button class="btn btn-custom btn-custom-accent mt-3 ripple" onclick="showSection('find-friends-section'); setupFindFriendsPage();">
                <i class="bi bi-search"></i> Find Friends
            </button>
        </div>
    `;
}
        } else {
            listEl.innerHTML = '<div class="empty-state"><i class="bi bi-inbox empty-state-icon"></i><div class="empty-state-title">No Friend Requests</div><div class="empty-state-text">You haven\'t received any friend requests yet</div></div>';
        }
    } catch (error) {
        console.error('âŒ Error loading friend requests:', error);
        listEl.innerHTML = `<p class="text-danger text-center">Error: ${error.message}<br><small>Please try again</small></p>`;
    }
}

// ========================================
// ðŸ† ACHIEVEMENTS & BADGES SYSTEM
// ========================================

async function loadAchievements() {
    console.log("ðŸ† Loading Achievements");
    
    if (!currentUser) {
        console.log("âš ï¸ User not logged in");
        return;
    }
    
    const achievementsListEl = document.getElementById('achievementsListEl');
    const noAchievementsEl = document.getElementById('noAchievementsMessageEl');
    
    if (!achievementsListEl) return;
    
    achievementsListEl.classList.add('placeholder-glow');
    achievementsListEl.innerHTML = `<div class="achievement-card placeholder-glow mb-3"><div class="achievement-icon"><span class="placeholder" style="width: 60px; height: 60px; border-radius: 50%; display: inline-block;"></span></div><div class="achievement-content" style="flex: 1;"><div class="achievement-title"><span class="placeholder col-8" style="height: 18px;"></span></div></div></div>`.repeat(3);
    if (noAchievementsEl) noAchievementsEl.style.display = 'none';
    
    try {
        // Load achievements from database
        const achievementsRef = ref(db, 'achievements');
        const snapshot = await get(achievementsRef);
        
        // Load user's progress
        const userProgressRef = ref(db, `achievementProgress/${currentUser.uid}`);
        const progressSnapshot = await get(userProgressRef);
        const userProgress = progressSnapshot.exists() ? progressSnapshot.val() : {};
        
        removePlaceholders(achievementsListEl);
        achievementsListEl.innerHTML = '';
        
        if (snapshot.exists()) {
            const achievements = snapshot.val();
            const achievementsArray = Object.entries(achievements)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => (a.order || 0) - (b.order || 0));
            
            console.log(`âœ… Found ${achievementsArray.length} achievements`);
            
            if (achievementsArray.length > 0) {
                for (const achievement of achievementsArray) {
                    const progress = userProgress[achievement.id] || { current: 0, completed: false, claimed: false };
                    const progressPercent = achievement.target ? Math.min((progress.current / achievement.target) * 100, 100) : 0;
                    
                    const achievementCard = document.createElement('div');
                    achievementCard.className = `achievement-card ${progress.completed ? 'completed' : 'locked'}`;
                    
                    const iconHTML = achievement.badgeURL ? 
                        `<img src="${achievement.badgeURL}" alt="${achievement.achievementName}">` : 
                        '<i class="bi bi-trophy-fill"></i>';
                    
                    achievementCard.innerHTML = `
                        <div class="achievement-icon ${progress.completed ? 'completed' : 'locked'}">
                            ${iconHTML}
                        </div>
                        <div class="achievement-content">
                            <div class="achievement-title">${achievement.achievementName || 'Achievement'}</div>
                            <div class="achievement-description">${achievement.achievementDetails || 'Complete this challenge'}</div>
                            <div class="achievement-progress">
                                <div class="achievement-progress-bar">
                                    <div class="achievement-progress-fill" style="width: ${progressPercent}%;"></div>
                                </div>
                                <span class="achievement-progress-text">${Math.round(progressPercent)}%</span>
                            </div>
                            <div class="achievement-actions">
                                <button class="btn btn-sm btn-custom-secondary ripple view-achievement-details" data-achievement-id="${achievement.id}">
                                    <i class="bi bi-info-circle"></i> Details
                                </button>
                                ${progress.completed && !progress.claimed ? 
                                    `<button class="btn btn-sm btn-custom-accent ripple claim-achievement" data-achievement-id="${achievement.id}">
                                        <i class="bi bi-gift-fill"></i> Claim
                                    </button>` : 
                                    progress.claimed ? 
                                    `<span class="badge bg-success">âœ“ Claimed</span>` : 
                                    `<span class="badge bg-secondary">Locked</span>`
                                }
                            </div>
                        </div>
                        <div class="achievement-reward">
                            ${achievement.reward ? `â‚¹${achievement.reward}` : 'Badge'}
                        </div>
                    `;
                    
                    achievementsListEl.appendChild(achievementCard);
                }
                
                // âœ… FIX: Add event listeners CORRECTLY - Details button
                document.querySelectorAll('.view-achievement-details').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const achievementId = btn.dataset.achievementId;
                        console.log("ðŸ” Opening achievement details:", achievementId);
                        showAchievementDetails(achievementId);
                    });
                });
                
                // âœ… FIX: Add event listeners for CLAIM buttons
                document.querySelectorAll('.claim-achievement').forEach(btn => {
                    btn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const achievementId = this.dataset.achievementId;
                        
                        if (!achievementId) {
                            console.error("âŒ No achievement ID found");
                            showToast('Error: Achievement ID missing', 'error');
                            return;
                        }
                        
                        console.log("ðŸŽ Claim button clicked for:", achievementId);
                        
                        // Disable button immediately
                        this.disabled = true;
                        const originalHTML = this.innerHTML;
                        this.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Claiming...';
                        
                        try {
                            await claimAchievement(achievementId);
                        } catch (error) {
                            console.error("âŒ Claim failed:", error);
                            this.disabled = false;
                            this.innerHTML = originalHTML;
                            showToast('Failed to claim: ' + error.message, 'error');
                        }
                    });
                });
                
                console.log("âœ… Achievement event listeners attached");
                
            } else {
                if (noAchievementsEl) noAchievementsEl.style.display = 'block';
            }
        } else {
            if (noAchievementsEl) noAchievementsEl.style.display = 'block';
        }
        
    } catch (error) {
        console.error("âŒ Load achievements error:", error);
        removePlaceholders(achievementsListEl);
        achievementsListEl.innerHTML = '<p class="text-danger text-center">Error loading achievements</p>';
    }
}

async function showAchievementDetails(achievementId) {
    if (!achievementId) return;
    
    const modalEl = document.getElementById('achievementDetailsModalEl');
    if (!modalEl) return;
    
    const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
    
    try {
        // Load achievement data
        const achievementRef = ref(db, `achievements/${achievementId}`);
        const snapshot = await get(achievementRef);
        
        if (!snapshot.exists()) {
            showToast('Achievement not found', 'error');
            return;
        }
        
        const achievement = snapshot.val();
        
        // Load user progress
        const progressRef = ref(db, `achievementProgress/${currentUser.uid}/${achievementId}`);
        const progressSnapshot = await get(progressRef);
        const progress = progressSnapshot.exists() ? progressSnapshot.val() : { current: 0, completed: false };
        
        const progressPercent = achievement.target ? Math.min((progress.current / achievement.target) * 100, 100) : 0;
        
        // Update modal content
        document.getElementById('detailsAchievementNameEl').textContent = achievement.achievementName || 'Achievement';
        document.getElementById('detailsAchievementDetailsEl').textContent = achievement.achievementDetails || 'Complete this challenge';
        document.getElementById('detailsAchievementRewardEl').textContent = `â‚¹${achievement.reward || 0} + ${achievement.achievementName} Badge`;
        document.getElementById('detailsProgressTextEl').textContent = `${Math.round(progressPercent)}%`;
        document.getElementById('detailsProgressFillEl').style.width = `${progressPercent}%`;
        
        const badgeIcon = document.getElementById('detailsBadgeIconEl');
        if (badgeIcon && achievement.badgeURL) {
            badgeIcon.querySelector('img').src = achievement.badgeURL;
        }
        
        modalInstance.show();
        
    } catch (error) {
        console.error("âŒ Show achievement details error:", error);
        showToast('Error loading details', 'error');
    }
}

async function claimAchievement(achievementId) {
    if (!currentUser || !achievementId) {
        console.error("âŒ Invalid parameters:", { currentUser, achievementId });
        return;
    }
    
    console.log("ðŸŽ Claiming achievement:", achievementId);
    
    showLoader(true);
    
    try {
        // Load achievement data
        const achievementRef = ref(db, `achievements/${achievementId}`);
        const snapshot = await get(achievementRef);
        
        if (!snapshot.exists()) {
            throw new Error('Achievement not found');
        }
        
        const achievement = snapshot.val();
        console.log("âœ… Achievement data loaded:", achievement);
        
        // Check if already claimed
        const progressRef = ref(db, `achievementProgress/${currentUser.uid}/${achievementId}`);
        const progressSnapshot = await get(progressRef);
        const progress = progressSnapshot.exists() ? progressSnapshot.val() : {};
        
        if (progress.claimed) {
            showToast('Already claimed this achievement', 'warning');
            showLoader(false);
            return;
        }
        
        if (!progress.completed) {
            showToast('Achievement not completed yet', 'warning');
            showLoader(false);
            return;
        }
        
        // Add reward to user balance
        const userRef = ref(db, `users/${currentUser.uid}`);
        const updateResult = await runTransaction(userRef, (userData) => {
            if (userData) {
                userData.bonusCash = (userData.bonusCash || 0) + (achievement.reward || 0);
                
                // Add badge to user's badges collection
                if (!userData.earnedBadges) userData.earnedBadges = {};
                userData.earnedBadges[achievementId] = {
                    badgeName: achievement.achievementName,
                    badgeURL: achievement.badgeURL || null,
                    earnedAt: Date.now()
                };
            }
            return userData;
        });
        
        if (!updateResult.committed) {
            throw new Error("Failed to update user balance");
        }
        
        console.log("âœ… Balance updated successfully");
        
        // Mark as claimed
        await update(progressRef, { 
            claimed: true, 
            claimedAt: Date.now() 
        });
        
        console.log("âœ… Achievement marked as claimed");
        
        // Record transaction
        await recordTransaction(
            currentUser.uid,
            'achievement_reward',
            achievement.reward || 0,
            `Achievement Reward: ${achievement.achievementName}`,
            'bonusCash'
        );
        
        console.log("âœ… Transaction recorded");
        
        showLoader(false);
        
        // Show congratulations modal
        showCongratulationsModal(achievement);
        
        // Reload achievements list after 2 seconds
        setTimeout(() => {
            loadAchievements();
        }, 2000);
        
        console.log("âœ… Achievement claimed successfully");
        
    } catch (error) {
        console.error("âŒ Claim achievement error:", error);
        showLoader(false);
        showToast(`Error: ${error.message}`, 'error');
        
        // Reload achievements to reset button state
        loadAchievements();
    }
}

function showCongratulationsModal(achievement) {
    const modalEl = document.getElementById('congratsModalEl');
    if (!modalEl) {
        console.error("âŒ Congrats modal not found");
        return;
    }
    
    console.log("ðŸŽ‰ Showing congratulations modal for:", achievement.achievementName);
    
    const badgeEl = document.getElementById('congratsBadgeEl');
    const messageEl = document.getElementById('congratsMessageEl');
    const rewardEl = document.getElementById('congratsRewardEl');
    
    if (badgeEl && achievement.badgeURL) {
        badgeEl.querySelector('img').src = achievement.badgeURL;
    }
    
    if (messageEl) {
        messageEl.textContent = `You've completed "${achievement.achievementName}"!`;
    }
    
    if (rewardEl) {
        rewardEl.textContent = `+â‚¹${achievement.reward || 0}`;
    }
    
    modalEl.classList.add('active');
    
    // Add confetti effect (optional)
    createConfetti();
}

function createConfetti() {
    const colors = ['#FACC15', '#3B82F6', '#10B981', '#EF4444', '#8B5CF6'];
    const confettiCount = 50;
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        const tx = (Math.random() * 200 - 100);
        const rot = (Math.random() * 720);
        
        confetti.style.cssText = `
            position: fixed;
            width: 10px;
            height: 10px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            top: -10px;
            left: ${Math.random() * 100}%;
            opacity: 1;
            transform: rotate(${Math.random() * 360}deg);
            z-index: 10004;
            pointer-events: none;
            --tx: ${tx}px;
            --rot: ${rot}deg;
            animation: confettiFall ${2 + Math.random() * 2}s linear forwards;
        `;
        
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 4000);
    }
}

// Add confetti animation to CSS (will be added in next step)

async function loadMyBadges() {
    console.log("ðŸŽ–ï¸ Loading My Badges");
    
    if (!currentUser) {
        console.log("âš ï¸ User not logged in");
        return;
    }
    
    const badgesGridEl = document.getElementById('badgesGridEl');
    const noBadgesEl = document.getElementById('noBadgesMessageEl');
    const activeBadgeDisplayEl = document.getElementById('activeBadgeDisplayEl');
    const activeBadgeNameEl = document.getElementById('activeBadgeNameEl');
    
    if (!badgesGridEl) return;
    
    // âœ… FIX: Clear completely before loading
    badgesGridEl.innerHTML = '';
    badgesGridEl.classList.add('placeholder-glow');
    
    // Add placeholder
    for (let i = 0; i < 3; i++) {
        const placeholderCol = document.createElement('div');
        placeholderCol.className = 'col-6 col-md-4';
        placeholderCol.innerHTML = `
            <div class="badge-card">
                <div class="badge-icon">
                    <span class="placeholder" style="width: 80px; height: 80px; border-radius: 50%; display: inline-block;"></span>
                </div>
            </div>
        `;
        badgesGridEl.appendChild(placeholderCol);
    }
    
    if (noBadgesEl) noBadgesEl.style.display = 'none';
    
    try {
        const userRef = ref(db, `users/${currentUser.uid}`);
        const snapshot = await get(userRef);
        
        if (!snapshot.exists()) {
            throw new Error("User data not found");
        }
        
        const userData = snapshot.val();
        const earnedBadges = userData.earnedBadges || {};
        
        // âœ… FIX: Clear again before rendering
        removePlaceholders(badgesGridEl);
        badgesGridEl.innerHTML = '';
        
        // Update active badge display
        const currentPhotoURL = userData.photoURL || 'https://ui-avatars.com/api/?name=No+Badge&background=334155&color=94A3B8&size=100';
        
        if (activeBadgeDisplayEl) {
            const img = activeBadgeDisplayEl.querySelector('img');
            if (img) img.src = currentPhotoURL;
        }
        
        let activeBadgeName = 'No Badge Equipped';
        for (const [badgeId, badge] of Object.entries(earnedBadges)) {
            if (badge.badgeURL === currentPhotoURL) {
                activeBadgeName = badge.badgeName || 'Active Badge';
                break;
            }
        }
        
        if (activeBadgeNameEl) {
            activeBadgeNameEl.textContent = activeBadgeName;
        }
        
        const badgesArray = Object.entries(earnedBadges);
        
        console.log(`âœ… Found ${badgesArray.length} badges`);
        
        if (badgesArray.length > 0) {
            for (const [badgeId, badge] of badgesArray) {
                const isActive = currentPhotoURL === badge.badgeURL;
                
                const badgeCard = document.createElement('div');
                badgeCard.className = 'col-6 col-md-4';
                
                badgeCard.innerHTML = `
                    <div class="badge-card ${isActive ? 'active' : ''}" data-badge-id="${badgeId}" style="position: relative; cursor: pointer;">
                        <div class="badge-icon">
                            <img src="${badge.badgeURL || 'https://ui-avatars.com/api/?name=Badge&background=334155&color=94A3B8&size=80'}" alt="${badge.badgeName}">
                        </div>
                        <div class="badge-name">${badge.badgeName || 'Badge'}</div>
                        <div class="badge-description">
                            ${badge.earnedAt ? new Date(badge.earnedAt).toLocaleDateString() : 'Earned'}
                        </div>
                    </div>
                `;
                
                badgesGridEl.appendChild(badgeCard);
            }
            
            // âœ… FIX: Add click listeners ONCE
            setTimeout(() => {
                document.querySelectorAll('.badge-card').forEach(card => {
                    card.addEventListener('click', async function(e) {
                        e.stopPropagation(); // Prevent double clicks
                        
                        const badgeId = this.dataset.badgeId;
                        const badgeImg = this.querySelector('.badge-icon img');
                        
                        if (badgeImg && !this.classList.contains('processing')) {
                            this.classList.add('processing'); // Prevent double processing
                            const badgeURL = badgeImg.src;
                            await updateProfileAvatar(badgeURL, badgeId);
                            this.classList.remove('processing');
                        }
                    }, { once: false }); // Allow multiple clicks but prevent doubles
                });
            }, 100);
            
        } else {
            if (noBadgesEl) noBadgesEl.style.display = 'block';
        }
        
    } catch (error) {
        console.error("âŒ Load badges error:", error);
        removePlaceholders(badgesGridEl);
        badgesGridEl.innerHTML = '<div class="col-12"><p class="text-danger text-center">Error loading badges</p></div>';
    }
}

async function equipBadge(badgeId) {
    if (!currentUser || !badgeId) return;
    
    try {
        const userRef = ref(db, `users/${currentUser.uid}`);
        await update(userRef, { activeBadge: badgeId });
        
        showToast('âœ… Badge equipped successfully!', 'success');
        
        // Reload badges
        loadMyBadges();
        
        console.log("âœ… Badge equipped:", badgeId);
        
    } catch (error) {
        console.error("âŒ Equip badge error:", error);
        showToast(`Error: ${error.message}`, 'error');
    }
}

async function updateProfileAvatar(badgeURL, badgeId) {
    if (!currentUser || !badgeURL) return;
    
    if (!confirm('Set this badge as your profile avatar?')) {
        return;
    }
    
    showLoader(true);
    
    try {
        const userRef = ref(db, `users/${currentUser.uid}`);
        await update(userRef, { 
            photoURL: badgeURL,
            activeBadge: badgeId // Track which badge is active
        });
        
        // Update profile avatar display
        const profileAvatar = document.getElementById('profileAvatarEl');
        if (profileAvatar) {
            profileAvatar.src = badgeURL;
        }
        
        // Update header avatar if exists
        const headerAvatar = document.querySelector('.header-avatar');
        if (headerAvatar) {
            headerAvatar.src = badgeURL;
        }
        
        showToast('âœ… Badge set as profile avatar!', 'success');
        console.log("âœ… Profile avatar updated with badge:", badgeId);
        
        // Reload badges to show active badge
        loadMyBadges();
        
    } catch (error) {
        console.error("âŒ Avatar update error:", error);
        showToast(`Error: ${error.message}`, 'error');
    } finally {
        showLoader(false);
    }
}

// Update achievement progress (called after tournaments)
async function updateAchievementProgress(achievementType, incrementValue = 1, tournamentData = null) {
    if (!currentUser) return;
    
    try {
        const achievementsRef = ref(db, 'achievements');
        const snapshot = await get(achievementsRef);
        
        if (!snapshot.exists()) return;
        
        const achievements = snapshot.val();
        
        // Find matching achievements
        for (const [achievementId, achievement] of Object.entries(achievements)) {
            if (achievement.type === achievementType) {
                const progressRef = ref(db, `achievementProgress/${currentUser.uid}/${achievementId}`);
                
                await runTransaction(progressRef, (progressData) => {
                    if (!progressData) {
                        progressData = { current: 0, completed: false, claimed: false };
                    }
                    
                    if (!progressData.completed) {
                        // Special handling for different achievement types
                        if (achievementType === 'quick_join' && tournamentData) {
                            // Check if joined within 2 minutes of tournament creation
                            const timeDiff = Date.now() - (tournamentData.createdAt || 0);
                            if (timeDiff <= 120000) { // 2 minutes = 120000ms
                                progressData.current = 1;
                                progressData.completed = true;
                                progressData.completedAt = Date.now();
                            }
                        } else if (achievementType === 'top3_streak' || achievementType === 'daily_streak') {
                            // Handle streaks
                            progressData.current = incrementValue;
                            if (progressData.current >= achievement.target) {
                                progressData.completed = true;
                                progressData.completedAt = Date.now();
                            }
                        } else {
                            // Normal increment
                            progressData.current = (progressData.current || 0) + incrementValue;
                            
                            if (progressData.current >= achievement.target) {
                                progressData.completed = true;
                                progressData.completedAt = Date.now();
                            }
                        }
                        
                        // Send notification if completed
                        if (progressData.completed && !progressData.notified) {
                            progressData.notified = true;
                            sendNotification(
                                currentUser.uid,
                                'Achievement Unlocked! ðŸ†',
                                `You've completed "${achievement.achievementName}"! Claim your reward now.`
                            );
                        }
                    }
                    
                    return progressData;
                });
            }
        }
        
    } catch (error) {
        console.error("âŒ Update achievement progress error:", error);
    }
}

// ========================================
// ðŸ†• END ACHIEVEMENTS & BADGES SYSTEM
// ========================================

async function acceptFriendRequestPage(requestId, fromUserId) {
    if (!currentUser) return;

    try {
        const updates = {};
        updates[`friends/${currentUser.uid}/${fromUserId}`] = {
            status: 'accepted',
            timestamp: Date.now()
        };
        updates[`friends/${fromUserId}/${currentUser.uid}`] = {
            status: 'accepted',
            timestamp: Date.now()
        };
        updates[`friendRequests/${currentUser.uid}/${requestId}/status`] = 'accepted';

        await update(ref(db), updates);
        await sendNotification(fromUserId, 'Friend Request Accepted', `${userProfile.displayName || currentUser.email} accepted your friend request!`);

        showToast('âœ… Friend request accepted!', 'success');
        loadFriendRequestsPage();
        loadSocialsPageData();

    } catch (error) {
        console.error('âŒ Error:', error);
        showToast(`Failed: ${error.message}`, 'error');
    }
}

async function rejectFriendRequestPage(requestId) {
    if (!currentUser) return;

    try {
        const requestRef = ref(db, `friendRequests/${currentUser.uid}/${requestId}`);
        await update(requestRef, { status: 'rejected' });

        showToast('Request rejected', 'info');
        loadFriendRequestsPage();
        loadSocialsPageData();

    } catch (error) {
        console.error('âŒ Error:', error);
        showToast(`Failed: ${error.message}`, 'error');
    }
}

async function loadMyFriendsPage() {
    if (!currentUser) return;

    const listEl = document.getElementById('myFriendsPageListEl');
    if (!listEl) {
        console.error("âŒ My friends list element not found");
        return;
    }

    listEl.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div><p class="mt-2 text-secondary small">Loading friends...</p></div>';

    try {
        const friendsRef = ref(db, `friends/${currentUser.uid}`);
        const snapshot = await get(friendsRef);

        listEl.innerHTML = '';

        if (snapshot.exists()) {
            const friends = snapshot.val();
            const acceptedFriends = Object.entries(friends).filter(([, f]) => f.status === 'accepted');

            console.log(`âœ… Found ${acceptedFriends.length} friends`);

            if (acceptedFriends.length > 0) {
                for (const [friendId] of acceptedFriends) {
                    const friendRef = ref(db, `users/${friendId}`);
                    const friendSnap = await get(friendRef);

                    if (friendSnap.exists()) {
                        const friendData = friendSnap.val();
                        const avatar = friendData.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(friendData.displayName || 'User');

                        const matches = friendData.totalMatches || 0;
                        const tier = getUserBadgeTier(matches);
                        const badge = createBadgeHTML(tier, 'small');

                        const friendCard = document.createElement('div');
                        friendCard.className = 'custom-card mb-3';
                        friendCard.style.cssText = 'padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer;';

                        friendCard.innerHTML = `
                            <img src="${avatar}" alt="${friendData.displayName}" class="friend-avatar" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--accent-color); object-fit: cover;" onerror="this.src='https://ui-avatars.com/api/?name=User'">
                            <div style="flex: 1;" class="friend-info">
                                <h5 style="margin: 0 0 5px 0; font-weight: 700; color: var(--text-primary);">${friendData.displayName || 'Unknown'}${badge}</h5>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.85rem;">
                                    <i class="bi bi-trophy-fill"></i> ${matches} matches
                                </p>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button class="btn btn-sm btn-custom-primary ripple chat-friend-btn" data-friend-id="${friendId}" data-friend-name="${friendData.displayName || 'User'}" style="padding: 8px 20px; font-size: 0.85rem; white-space: nowrap;">
                                    <i class="bi bi-chat-dots-fill"></i> Chat
                                </button>
                                <button class="btn btn-sm btn-custom-secondary ripple remove-friend-btn" data-friend-id="${friendId}" data-friend-name="${friendData.displayName || 'User'}" style="padding: 8px 20px; font-size: 0.85rem; white-space: nowrap;">
                                    <i class="bi bi-person-x"></i> Remove
                                </button>
                            </div>
                        `;

                        // Click on avatar/name to view profile
                        const avatarEl = friendCard.querySelector('.friend-avatar');
                        const infoEl = friendCard.querySelector('.friend-info');
                        
                        const viewProfile = () => {
                            openUserProfileModal({
                                uid: friendId,
                                displayName: friendData.displayName || 'Unknown',
                                photoURL: avatar,
                                totalMatches: matches,
                                wonMatches: friendData.wonMatches || 0,
                                totalBalance: (friendData.winningCash || 0) + (friendData.cashBalance || 0) + (friendData.bonusCash || 0),
                                totalEarnings: friendData.totalEarnings || 0
                            });
                        };

                        avatarEl.addEventListener('click', viewProfile);
                        infoEl.addEventListener('click', viewProfile);

                        // Chat button listener
                        const chatBtn = friendCard.querySelector('.chat-friend-btn');
                        chatBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const friendId = this.dataset.friendId;
                            const friendName = this.dataset.friendName;
                            openChatWithFriend(friendId, friendName);
                        });

                        // Remove button listener
                        const removeBtn = friendCard.querySelector('.remove-friend-btn');
                        removeBtn.addEventListener('click', async function(e) {
                            e.stopPropagation();
                            const friendId = this.dataset.friendId;
                            const friendName = this.dataset.friendName;
                            await removeFriendPage(friendId, friendName);
                        });

                        listEl.appendChild(friendCard);
                    }
                }
            } else {
                ras
            }
        } else {
            listEl.innerHTML = '<div class="empty-state"><i class="bi bi-people empty-state-icon"></i><div class="empty-state-title">No Friends Yet</div><div class="empty-state-text">Start searching and adding friends!</div></div>';
        }
    } catch (error) {
        console.error('âŒ Error loading friends:', error);
        listEl.innerHTML = '<p class="text-danger text-center">Error loading friends. Please try again.</p>';
    }
}

function openChatWithFriend(friendId, friendName) {
    showToast(`ðŸ’¬ Private chat with ${friendName} coming soon!`, 'info', 3000);
}

async function removeFriendPage(friendId, friendName) {
    if (!confirm(`Remove ${friendName} from friends?`)) return;

    try {
        const updates = {};
        updates[`friends/${currentUser.uid}/${friendId}`] = null;
        updates[`friends/${friendId}/${currentUser.uid}`] = null;

        await update(ref(db), updates);
        showToast('Friend removed', 'info');
        loadMyFriendsPage();
        loadSocialsPageData();

    } catch (error) {
        console.error('âŒ Error:', error);
        showToast(`Failed: ${error.message}`, 'error');
    }
}

function setupFindFriendsPage() {
    const searchInput = document.getElementById('findFriendsSearchInputEl');
    const resultsEl = document.getElementById('findFriendsResultsEl');

    if (!searchInput || !resultsEl) {
        console.error("âŒ Search elements not found");
        return;
    }

    searchInput.value = '';
    
    // âœ… IMPROVED INITIAL STATE WITH SEARCH BUTTON
    resultsEl.innerHTML = `
        <div class="text-center p-4" style="background: rgba(30, 41, 59, 0.5); border-radius: 12px; margin-top: 15px;">
            <i class="bi bi-search" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i>
            <p class="mt-3 mb-2 text-secondary small">Enter username or email to find friends</p>
            <button class="btn btn-custom btn-custom-accent btn-sm ripple mt-2" id="triggerSearchBtn" style="padding: 8px 20px;">
                <i class="bi bi-search"></i> Search
            </button>
        </div>
    `;

    let searchTimeout;
    
    const performSearch = () => {
        const query = searchInput.value.trim().toLowerCase();

        if (query.length < 2) {
            resultsEl.innerHTML = `
                <div class="text-center p-4" style="background: rgba(30, 41, 59, 0.5); border-radius: 12px; margin-top: 15px;">
                    <i class="bi bi-search" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i>
                    <p class="mt-3 mb-2 text-secondary small">Please enter at least 2 characters</p>
                    <button class="btn btn-custom btn-custom-accent btn-sm ripple mt-2" id="triggerSearchBtn" style="padding: 8px 20px;">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            `;
            
            // Re-attach button listener
            setTimeout(() => {
                const searchBtn = document.getElementById('triggerSearchBtn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', performSearch);
                }
            }, 100);
            return;
        }

        resultsEl.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div><p class="mt-2 text-secondary small">Searching...</p></div>';

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            await searchFriendsPage(query);
        }, 500);
    };

    // Enter key listener
    searchInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    // âœ… SEARCH BUTTON LISTENER
    setTimeout(() => {
        const searchBtn = document.getElementById('triggerSearchBtn');
        if (searchBtn) {
            searchBtn.addEventListener('click', performSearch);
        }
    }, 100);

    console.log("âœ… Find Friends search setup complete with button");
}

async function searchFriendsPage(query) {
    console.log("ðŸ” Searching friends:", query);
    
    if (!currentUser) return;

    const resultsEl = document.getElementById('findFriendsResultsEl');
    if (!resultsEl) {
        console.error("âŒ Results element not found");
        return;
    }

    try {
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);

        resultsEl.innerHTML = '';

        if (snapshot.exists()) {
            const users = snapshot.val();
            const matched = Object.entries(users)
                .filter(([uid, data]) => {
                    if (uid === currentUser.uid) return false; // Exclude self
                    
                    const name = (data.displayName || '').toLowerCase();
                    const email = (data.email || '').toLowerCase();
                    const uid_lower = uid.toLowerCase();
                    
                    return name.includes(query) || 
                           email.includes(query) || 
                           uid_lower.includes(query);
                })
                .slice(0, 15);

            console.log(`âœ… Found ${matched.length} matching users`);

            if (matched.length > 0) {
                for (const [userId, userData] of matched) {
                    // Check if already friends
                    const friendsRef = ref(db, `friends/${currentUser.uid}/${userId}`);
                    const friendSnap = await get(friendsRef);
                    const isFriend = friendSnap.exists();

                    // Check if request already sent
                    const requestsRef = ref(db, `friendRequests/${userId}`);
                    const reqSnap = await get(requestsRef);
                    let requestSent = false;
                    if (reqSnap.exists()) {
                        const reqs = reqSnap.val();
                        requestSent = Object.values(reqs).some(r => 
                            r.fromUserId === currentUser.uid && r.status === 'pending'
                        );
                    }

                    const avatar = userData.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(userData.displayName || 'User');
                    const tier = getUserBadgeTier(userData.totalMatches || 0);
                    const badge = createBadgeHTML(tier, 'small');

                    let actionBtn = '';
                    if (isFriend) {
                        actionBtn = '<span class="badge bg-success" style="padding: 8px 16px; font-size: 0.85rem;">âœ“ Friends</span>';
                    } else if (requestSent) {
                        actionBtn = '<span class="badge bg-warning" style="padding: 8px 16px; font-size: 0.85rem;">â³ Sent</span>';
                    } else {
                        actionBtn = `<button class="btn btn-sm btn-custom-accent ripple send-request-btn" data-user-id="${userId}" data-user-name="${userData.displayName || 'User'}" style="padding: 8px 16px; font-size: 0.85rem;"><i class="bi bi-person-plus-fill"></i> Add</button>`;
                    }

                    const userCard = document.createElement('div');
                    userCard.className = 'custom-card mb-3';
                    userCard.style.cssText = 'padding: 15px; display: flex; align-items: center; gap: 15px;';

                    userCard.innerHTML = `
                        <img src="${avatar}" alt="${userData.displayName}" class="user-avatar" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--accent-color); object-fit: cover; cursor: pointer;" onerror="this.src='https://ui-avatars.com/api/?name=User'">
                        <div style="flex: 1;" class="user-info" style="cursor: pointer;">
                            <h5 style="margin: 0 0 5px 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">${userData.displayName || 'Unknown User'}${badge}</h5>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">
                                <i class="bi bi-trophy-fill"></i> ${userData.totalMatches || 0} matches
                            </p>
                        </div>
                        ${actionBtn}
                    `;

                    // View profile on click
                    const avatarEl = userCard.querySelector('.user-avatar');
                    const infoEl = userCard.querySelector('.user-info');
                    
                    const viewProfile = () => {
                        openUserProfileModal({
                            uid: userId,
                            displayName: userData.displayName || 'Unknown User',
                            photoURL: avatar,
                            totalMatches: userData.totalMatches || 0,
                            wonMatches: userData.wonMatches || 0,
                            totalBalance: (userData.winningCash || 0) + (userData.cashBalance || 0) + (userData.bonusCash || 0),
                            totalEarnings: userData.totalEarnings || 0
                        });
                    };

                    avatarEl.addEventListener('click', viewProfile);
                    infoEl.addEventListener('click', viewProfile);

                    // Send request button
                    const sendBtn = userCard.querySelector('.send-request-btn');
                    if (sendBtn) {
                        sendBtn.addEventListener('click', async function(e) {
                            e.stopPropagation();
                            
                            this.disabled = true;
                            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                            
                            const userId = this.dataset.userId;
                            const userName = this.dataset.userName;
                            await sendFriendRequestTo(userId, userName);
                            
                            // Refresh search results
                            await searchFriendsPage(query);
                        });
                    }

                    resultsEl.appendChild(userCard);
                }
            } else {
                resultsEl.innerHTML = '<div class="empty-state"><i class="bi bi-search empty-state-icon"></i><div class="empty-state-title">No Results</div><div class="empty-state-text">No users found matching your search</div></div>';
            }
        } else {
            resultsEl.innerHTML = '<p class="text-secondary text-center">No users found</p>';
        }
    } catch (error) {
        console.error('âŒ Error searching:', error);
        resultsEl.innerHTML = `<p class="text-danger text-center">Error: ${error.message}</p>`;
    }
}

        window.togglePassword = function(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            }
        };

        window.showSection = function(sectionId) {
            if (!sectionId || !elements.sections) {
                console.error("Cannot show section", sectionId);
                return;
            }

            const targetSection = getElement(sectionId);
            if (!targetSection) {
                console.error(`Section element "${sectionId}" not found.`);
                return;
            }

            const protectedSections = [
                'home-section', 'wallet-section', 'leaderboard-section', 'earnings-section',
                'profile-section', 'tournaments-section', 'notifications-section',
                'transaction-history-section', 'chat-section', 'withdraw-history-section',
                'match-history-section', 'edit-nickname-section', 'redeem-coupon-section',
                'send-feedback-section', 'change-password-section'
            ];
            const isLoggedIn = !!currentUser;

            if (protectedSections.includes(sectionId) && !isLoggedIn) {
                console.log("ðŸ”’ Protected section - redirecting to login");
                sectionId = 'login-section';
                const loginSection = getElement('login-section');
                if (!loginSection) return;

                elements.sections.forEach(sec => sec.classList.remove('active'));
                loginSection.classList.add('active');
                currentSectionId = 'login-section';
                return;
            }

            if (sectionId === 'login-section' && isLoggedIn) {
                sectionId = 'home-section';
                const homeSection = getElement('home-section');
                if (!homeSection) return;

                elements.sections.forEach(sec => sec.classList.remove('active'));
                homeSection.classList.add('active');
                currentSectionId = 'home-section';
                return;
            }

            elements.sections.forEach(sec => sec.classList.remove('active'));
            targetSection.classList.add('active');
            currentSectionId = sectionId;

            updateHeaderForSection(sectionId);
            elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));

            console.log(`ðŸ“„ Showing section: ${sectionId}`);

            switch (sectionId) {
                case 'home-section':
                    loadHomePageData();
                    break;
                case 'wallet-section':
                    loadWalletData();
                    break;
                case 'leaderboard-section':
                    loadLeaderboard();
                    break;
                case 'profile-section':
                    loadProfileData();
                    break;
                case 'earnings-section':
                    loadEarningsData();
                    break;
                case 'notifications-section':
                    loadNotifications();
                    break;
                case 'transaction-history-section':
                    loadFullTransactionHistory();
                    break;
                case 'withdraw-history-section':
                    loadWithdrawHistory();
                    break;
                case 'match-history-section':
                    loadMatchHistory();
                    break;
                case 'chat-section':
                    loadChatMessages();
                    break;
case 'socials-section':
    loadSocialsPageData();
    break;
case 'achievements-section':
                    loadAchievements();
                    break;
                case 'my-badges-section':
                    loadMyBadges();
                    break;
                case 'tournaments-section':
                    if (currentTournamentGameId) {
                        const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                        filterTournaments(currentTournamentGameId, activeTab);
                    } else {
                        elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>';
                    }
                    break;
            }

            if (sectionId === 'login-section') {
                toggleLoginForm(true);
            }
            window.scrollTo(0, 0);
        };

        function updateHeaderForSection(sectionId) {
            const showBackButton = [
                'tournaments-section', 'notifications-section', 'transaction-history-section',
                'withdraw-history-section', 'match-history-section', 'edit-nickname-section',
                'redeem-coupon-section', 'send-feedback-section', 'change-password-section',
                'vip-program-section', 'update-profile-picture-section'
            ].includes(sectionId);
            const defaultTitleVisible = !showBackButton;
            const gameTitleVisible = (sectionId === 'tournaments-section');

            if (elements.headerBackBtn) elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none';
            if (elements.headerTitleContainer) elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none';
            if (elements.headerGameTitle) elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none';

            if (gameTitleVisible && currentTournamentGameId && elements.headerGameTitle) {
                const gameName = appSettings?.games?.[currentTournamentGameId]?.name || `Game`;
                elements.headerGameTitle.textContent = gameName;
            } else if (defaultTitleVisible && elements.headerUserGreeting) {
                const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest';
                elements.headerUserGreeting.textContent = nameToShow;
            }
        }

        function updateGlobalUI(isLoggedIn) {
            if (elements.headerWalletChip) {
                elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none';
                if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section');
                else elements.headerWalletChip.onclick = null;
            }

            if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest';
            if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0';

            elements.bottomNavItems.forEach(item => {
                const section = item.dataset.section;
                item.style.display = (section === 'home-section' || isLoggedIn) ? 'flex' : 'none';
            });
        }

        function populateUserInfo(user, profile) {
    if (!user || !profile) return;

    const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User';
    const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=80`;

    const winningCash = Number(profile.winningCash || 0);
    const cashBalance = Number(profile.cashBalance || 0);
    const bonusCash = Number(profile.bonusCash || 0);
    const totalBalance = winningCash + cashBalance + bonusCash;

    // ðŸ†• VIP TIER CALCULATION
    const totalMatches = profile.totalMatches || 0;
    let vipTier = 'Bronze';
    let vipBadge = '';
    
    if (totalMatches >= 100) {
        vipTier = 'Platinum';
        vipBadge = ' <span class="vip-badge platinum"><i class="bi bi-gem" style="margin-right: 4px; font-size: 0.9rem; position: relative; z-index: 1;"></i><span style="position: relative; z-index: 1;">ðŸ’Ž PLATINUM</span></span>';
    } else if (totalMatches >= 50) {
        vipTier = 'Gold';
        vipBadge = ' <span class="vip-badge gold"><i class="bi bi-trophy-fill" style="margin-right: 4px; font-size: 0.85rem;"></i>ðŸ¥‡ GOLD</span>';
    } else if (totalMatches >= 10) {
        vipTier = 'Silver';
        vipBadge = ' <span class="vip-badge silver"><i class="bi bi-award-fill" style="margin-right: 4px; font-size: 0.85rem;"></i>ðŸ¥ˆ SILVER</span>';
    } else {
        vipBadge = ' <span class="vip-badge bronze"><i class="bi bi-shield-fill" style="margin-right: 4px; font-size: 0.85rem;"></i>ðŸ¥‰ BRONZE</span>';
    }

    const totalEarnings = Number(profile.totalEarnings || 0);
    const referralEarnings = Number(profile.referralEarnings || 0);
    const couponEarnings = Number(profile.couponEarnings || 0);
    const wonMatches = profile.wonMatches || 0;

    const formatCurrency = (amount) => `â‚¹${amount.toFixed(2)}`;

    // âœ… FIX: Logo side NO badge - simple text only
if (elements.headerUserGreeting) {
    elements.headerUserGreeting.textContent = displayName.split(' ')[0];
}
    if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(totalBalance);

    if (elements.walletTotalBalance) {
        elements.walletTotalBalance.textContent = formatCurrency(totalBalance);
        removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow'));
    }
    if (elements.walletWinningCash) {
        elements.walletWinningCash.textContent = formatCurrency(winningCash);
        removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow'));
    }
    if (elements.walletCashBalance) {
        elements.walletCashBalance.textContent = formatCurrency(cashBalance);
        removePlaceholders(elements.walletCashBalance.closest('.placeholder-glow'));
    }
    if (elements.walletBonusCash) {
        elements.walletBonusCash.textContent = formatCurrency(bonusCash);
        removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow'));
    }

    if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(winningCash);

    if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
    if (elements.profileName) {
    const userTier = getUserBadgeTier(totalMatches);
    const badgeHTML = createBadgeHTML(userTier, 'medium');
    elements.profileName.innerHTML = displayName + badgeHTML;
    removePlaceholders(elements.profileName.closest('.placeholder-glow'));
}
    if (elements.profileEmail) {
        elements.profileEmail.textContent = user.email || 'N/A';
        removePlaceholders(elements.profileEmail.closest('.placeholder-glow'));
    }
    if (elements.profileTotalMatches) {
        elements.profileTotalMatches.textContent = totalMatches;
        removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow'));
    }
    if (elements.profileWonMatches) {
        elements.profileWonMatches.textContent = wonMatches;
        removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow'));
    }
    if (elements.profileTotalEarnings) {
        const displayWinnings = totalEarnings > 0 ? totalEarnings : winningCash;
        elements.profileTotalEarnings.textContent = formatCurrency(displayWinnings);
        removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow'));
    }

    if (elements.earningsTotal) {
        elements.earningsTotal.textContent = formatCurrency(totalEarnings);
        removePlaceholders(elements.earningsTotal.closest('.placeholder-glow'));
    }
    if (elements.earningsReferral) {
        elements.earningsReferral.textContent = formatCurrency(referralEarnings);
        removePlaceholders(elements.earningsReferral.closest('.placeholder-glow'));
    }
    if (elements.earningsCoupon) {
        elements.earningsCoupon.textContent = formatCurrency(couponEarnings);
        removePlaceholders(elements.earningsCoupon.closest('.placeholder-glow'));
    }

    if (elements.editNicknameInput) {
        elements.editNicknameInput.value = displayName;
    }
}

        function toggleLoginForm(showLogin) {
            if (!elements.emailLoginForm || !elements.emailSignupForm) return;
            clearStatusMessage(elements.loginStatusMessage);
            clearStatusMessage(elements.signupStatusMessage);
            elements.emailLoginForm.style.display = showLogin ? 'block' : 'none';
            elements.emailSignupForm.style.display = showLogin ? 'none' : 'block';
            elements.emailLoginForm.reset();
            elements.emailSignupForm.reset();
        }

        async function signUpWithEmail() {
            if (!auth || !db) return;

            const email = elements.signupEmailInput.value.trim();
            const password = elements.signupPasswordInput.value;
            const confirmPassword = elements.signupConfirmPasswordInput.value;
            const gameName = elements.signupGameNameInput.value.trim();
            const refCode = elements.signupReferralCodeInput.value.trim().toUpperCase();

            if (!email || !password || !confirmPassword || !gameName) {
                showStatusMessage(elements.signupStatusMessage, 'Please fill all required fields.', 'warning');
                return;
            }
            if (password !== confirmPassword) {
                showStatusMessage(elements.signupStatusMessage, 'Passwords don\'t match.', 'warning');
                return;
            }
            if (password.length < 6) {
                showStatusMessage(elements.signupStatusMessage, 'Password must be at least 6 characters.', 'warning');
                return;
            }

            showLoader(true);
            clearStatusMessage(elements.signupStatusMessage);
            isSignupInProgress = true;

            let validReferrerUid = null;
            let validReferrerName = null;

            try {
                if (refCode) {
                    console.log("ðŸ” Validating referral code:", refCode);
                    const usersRef = ref(db, 'users');
                    const q = query(usersRef, orderByChild('referralCode'), equalTo(refCode));

                    try {
                        const snapshot = await get(q);

                        if (snapshot.exists()) {
                            const referrerData = snapshot.val();
                            const referrerId = Object.keys(referrerData)[0];
                            const referrerProfile = referrerData[referrerId];

                            if (referrerId && referrerProfile) {
                                validReferrerUid = referrerId;
                                validReferrerName = referrerProfile.displayName || referrerProfile.email?.split('@')[0] || 'User';
                                console.log("âœ… Valid referrer found:", validReferrerUid, validReferrerName);
                            }
                        } else {
                            console.log("âš ï¸ Referral code not found");
                            showStatusMessage(elements.signupStatusMessage, 'âš ï¸ Invalid referral code. Continuing without referral.', 'warning');
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            clearStatusMessage(elements.signupStatusMessage);
                        }
                    } catch (queryError) {
                        console.error("âŒ Referral query error:", queryError);
                        showStatusMessage(elements.signupStatusMessage, 'âš ï¸ Could not verify referral code. Continuing without referral.', 'warning');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        clearStatusMessage(elements.signupStatusMessage);
                    }
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUser = userCredential.user;
                console.log("âœ… User account created:", newUser.uid);

                const referralBonus = Number(appSettings.referralBonus || 5);
                const signupBonus = Number(appSettings.signupBonus || 10);

                const uniqueReferralCode = await generateReferralCode();

                const newUserProfile = {
                    uid: newUser.uid,
                    displayName: gameName,
                    email: newUser.email || null,
                    photoURL: newUser.photoURL || null,
                    winningCash: 0,
                    cashBalance: 0,
                    bonusCash: signupBonus,
                    totalMatches: 0,
                    wonMatches: 0,
                    totalEarnings: 0,
                    referralEarnings: 0,
                    couponEarnings: 0,
                    createdAt: Date.now(),
                    referralCode: uniqueReferralCode,
                    joinedTournaments: {},
                    isAdmin: false,
                    ...(validReferrerUid && { referredBy: validReferrerUid })
                };

                const userRef = ref(db, `users/${newUser.uid}`);
                await set(userRef, newUserProfile);
                console.log("âœ… New user profile created");

                await new Promise(resolve => setTimeout(resolve, 1000));
                const verifySnapshot = await get(userRef);
                if (!verifySnapshot.exists()) {
                    throw new Error("Profile was not saved properly");
                }

                if (signupBonus > 0) {
                    await recordTransaction(newUser.uid, 'signup_bonus', signupBonus, `Welcome Bonus`, 'bonusCash');
                }

                if (validReferrerUid && referralBonus > 0) {
                    console.log(`ðŸŽ Processing referral bonus: â‚¹${referralBonus}`);

                    const referrerRef = ref(db, `users/${validReferrerUid}`);
                    try {
                        await runTransaction(referrerRef, (referrerData) => {
                            if (referrerData) {
                                referrerData.cashBalance = (referrerData.cashBalance || 0) + referralBonus;
                                referrerData.referralEarnings = (referrerData.referralEarnings || 0) + referralBonus;
                                referrerData.totalEarnings = (referrerData.totalEarnings || 0) + referralBonus;
                            }
                            return referrerData;
                        });

                        await recordTransaction(validReferrerUid, 'referral_bonus', referralBonus, `Referral Bonus from ${gameName}`, 'cashBalance');
                        await recordEarning(validReferrerUid, 'referral', referralBonus, `Referral from ${gameName}`);
                        await sendNotification(validReferrerUid, 'Referral Bonus!', `ðŸŽ‰ You earned â‚¹${referralBonus} from ${gameName}'s signup!`);

                        console.log("âœ… Referrer bonus awarded");
                    } catch (referrerError) {
                        console.error("âŒ Error awarding referrer bonus:", referrerError);
                    }

                    try {
                        await runTransaction(userRef, (userData) => {
                            if (userData) {
                                userData.cashBalance = (userData.cashBalance || 0) + referralBonus;
                                userData.referralEarnings = (userData.referralEarnings || 0) + referralBonus;
                                userData.totalEarnings = (userData.totalEarnings || 0) + referralBonus;
                            }
                            return userData;
                        });

                        await recordTransaction(newUser.uid, 'referral_bonus', referralBonus, `Referral Bonus (Referred by ${validReferrerName})`, 'cashBalance');
                        await recordEarning(newUser.uid, 'referral', referralBonus, `Referral Bonus (Referred by ${validReferrerName})`);

                        console.log("âœ… New user referral bonus awarded");
                    } catch (newUserBonusError) {
                        console.error("âŒ Error awarding new user bonus:", newUserBonusError);
                    }

                    showStatusMessage(elements.signupStatusMessage, `âœ… Referral successful! You and ${validReferrerName} both received â‚¹${referralBonus}!`, 'success');
                } else {
                    showStatusMessage(elements.signupStatusMessage, 'âœ… Account created successfully! Logging you in...', 'success');
                }

                showToast('ðŸŽ‰ Welcome! Account created successfully!', 'success');
                console.log("âœ… Signup complete, waiting for auth state change...");

            } catch (e) {
                console.error("âŒ Signup Error:", e);
                isSignupInProgress = false;

                let message = `Signup failed.`;
                switch (e.code) {
                    case 'auth/email-already-in-use':
                        message = 'Email already registered.';
                        break;
                    case 'auth/weak-password':
                        message = 'Password too weak.';
                        break;
                    case 'auth/invalid-email':
                        message = 'Invalid email.';
                        break;
                    case 'auth/network-request-failed':
                        message = 'Network error. Check connection.';
                        break;
                    default:
                        message = `Error: ${e.message}`;
                }
                showStatusMessage(elements.signupStatusMessage, message, 'danger');
                showToast(message, 'error');
                showLoader(false);
            }
        }

        async function loginWithEmail() {
            if (!auth) return;

            const email = elements.loginEmailInput.value.trim();
            const password = elements.loginPasswordInput.value;

            if (!email || !password) {
                showStatusMessage(elements.loginStatusMessage, 'Enter email & password.', 'warning');
                return;
            }

            showLoader(true);
            clearStatusMessage(elements.loginStatusMessage);

            try {
                await signInWithEmailAndPassword(auth, email, password);
                console.log("âœ… Login successful");
                showToast('âœ… Login successful!', 'success');
            } catch (e) {
                console.error("âŒ Login Error:", e);
                let message = `Login failed.`;
                switch (e.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        message = 'Invalid email or password.';
                        break;
                    case 'auth/invalid-email':
                        message = 'Invalid email format.';
                        break;
                    case 'auth/too-many-requests':
                        message = 'Too many attempts. Try later or reset password.';
                        break;
                    case 'auth/network-request-failed':
                        message = 'Network error. Check connection.';
                        break;
                    case 'auth/user-disabled':
                        message = 'Account disabled. Contact support.';
                        break;
                    default:
                        message = `Error: ${e.message}`;
                }
                showStatusMessage(elements.loginStatusMessage, message, 'danger');
                showToast(message, 'error');
            } finally {
                showLoader(false);
            }
        }

        async function resetPassword() {
            if (!auth) return;

            const email = elements.loginEmailInput.value.trim();

            if (!email) {
                showStatusMessage(elements.loginStatusMessage, 'Enter your email for password reset.', 'warning');
                return;
            }

            showLoader(true);
            clearStatusMessage(elements.loginStatusMessage);

            try {
                await sendPasswordResetEmail(auth, email);
                showStatusMessage(elements.loginStatusMessage, 'Password reset email sent! Check your inbox/spam.', 'success', false);
                showToast('âœ… Password reset email sent!', 'success');
            } catch (e) {
                console.error("âŒ Reset Password Error:", e);
                let message = `Failed to send reset email.`;
                switch (e.code) {
                    case 'auth/user-not-found':
                    case 'auth/invalid-email':
                        message = 'Email not found or invalid.';
                        break;
                    case 'auth/network-request-failed':
                        message = 'Network error.';
                        break;
                    default:
                        message = `Error: ${e.message}`;
                }
                showStatusMessage(elements.loginStatusMessage, message, 'danger');
                showToast(message, 'error');
            } finally {
                showLoader(false);
            }
        }

        async function changePassword() {
            if (!auth || !currentUser) return;

            const currentPassword = elements.currentPasswordInput.value;
            const newPassword = elements.newPasswordInput.value;
            const confirmNewPassword = elements.confirmNewPasswordInput.value;

            clearStatusMessage(elements.changePasswordStatusMessage);

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showStatusMessage(elements.changePasswordStatusMessage, 'Please fill all fields.', 'warning');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showStatusMessage(elements.changePasswordStatusMessage, 'New passwords don\'t match.', 'warning');
                return;
            }

            if (newPassword.length < 6) {
                showStatusMessage(elements.changePasswordStatusMessage, 'New password must be at least 6 characters.', 'warning');
                return;
            }

            if (currentPassword === newPassword) {
                showStatusMessage(elements.changePasswordStatusMessage, 'New password must be different from current password.', 'warning');
                return;
            }

            elements.changePasswordBtn.disabled = true;
            elements.changePasswordBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Changing...';

            try {
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);

                await updatePassword(currentUser, newPassword);

                console.log("âœ… Password changed successfully");
                showStatusMessage(elements.changePasswordStatusMessage, 'âœ… Password changed successfully!', 'success');
                showToast('âœ… Password changed successfully!', 'success');

                elements.currentPasswordInput.value = '';
                elements.newPasswordInput.value = '';
                elements.confirmNewPasswordInput.value = '';

                setTimeout(() => {
                    showSection('profile-section');
                }, 2000);

            } catch (e) {
                console.error("âŒ Change password error:", e);
                let message = 'Failed to change password.';
                switch (e.code) {
                    case 'auth/wrong-password':
                        message = 'Current password is incorrect.';
                        break;
                    case 'auth/weak-password':
                        message = 'New password is too weak.';
                        break;
                    case 'auth/requires-recent-login':
                        message = 'Please logout and login again to change password.';
                        break;
                    default:
                        message = `Error: ${e.message}`;
                }
                showStatusMessage(elements.changePasswordStatusMessage, message, 'danger');
                showToast(message, 'error');
            } finally {
                elements.changePasswordBtn.disabled = false;
                elements.changePasswordBtn.innerHTML = '<i class="bi bi-check-circle"></i> Change Password';
            }
        }

        async function logoutUser() {
    if (!auth) return;

    if (!confirm('Are you sure you want to logout?')) return;

    try {
        showLoader(true);
        
        // âœ… FIX: Detach all listeners
        detachAllDbListeners(true);
        
        // âœ… FIX: Clear ALL user data
        cachedData = { games: null, promotions: null, lastFetch: {} };
        currentUser = null;
        userProfile = {};
        
        // âœ… CRITICAL: Clear ALL Firebase auth data
        try {
            // Method 1: Clear specific Firebase keys
            const firebaseKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (
                    key.startsWith('firebase:') || 
                    key.includes('authUser') ||
                    key.includes('firebase-auth')
                )) {
                    firebaseKeys.push(key);
                }
            }
            firebaseKeys.forEach(k => {
                try {
                    localStorage.removeItem(k);
                    sessionStorage.removeItem(k);
                } catch(e) {}
            });
            
            console.log("ðŸ—‘ï¸ Cleared", firebaseKeys.length, "Firebase keys");
        } catch (e) {
            console.warn("Storage clear warning:", e);
        }

                ['policyModalEl', 'addAmountModalEl', 'withdrawModalEl', 'matchDetailsModalEl', 'idPasswordModalEl', 'teamDetailsModalEl', 'resultClaimModalEl'].forEach(id => {
                    const modalEl = document.getElementById(id);
                    if (modalEl) {
                        const instance = bootstrap.Modal.getInstance(modalEl);
                        if (instance) instance.dispose();
                    }
                });

                if (swiperInstance) {
                    swiperInstance.destroy(true, true);
                    swiperInstance = null;
                }

                await signOut(auth);
                console.log("âœ… Logged out successfully");
                showToast('âœ… Logged out successfully', 'success');
            } catch (e) {
                console.error("âŒ Sign Out Error:", e);
                showToast(`Logout failed: ${e.message}`, 'error');
            } finally {
                showLoader(false);
            }
        }

        async function handleAuthStateChange(user) {
            console.log("ðŸ”„ Auth State Changed", user ? user.uid : 'No user');

            if (!auth || !db) {
                console.error("âŒ Firebase not ready in auth change");
                showLoader(false);
                return;
            }

            // âœ… NEW: Check if this is a different user than expected
            const lastKnownUser = sessionStorage.getItem('lastAuthUser');
            if (user && lastKnownUser && lastKnownUser !== user.uid) {
                console.warn("âš ï¸ Different user detected! Force logout.");
                try {
                    await signOut(auth);
                } catch(e) {
                    console.error("Force logout failed:", e);
                }
                showLoader(false);
                return;
            }

            if (user) {
                // Store current user in session storage (NOT localStorage)
                sessionStorage.setItem('lastAuthUser', user.uid);
            } else {
                sessionStorage.removeItem('lastAuthUser');
            }

            if (isSignupInProgress && user) {
                console.log("â³ Signup in progress, processing new user...");
                await new Promise(resolve => setTimeout(resolve, 1500));
            }

            showLoader(true);
            detachAllDbListeners();
            currentUser = user;
            
            // âœ… FIX: Reload settings after detaching listeners
            loadAppSettings();

            if (user) {
    console.log("âœ… User logged in:", user.uid);

    // âœ… NEW: Store current user session
    try {
        localStorage.setItem('currentAppUser', JSON.stringify({
            uid: user.uid,
            email: user.email,
            timestamp: Date.now()
        }));
    } catch (e) {
        console.warn("âš ï¸ Could not store session:", e);
    }

    const userRef = ref(db, 'users/' + user.uid);
    try {
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
            userProfile = snapshot.val();
            console.log("ðŸ“¦ User profile loaded");

                        const updates = {};
                        if (user.displayName && (!userProfile.displayName || userProfile.displayName !== user.displayName)) {
                            updates.displayName = user.displayName;
                        }
                        if (user.email && !userProfile.email) {
                            updates.email = user.email;
                        }

                        if (!userProfile.hasOwnProperty('cashBalance')) {
                            updates.cashBalance = 0;
                        }
                        if (!userProfile.hasOwnProperty('couponEarnings')) {
                            updates.couponEarnings = 0;
                        }

                        if (Object.keys(updates).length > 0) {
                            await update(userRef, updates);
                            userProfile = { ...userProfile, ...updates };
                        }
                    } else {
                        console.error("âš ï¸ User profile not found in database");
                        await signOut(auth);
                        showToast("Profile not found. Please contact support.", 'error');
                        showLoader(false);
                        isSignupInProgress = false;
                        return;
                    }

                    populateUserInfo(user, userProfile);
                    setupRealtimeListeners(user.uid);
                    updateGlobalUI(true);

                    if (isSignupInProgress) {
                        console.log("âœ… Signup complete, redirecting to home...");
                        isSignupInProgress = false;
                        showSection('home-section');
                    } else {
                        showSection('home-section');
                    }

                } catch (error) {
                    console.error("âŒ Profile handling error:", error);
                    showToast("Error loading profile: " + error.message, 'error');
                    isSignupInProgress = false;
                    try {
                        await logoutUser();
                    } catch (logoutErr) {}
                }
            } else {
                console.log("ðŸšª User logged out");
                currentUser = null;
                userProfile = {};
                isSignupInProgress = false;
                updateGlobalUI(false);
                showSection('login-section');
            }

            showLoader(false);
            authStateInitialized = true;
        }

        async function sendNotification(userId, title, message, imageUrl = null) {
            if (!userId || !db) return;
            try {
                const notifRef = ref(db, `notifications/${userId}`);
                const notificationData = {
                    title: title,
                    message: message,
                    timestamp: serverTimestamp(),
                    read: false
                };

                if (imageUrl && imageUrl.trim() !== '') {
                    notificationData.imageUrl = imageUrl;
                }

                await push(notifRef, notificationData);
                console.log("âœ… Notification sent");
            } catch (e) {
                console.error("âŒ Notification send failed:", e);
            }
        }

        async function recordEarning(userId, type, amount, description) {
            if (!userId || !db) return;
            try {
                const earningsRef = ref(db, `earnings/${userId}`);
                await push(earningsRef, {
                    type: type,
                    amount: amount,
                    description: description,
                    timestamp: serverTimestamp()
                });
                console.log("âœ… Earning recorded");
            } catch (e) {
                console.error("âŒ Earning record failed:", e);
            }
        }

        function loadAppSettings() {
    console.log("âš™ï¸ Loading app settings...");
    
    // âœ… FIX: Load from localStorage first (instant load)
    try {
        const cachedSettings = localStorage.getItem('appSettings');
        if (cachedSettings) {
            const parsedSettings = JSON.parse(cachedSettings);
            appSettings = {
                ...appSettings,
                ...parsedSettings
            };
            console.log("ðŸ“¦ Loaded cached settings from localStorage");
            
            // Apply cached theme immediately
            if (appSettings.theme) {
                applyTheme(appSettings.theme);
            }
            if (appSettings.logoUrl && elements.appLogo) {
                elements.appLogo.src = appSettings.logoUrl;
            }
        }
    } catch (e) {
        console.warn("âš ï¸ Could not load cached settings:", e);
    }
    
    const settingsRef = ref(db, 'settings');

    if (dbListeners['settings']) {
        off(settingsRef, 'value', dbListeners['settings']);
        delete dbListeners['settings'];
    }

    const settingsListener = onValue(settingsRef, (snapshot) => {
        if (snapshot.exists()) {
            const newSettings = snapshot.val() || {};
            
            // âœ… FIX: Merge instead of replace to preserve existing data
            appSettings = {
                ...appSettings,  // Keep existing data
                ...newSettings   // Update with new settings
            };
            
            console.log("âœ… App Settings Loaded", appSettings);
            
            // Save to localStorage for persistence
            try {
                localStorage.setItem('appSettings', JSON.stringify(appSettings));
                console.log("ðŸ’¾ Settings saved to localStorage");
            } catch (e) {
                console.warn("âš ï¸ Could not save settings to localStorage:", e);
            }

            if (appSettings.theme && typeof appSettings.theme === 'object') {
                applyTheme(appSettings.theme);
            }

            if (appSettings.logoUrl && elements.appLogo) {
                elements.appLogo.src = appSettings.logoUrl;
            }
            
            // APP NAME REALTIME UPDATE - NEW CODE
            if (appSettings.appName) {
                // Header title update
                const headerTitle = document.querySelector('.header-title');
                if (headerTitle) {
                    const greetingSpan = document.getElementById('headerUserGreetingEl');
                    const greetingText = greetingSpan ? greetingSpan.textContent : 'Guest';
                    headerTitle.innerHTML = `${appSettings.appName} <span id="headerUserGreetingEl">${greetingText}</span>`;
                }
                
                // Page title update
                document.title = appSettings.appName + ' - Tournament Hub';
            }
            
            if (appSettings.minWithdraw && elements.minWithdrawAmount) {
                elements.minWithdrawAmount.textContent = appSettings.minWithdraw;
            }

            if (elements.upiDisplay) {
                elements.upiDisplay.textContent = appSettings.upiDetails || 'Not configured';
            }

            if (appSettings.qrCodeUrl && elements.qrCodeImage) {
                elements.qrCodeImage.src = appSettings.qrCodeUrl;
            }

            if (elements.contactUsLink && appSettings.contactEmail) {
                elements.contactUsLink.href = `mailto:${appSettings.contactEmail}`;
            }

            checkForAppUpdate();
        } else {
            console.log("âš ï¸ App Settings not found - using defaults");
            appSettings = {};

            if (elements.upiDisplay) {
                elements.upiDisplay.textContent = 'Not configured';
            }
        }
    }, (error) => {
        console.error("âŒ Settings listener error:", error);
        appSettings = {};

        retryOperation('settings', () => loadAppSettings(), RETRY_DELAY);
    });

    dbListeners['settings'] = settingsListener;
}

        function checkForAppUpdate() {
            if (!appSettings.appUpdate || !appSettings.appUpdate.enabled) {
                console.log("â„¹ï¸ No app update configured or disabled");
                hideUpdateBanner();
                return;
            }

            const updateData = appSettings.appUpdate;
            console.log("ðŸ”” Checking app update:", updateData);

            if (!updateData.version || !updateData.downloadLink) {
                console.log("âš ï¸ Update data incomplete");
                hideUpdateBanner();
                return;
            }

            const ignoredVersion = localStorage.getItem('ignoredUpdateVersion');
            const currentVersion = localStorage.getItem('currentAppVersion') || '1.0.0';

            if (updateData.version !== currentVersion && ignoredVersion !== updateData.version) {
                console.log("âœ… Showing update banner for version:", updateData.version);
                showUpdateBanner(updateData);
            } else {
                console.log("â„¹ï¸ Update ignored or same version");
                hideUpdateBanner();
            }
        }

        function showUpdateBanner(updateData) {
            if (!elements.updateBanner) return;

            if (elements.updateBannerTitle) {
                const titleText = updateData.title || 'New Update Available';
                elements.updateBannerTitle.querySelector('span').textContent = titleText;
            }
            if (elements.updateBannerDescription) {
                elements.updateBannerDescription.textContent = updateData.description || 'A new version is available!';
            }
            if (elements.updateBannerVersion) {
                elements.updateBannerVersion.textContent = `Version: ${updateData.version || '1.0.0'}`;
            }

            elements.updateBanner.style.display = 'block';

            if (elements.updateBannerDownload && updateData.downloadLink) {
                elements.updateBannerDownload.onclick = () => {
                    window.open(updateData.downloadLink, '_blank');
                    hideUpdateBanner();
                };
            }

            if (elements.updateBannerIgnore) {
                elements.updateBannerIgnore.onclick = () => {
                    if (updateData.version) {
                        localStorage.setItem('ignoredUpdateVersion', updateData.version);
                    }
                    hideUpdateBanner();
                    showToast('Update reminder dismissed', 'info');
                };
            }

            if (elements.updateBannerClose) {
                elements.updateBannerClose.onclick = () => {
                    hideUpdateBanner();
                    showToast('Update banner closed', 'info');
                };
            }

            if (elements.updateBannerClose) {
                elements.updateBannerClose.onclick = () => {
                    hideUpdateBanner();
                };
            }
        }

        function hideUpdateBanner() {
            if (elements.updateBanner) {
                elements.updateBanner.style.display = 'none';
            }
        }

        function retryOperation(key, operation, delay = RETRY_DELAY) {
            if (!retryAttempts[key]) retryAttempts[key] = 0;

            if (retryAttempts[key] < MAX_RETRIES) {
                retryAttempts[key]++;
                console.log(`ðŸ”„ Retrying ${key}... Attempt ${retryAttempts[key]}/${MAX_RETRIES}`);
                setTimeout(operation, delay);
            } else {
                console.error(`âŒ Max retries reached for ${key}`);
                retryAttempts[key] = 0;
            }
        }

        async function invalidateCache(cacheKey) {
            if (cacheKey === 'all') {
                cachedData = { games: null, promotions: null, lastFetch: {} };
            } else {
                cachedData[cacheKey] = null;
                delete cachedData.lastFetch[cacheKey];
            }
            console.log(`ðŸ—‘ï¸ Cache invalidated: ${cacheKey}`);
        }

        function loadHomePageData() {
            console.log("ðŸ  Loading Home Page Data");

            if (!currentUser) {
                console.log("âš ï¸ User not logged in - skipping home data");
                return;
            }

            loadPromotions();
            loadGames();
            loadMyContests();
            loadMyGames('ongoing');
            loadLatestTournaments();
        }

        async function loadPromotions() {
            console.log("ðŸŽ¨ Loading Promotions");

            if (!elements.promotionSlider) return;
            const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper');
            if (!sliderWrapper) return;

            const now = Date.now();

            if (cachedData.promotions && cachedData.lastFetch.promotions && (now - cachedData.lastFetch.promotions < CACHE_EXPIRY)) {
                console.log("ðŸ“¦ Using cached promotions");
                renderPromotions(cachedData.promotions, sliderWrapper);
                return;
            }

            sliderWrapper.classList.add('placeholder-glow');
            sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder skeleton-loader" style="height: 100%; border-radius: 16px; display: block; width: 100%;"></span></div>`;

            const promoRef = ref(db, 'promotions');
            try {
                const snapshot = await get(promoRef);
                const promotions = snapshot.val() || {};
                const activePromotions = Object.values(promotions).filter(p => p.imageUrl);
                console.log(`Found ${activePromotions.length} promotions`);

                cachedData.promotions = activePromotions;
                cachedData.lastFetch.promotions = now;

                renderPromotions(activePromotions, sliderWrapper);
            } catch (e) {
                console.error("âŒ Promotions load failed:", e);
                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions</p>';

                retryOperation('promotions', () => loadPromotions(), RETRY_DELAY);
            }
        }

        function renderPromotions(activePromotions, sliderWrapper) {
            removePlaceholders(elements.promotionSlider);
            sliderWrapper.innerHTML = '';

            if (activePromotions.length > 0) {
                elements.promotionSlider.style.display = 'block';
                activePromotions.forEach(promo => {
                    const slide = document.createElement('div');
                    slide.className = 'swiper-slide';
                    slide.innerHTML = promo.link ? `<a href="${promo.link}" target="_blank"><img src="${promo.imageUrl}" alt="Promo"></a>` : `<img src="${promo.imageUrl}" alt="Promo">`;
                    sliderWrapper.appendChild(slide);
                });

                if (swiperInstance) swiperInstance.destroy(true, true);
                swiperInstance = new Swiper(elements.promotionSlider, {
    loop: activePromotions.length > 1,
    autoplay: { 
        delay: 4000, 
        disableOnInteraction: false,
        pauseOnMouseEnter: true
    },
    pagination: { 
        el: '.swiper-pagination', 
        clickable: true,
        dynamicBullets: true,
        dynamicMainBullets: 3
    },
    slidesPerView: 1,
    spaceBetween: 0, // No gaps
    centeredSlides: true,
    speed: 800, // Smooth transition speed
    effect: 'coverflow',
coverflowEffect: {
    rotate: 30,
    stretch: 0,
    depth: 100,
    modifier: 1,
    slideShadows: true
},
    grabCursor: true,
    watchOverflow: true,
    // Premium animations
    coverflowEffect: {
        rotate: 50,
        stretch: 0,
        depth: 100,
        modifier: 1,
        slideShadows: false
    },
    on: {
        init: function() {
            console.log('ðŸŽ¬ Swiper initialized with premium animations');
        },
        slideChangeTransitionStart: function() {
            // Add zoom effect on slide change
            const activeSlide = this.slides[this.activeIndex];
            if (activeSlide) {
                activeSlide.style.transform = 'scale(1.02)';
            }
        },
        slideChangeTransitionEnd: function() {
            // Reset zoom
            const activeSlide = this.slides[this.activeIndex];
            if (activeSlide) {
                activeSlide.style.transform = 'scale(1)';
            }
        }
    }
});
            } else {
                elements.promotionSlider.style.display = 'none';
            }
        }

        async function loadGames() {
            console.log("ðŸŽ® Loading Games");

            if (!elements.gamesList) return;

            const now = Date.now();

            if (cachedData.games && cachedData.lastFetch.games && (now - cachedData.lastFetch.games < CACHE_EXPIRY)) {
                console.log("ðŸ“¦ Using cached games");
                renderGames(cachedData.games);
                return;
            }

            elements.gamesList.classList.add('placeholder-glow');
            elements.gamesList.innerHTML = `<div class="game-card custom-card"><span class="placeholder skeleton-loader d-block" style="height: 110px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div>`.repeat(3);

            const gamesRef = ref(db, 'games');
            try {
                const snapshot = await get(gamesRef);
                const games = snapshot.val() || {};
                const activeGames = Object.entries(games)
                    .filter(([, game]) => game.imageUrl && game.name)
                    .sort(([, gameA], [, gameB]) => (gameA.order || 0) - (gameB.order || 0));
                console.log(`Found ${activeGames.length} games`);

                cachedData.games = activeGames;
                cachedData.lastFetch.games = now;

                renderGames(activeGames);
            } catch (e) {
                console.error("âŒ Games load failed:", e);
                removePlaceholders(elements.gamesList);
                elements.gamesList.innerHTML = '<p class="text-danger text-center col-12">Could not load games</p>';

                retryOperation('games', () => loadGames(), RETRY_DELAY);
            }
        }

        function renderGames(activeGames) {
            removePlaceholders(elements.gamesList);
            elements.gamesList.innerHTML = '';

            if (activeGames.length > 0) {
                if (!appSettings.games) appSettings.games = {};

                activeGames.forEach(([gameId, game]) => {
                    appSettings.games[gameId] = { name: game.name };

                    const col = document.createElement('div');
                    col.innerHTML = `<div class="game-card custom-card card-glow" data-game-id="${gameId}" data-game-name="${game.name}"><img src="${game.imageUrl}" alt="${game.name}"><span>${game.name}</span></div>`;
                    col.querySelector('.game-card').addEventListener('click', () => {
                        currentTournamentGameId = gameId;
                        loadTournamentsForGame(gameId, game.name);
                    });
                    elements.gamesList.appendChild(col);
                });
            } else {
                elements.gamesList.innerHTML = '<p class="text-secondary text-center col-12">No games available</p>';
            }
        }

        function loadTournamentsForGame(gameId, gameName) {
            console.log(`ðŸ† Loading tournaments for: ${gameName}`);

            if (!elements.tournamentsSection) return;

            currentTournamentGameId = gameId;
            elements.tournamentTabs.forEach(t => t.classList.remove('active'));
            querySel('.tournament-tabs .tab-item[data-status="upcoming"]')?.classList.add('active');

            showSection('tournaments-section');
            filterTournaments(gameId, 'upcoming');
        }

        async function filterTournaments(gameId, status) {
            console.log(`ðŸ” Filtering tournaments: ${gameId} - ${status}`);

            if (!elements.tournamentsListContainer) return;

            elements.tournamentsListContainer.innerHTML = '';
            elements.tournamentsListContainer.classList.add('placeholder-glow');
            elements.tournamentsListContainer.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4" style="height:30px"></span><span class="placeholder col-4" style="height:30px"></span></div></div>`;
            elements.noTournamentsMessage.style.display = 'none';

            try {
                const tQuery = query(ref(db, 'tournaments'), orderByChild('gameId'), equalTo(gameId));
                const s = await get(tQuery);
                const allT = s.val() || {};
                
                // âœ… FIX: Handle both 'result' and 'completed' status
                const fT = Object.entries(allT)
                    .filter(([, t]) => {
                        if (status === 'completed') {
                            return t.status === 'completed' || t.status === 'result';
                        }
                        return t.status === status;
                    })
                    .sort(([, tA], [, tB]) => (tA.startTime || 0) - (tB.startTime || 0));
                console.log(`Found ${fT.length} tournaments`);

                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '';

                if (fT.length > 0) {
                    fT.forEach(([tId, t]) => {
                        const card = createTournamentCardElement(tId, t);
                        elements.tournamentsListContainer.appendChild(card);
                    });
                } else {
                    elements.noTournamentsMessage.style.display = 'block';
                    elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`;
                }
            } catch (e) {
                console.error(`âŒ Tournaments filter failed (${status}):`, e);
                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '<p class="text-danger text-center mt-4">Could not load tournaments</p>';
                elements.noTournamentsMessage.style.display = 'none';

                retryOperation(`tournaments-${status}`, () => filterTournaments(gameId, status), RETRY_DELAY);
            }
        }

        function createTournamentCardElement(tId, t) {
    const card = document.createElement('div');
    card.className = 'tournament-card card-glow';
    card.dataset.tournamentId = tId;

    const entryFee = t.entryFee || 0;
    const perKillPrize = t.perKillPrize || 0;
    const prizePool = t.prizePool || 0;
    const startTime = t.startTime ? new Date(t.startTime) : null;
    const startTimeLocal = startTime ? startTime.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'TBA';
    const registeredPlayers = t.registeredPlayers || {};
    const registeredCount = Object.keys(registeredPlayers).length;
    const maxPlayers = t.maxPlayers || 0;

    const spotsLeft = maxPlayers > 0 ? Math.max(0, maxPlayers - registeredCount) : Infinity;
    const isFull = maxPlayers > 0 && spotsLeft <= 0;
    const isJoined = currentUser && userProfile?.joinedTournaments?.[tId];
    const canJoin = !isJoined && !isFull && t.status === 'upcoming';

    // TIMER REALTIME UPDATE - NEW CODE
    let timerInterval;
    function getTimerText() {
        let timerText = t.status?.toUpperCase() || 'N/A';
        if (t.status === 'upcoming' && t.startTime) {
            timerText = getTimeRemaining(t.startTime);
        } else if (t.status === 'ongoing') {
            timerText = 'LIVE';
        } else if (t.status === 'completed' || t.status === 'result') {
            timerText = 'ENDED';
        }
        return timerText;
    }

    let spotsText = 'Unlimited Spots';
    let progressPercent = 0;
    if (maxPlayers > 0) {
        spotsText = `<span class="${spotsLeft <= 5 ? 'text-danger' : 'text-accent'}">${spotsLeft}</span> Spots Left (${registeredCount}/${maxPlayers})`;
        progressPercent = Math.min(100, (registeredCount / maxPlayers) * 100);
    }

    let actionButton = '';
    let idPassButton = '';
    let resultButton = '';

    if (isJoined) {
        actionButton = `<button class="btn btn-custom btn-sm btn-joined ripple" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>`;
        if (t.status === 'ongoing' || (t.status === 'upcoming' && t.showIdPass && startTime && Date.now() > startTime.getTime() - 900000)) {
            idPassButton = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm ripple" data-tournament-id="${tId}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`;
        }
        if (t.status === 'completed' || t.status === 'result') {
            resultButton = `<button class="btn btn-result btn-sm ripple" data-tournament-id="${tId}"><i class="bi bi-trophy-fill"></i> View Result & Claim</button>`;
        }
    } else if (canJoin) {
        actionButton = `<button class="btn btn-custom btn-sm btn-custom-accent btn-join ripple" data-tournament-id="${tId}" data-fee="${entryFee}" data-match-type="${t.matchType || 'Solo'}">â‚¹${entryFee} Join <i class="bi bi-arrow-right-short"></i></button>`;
    } else {
        let disabledReason = t.status !== 'upcoming' ? t.status?.toUpperCase() : (isFull ? 'Full' : 'Closed');
        actionButton = `<button class="btn btn-custom btn-sm btn-disabled" disabled>${disabledReason || 'N/A'}</button>`;
    }

    const bannerHTML = t.bannerImage ? `
    <div class="tournament-banner" style="width: calc(100% + 36px); height: 150px; border-radius: 16px 16px 0 0; overflow: hidden; margin: -18px -18px 15px -18px; position: relative;">
        <img src="${t.bannerImage}" alt="Tournament Banner" style="width: 100%; height: 100%; object-fit: cover; display: block;">
        <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 50%; background: linear-gradient(to bottom, transparent, rgba(15, 23, 42, 0.9));"></div>
    </div>
` : '';

    card.innerHTML = `
    ${bannerHTML}
    <div class="tournament-card-header">
        <div class="tournament-card-tags">
            ${t.mode ? `<span>${t.mode}</span>` : ''}
            ${t.map ? `<span>${t.map}</span>` : ''}
            ${t.matchType ? `<span><i class="bi bi-people-fill"></i> ${t.matchType}</span>` : ''}
            ${t.tags ? (Array.isArray(t.tags) ? t.tags.map(tag => `<span>${tag}</span>`).join('') : Object.values(t.tags).map(tag => `<span>${tag}</span>`).join('')) : ''}
        </div>
        <div class="tournament-card-timer" data-tournament-id="${tId}">${getTimerText()}</div>
    </div>
    <h3 class="tournament-card-title">
        ${t.icon ? `<i class="${t.icon}"></i>` : '<i class="bi bi-joystick text-accent"></i>'}
        ${t.name || 'Tournament'}
    </h3>
    <p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${startTimeLocal}</p>
    <div class="tournament-card-info">
        <div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> â‚¹${prizePool}</strong></div>
        <div class="info-item"><span>Per Kill</span><strong>â‚¹${perKillPrize}</strong></div>
        <div class="info-item"><span>Entry Fee</span><strong class="${entryFee > 0 ? 'text-info' : ''}">${entryFee > 0 ? `â‚¹${entryFee}` : 'Free'}</strong></div>
    </div>
    <div class="tournament-card-spots">
        ${spotsText}
        ${maxPlayers > 0 ? `<div class="progress mt-1"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progressPercent}%"></div></div>` : ''}
    </div>
    <div class="tournament-card-actions">
        <button class="btn btn-custom btn-custom-secondary btn-sm btn-details ripple" data-tournament-id="${tId}">Details</button>
        ${actionButton}
    </div>
    ${idPassButton}
    ${resultButton}
`;

    // Timer auto-update har 30 seconds
    if (t.status === 'upcoming') {
        timerInterval = setInterval(() => {
            const timerElement = card.querySelector('.tournament-card-timer');
            if (timerElement) {
                timerElement.textContent = getTimerText();
            }
        }, 30000); // 30 seconds
        
        // Cleanup on card removal
        card.addEventListener('DOMNodeRemoved', () => {
            if (timerInterval) clearInterval(timerInterval);
        });
    }

    const joinBtn = card.querySelector('.btn-join');
if (joinBtn) {
    // Remove any existing listeners
    joinBtn.replaceWith(joinBtn.cloneNode(true));
    const newJoinBtn = card.querySelector('.btn-join');
    
    newJoinBtn.addEventListener('click', handleJoinTournamentClick, { once: false });
}

    const detailsBtn = card.querySelector('.btn-details');
    if (detailsBtn) detailsBtn.addEventListener('click', handleMatchDetailsClick);

    const idPassBtn = card.querySelector('.btn-idpass');
    if (idPassBtn) idPassBtn.addEventListener('click', handleIdPasswordClick);

    const resultBtn = card.querySelector('.btn-result');
    if (resultBtn) resultBtn.addEventListener('click', handleResultClaimClick);

    return card;
}

        async function loadMyContests() {
            console.log("ðŸ“‹ Loading My Contests");

            if (!currentUser || !elements.myContestsList) {
                if (elements.myContestsList) removePlaceholders(elements.myContestsList);
                if (elements.myContestsList) elements.myContestsList.innerHTML = '';
                if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block';
                return;
            }

            const joinedIds = Object.keys(userProfile.joinedTournaments || {});
            elements.myContestsList.classList.add('placeholder-glow');
            elements.myContestsList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4" style="height:30px"></span><span class="placeholder col-4" style="height:30px"></span></div></div>`;
            if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'none';

            if (joinedIds.length === 0) {
                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = '';
                if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block';
                return;
            }

            console.log(`Found ${joinedIds.length} joined contests`);

            try {
                const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`)));
                const snapshots = await Promise.all(contestPromises);

                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = '';

                const contestCards = [];
                snapshots.forEach((snapshot, index) => {
                    if (snapshot.exists()) {
                        const t = snapshot.val();
                        if (t.status === 'upcoming' || t.status === 'ongoing') {
                            const tId = joinedIds[index];
                            contestCards.push({ startTime: t.startTime || 0, card: createTournamentCardElement(tId, t) });
                        }
                    }
                });

                contestCards.sort((a, b) => a.startTime - b.startTime);

                if (contestCards.length > 0) {
                    contestCards.forEach(item => elements.myContestsList.appendChild(item.card));
                } else if (elements.noContestsMessage) {
                    elements.noContestsMessage.style.display = 'block';
                    elements.noContestsMessage.textContent = "No upcoming/ongoing contests";
                }
            } catch (e) {
                console.error("âŒ My contests load failed:", e);
                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = '<p class="text-danger text-center">Could not load contests</p>';
            }
        }

        async function loadMyGames(status) {
            console.log(`ðŸŽ® Loading My Games: ${status}`);

            if (!currentUser || !elements.myGamesList) {
                if (elements.myGamesList) removePlaceholders(elements.myGamesList);
                if (elements.myGamesList) elements.myGamesList.innerHTML = '';
                if (elements.noMyGamesMessage) elements.noMyGamesMessage.style.display = 'block';
                return;
            }

            const joinedIds = Object.keys(userProfile.joinedTournaments || {});

            elements.myGamesList.classList.add('placeholder-glow');
            elements.myGamesList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4" style="height:30px"></span><span class="placeholder col-4" style="height:30px"></span></div></div>`;
            if (elements.noMyGamesMessage) elements.noMyGamesMessage.style.display = 'none';

            if (joinedIds.length === 0) {
                removePlaceholders(elements.myGamesList);
                elements.myGamesList.innerHTML = '';
                if (elements.noMyGamesMessage) {
                    elements.noMyGamesMessage.style.display = 'block';
                    elements.noMyGamesMessage.textContent = 'You haven\'t joined any tournaments yet';
                }
                return;
            }

            try {
                const gamePromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`)));
                const snapshots = await Promise.all(gamePromises);

                removePlaceholders(elements.myGamesList);
                elements.myGamesList.innerHTML = '';

                const gameCards = [];
                snapshots.forEach((snapshot, index) => {
                    if (snapshot.exists()) {
                        const t = snapshot.val();
                        if (t.status === status) {
                            const tId = joinedIds[index];
                            gameCards.push({ startTime: t.startTime || 0, card: createTournamentCardElement(tId, t) });
                        }
                    }
                });

                gameCards.sort((a, b) => a.startTime - b.startTime);

                if (gameCards.length > 0) {
                    gameCards.forEach(item => elements.myGamesList.appendChild(item.card));
                } else if (elements.noMyGamesMessage) {
                    elements.noMyGamesMessage.style.display = 'block';
                    elements.noMyGamesMessage.textContent = `No ${status} tournaments`;
                }
            } catch (e) {
                console.error(`âŒ My games (${status}) load failed:`, e);
                removePlaceholders(elements.myGamesList);
                elements.myGamesList.innerHTML = '<p class="text-danger text-center">Could not load tournaments</p>';
            }
        }

        async function loadLatestTournaments() {
            console.log("ðŸ†• Loading Latest Tournaments");

            if (!currentUser || !elements.latestTournamentsList) {
                if (elements.latestTournamentsList) removePlaceholders(elements.latestTournamentsList);
                if (elements.latestTournamentsList) elements.latestTournamentsList.innerHTML = '';
                if (elements.noLatestTournamentsMessage) elements.noLatestTournamentsMessage.style.display = 'block';
                return;
            }

            elements.latestTournamentsList.classList.add('placeholder-glow');
            elements.latestTournamentsList.innerHTML = `<div class="latest-tournament-card placeholder-glow mb-3"><span class="placeholder col-8" style="height: 20px;"></span><span class="placeholder col-12 mt-2" style="height: 16px;"></span></div>`.repeat(3);
            if (elements.noLatestTournamentsMessage) elements.noLatestTournamentsMessage.style.display = 'none';

            try {
                const tournamentsRef = ref(db, 'tournaments');
                const snapshot = await get(tournamentsRef);
                const allTournaments = snapshot.val() || {};

                const upcomingTournaments = Object.entries(allTournaments)
                    .filter(([, t]) => t.status === 'upcoming')
                    .sort(([, tA], [, tB]) => (tB.createdAt || 0) - (tA.createdAt || 0))
                    .slice(0, 3);

                removePlaceholders(elements.latestTournamentsList);
                elements.latestTournamentsList.innerHTML = '';

                if (upcomingTournaments.length > 0) {
                    upcomingTournaments.forEach(([tId, t]) => {
                        const card = document.createElement('div');
                        card.className = 'latest-tournament-card ripple';
                        card.innerHTML = `
                            <h4 style="font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                                <i class="bi bi-fire text-warning"></i> ${t.name || 'Tournament'}
                            </h4>
                            <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">
                                Prize: â‚¹${t.prizePool || 0} â€¢ Entry: ${t.entryFee > 0 ? `â‚¹${t.entryFee}` : 'Free'}
                            </p>
                        `;
                        card.addEventListener('click', () => {
                            currentTournamentGameId = t.gameId;
                            loadTournamentsForGame(t.gameId, appSettings.games?.[t.gameId]?.name || 'Game');
                        });
                        elements.latestTournamentsList.appendChild(card);
                    });
                } else {
                    if (elements.noLatestTournamentsMessage) {
                        elements.noLatestTournamentsMessage.style.display = 'block';
                        elements.noLatestTournamentsMessage.textContent = 'No latest tournaments';
                    }
                }
            } catch (e) {
                console.error("âŒ Latest tournaments load failed:", e);
                removePlaceholders(elements.latestTournamentsList);
                elements.latestTournamentsList.innerHTML = '<p class="text-danger text-center">Could not load latest tournaments</p>';
            }
        }

        function loadWalletData() {
            console.log("ðŸ’° Loading Wallet Data");
            if (!currentUser) return;
            loadRecentTransactions();
        }

        function loadProfileData() {
    console.log("ðŸ‘¤ Loading Profile Data");
    if (!currentUser) return;
    // VIP Program ab separate page me load hoga
    loadSocialsPageData(); // Load social stats
}

        function loadEarningsData() {
            console.log("ðŸ’µ Loading Earnings Data");
            if (!currentUser) return;

            if (elements.earningsHistoryContainer) {
                elements.earningsHistoryContainer.style.display = 'none';
            }
        }

        async function loadEarningsHistory() {
            console.log("ðŸ“Š Loading Earnings History");

            if (!currentUser || !elements.earningsHistoryList) return;

            elements.earningsHistoryContainer.style.display = 'block';
            elements.earningsHistoryList.innerHTML = '<div class="earning-item placeholder-glow mb-2"><div class="earning-header"><span class="placeholder col-5" style="height: 18px;"></span><span class="placeholder col-3" style="height: 20px;"></span></div><div class="earning-details"><span class="placeholder col-8" style="height: 14px;"></span></div></div>';
            if (elements.noEarningsMessage) elements.noEarningsMessage.style.display = 'none';

            try {
                const earningsRef = ref(db, `earnings/${currentUser.uid}`);
                const snapshot = await get(earningsRef);

                elements.earningsHistoryList.innerHTML = '';

                if (snapshot.exists()) {
                    const earnings = snapshot.val();
                    const earningsArray = Object.entries(earnings)
                        .map(([id, earning]) => ({ id, ...earning }))
                        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    console.log(`Found ${earningsArray.length} earnings`);

                    if (earningsArray.length > 0) {
                        earningsArray.forEach(earning => {
                            const item = document.createElement('div');
                            item.className = 'earning-item';

                            const time = earning.timestamp ? new Date(earning.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';
                            let typeLabel = 'Earning';
                            if (earning.type === 'referral') typeLabel = 'Referral Bonus';
                            else if (earning.type === 'tournament') typeLabel = 'Tournament Win';
                            else if (earning.type === 'coupon') typeLabel = 'Coupon Redeem';

                            item.innerHTML = `
                                <div class="earning-header">
                                    <span class="earning-type">${typeLabel}</span>
                                    <span class="earning-amount">+â‚¹${(earning.amount || 0).toFixed(2)}</span>
                                </div>
                                <div class="earning-details">
                                    ${earning.description || 'No description'} â€¢ ${time}
                                </div>
                            `;

                            elements.earningsHistoryList.appendChild(item);
                        });
                    } else {
                        if (elements.noEarningsMessage) {
                            elements.noEarningsMessage.style.display = 'block';
                        }
                    }
                } else {
                    if (elements.noEarningsMessage) {
                        elements.noEarningsMessage.style.display = 'block';
                    }
                }
            } catch (e) {
                console.error("âŒ Earnings history load failed:", e);
                elements.earningsHistoryList.innerHTML = '<p class="text-danger text-center">Could not load earnings history</p>';
            }
        }

        async function loadLeaderboard() {
            console.log("ðŸ† Loading Leaderboard");

            if (!currentUser || !elements.leaderboardList) return;

            elements.leaderboardList.classList.add('placeholder-glow');
            elements.leaderboardList.innerHTML = `<div class="leaderboard-item placeholder-glow mb-2"><div class="leaderboard-rank"><span class="placeholder" style="width: 30px; height: 30px; display: inline-block;"></span></div><div class="leaderboard-avatar"><span class="placeholder" style="width: 55px; height: 55px; border-radius: 50%; display: inline-block;"></span></div><div class="leaderboard-info"><div class="leaderboard-name"><span class="placeholder col-6"></span></div><div class="leaderboard-balance"><span class="placeholder col-4"></span></div></div></div>`.repeat(3);
            if (elements.noLeaderboardMessage) elements.noLeaderboardMessage.style.display = 'none';

            try {
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);

                removePlaceholders(elements.leaderboardList);
                elements.leaderboardList.innerHTML = '';

                if (snapshot.exists()) {
                    const users = [];
                    snapshot.forEach(childSnapshot => {
                        const userData = childSnapshot.val();
                        if (userData && userData.displayName) {
                            const totalBalance = (userData.winningCash || 0) + (userData.cashBalance || 0) + (userData.bonusCash || 0);
                            users.push({
                                uid: childSnapshot.key,
                                displayName: userData.displayName,
                                totalBalance: totalBalance,
                                totalMatches: userData.totalMatches || 0,
                                wonMatches: userData.wonMatches || 0,
                                totalEarnings: userData.totalEarnings || 0,
                                photoURL: userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.displayName)}&background=random&size=55`
                            });
                        }
                    });

                    users.sort((a, b) => b.totalBalance - a.totalBalance);
                    const leaderboardLimit = Number(appSettings.leaderboardLimit) || 10;
                    const topUsers = users.slice(0, leaderboardLimit);

                    console.log(`Found ${users.length} users, showing top ${leaderboardLimit}`);

                    if (topUsers.length > 0) {
                        topUsers.forEach((user, index) => {
                            const rank = index + 1;
                            const item = document.createElement('div');
                            item.className = 'leaderboard-item';
                            item.style.cursor = 'pointer';
                            item.dataset.userId = user.uid;

                            let rankClass = '';
                            let crownIcon = '';
                            if (rank === 1) {
                                rankClass = 'gold';
                                crownIcon = '<i class="bi bi-trophy-fill crown-icon"></i>';
                            } else if (rank === 2) {
                                rankClass = 'silver';
                            } else if (rank === 3) {
                                rankClass = 'bronze';
                            }

                            const isCurrentUser = currentUser && user.uid === currentUser.uid;

                            const leaderboardTier = getUserBadgeTier(user.totalMatches);
const leaderboardBadgeHTML = createBadgeHTML(leaderboardTier, 'small');

                            item.innerHTML = `
                                <div class="leaderboard-rank ${rankClass}">#${rank}</div>
                                <img src="${user.photoURL}" alt="${user.displayName}" class="leaderboard-avatar">
                                <div class="leaderboard-info">
                                    <div class="leaderboard-name">${user.displayName}${leaderboardBadgeHTML}${crownIcon}${isCurrentUser ? ' <span class="badge bg-info">You</span>' : ''}</div>
                                    <div class="leaderboard-balance">â‚¹${user.totalBalance.toFixed(2)}</div>
                                </div>
                            `;

                            // Add click handler to open profile modal
                            item.addEventListener('click', () => {
                                if (user.uid !== currentUser.uid) {
                                    openUserProfileModal(user);
                                } else {
                                    showToast('This is your profile', 'info');
                                }
                            });

                            elements.leaderboardList.appendChild(item);
                        });
                    } else {
                        if (elements.noLeaderboardMessage) {
                            elements.noLeaderboardMessage.style.display = 'block';
                        }
                    }
                } else {
                    if (elements.noLeaderboardMessage) {
                        elements.noLeaderboardMessage.style.display = 'block';
                    }
                }
            } catch (e) {
                console.error("âŒ Leaderboard load failed:", e);
                removePlaceholders(elements.leaderboardList);
                elements.leaderboardList.innerHTML = '<p class="text-danger text-center">Could not load leaderboard</p>';
            }
        }

        async function loadNotifications() {
            console.log("ðŸ”” Loading Notifications");

            if (!currentUser || !elements.notificationsList) return;

            elements.notificationsList.classList.add('placeholder-glow');
            elements.notificationsList.innerHTML = `<div class="notification-item placeholder-glow mb-2"><div class="notification-avatar"><span class="placeholder" style="width: 50px; height: 50px; border-radius: 50%; display: inline-block;"></span></div><div class="notification-content"><div class="notification-header"><span class="placeholder col-6" style="height: 18px;"></span><span class="placeholder col-3" style="height: 14px;"></span></div><div class="notification-message"><span class="placeholder col-12" style="height: 16px;"></span><span class="placeholder col-8 mt-1" style="height: 16px;"></span></div></div></div>`;
            if (elements.noNotificationsMessage) elements.noNotificationsMessage.style.display = 'none';

            try {
                const notifRef = ref(db, `notifications/${currentUser.uid}`);
                const snapshot = await get(notifRef);

                removePlaceholders(elements.notificationsList);
                elements.notificationsList.innerHTML = '';

                if (snapshot.exists()) {
                    const notifications = snapshot.val();
                    const notifArray = Object.entries(notifications)
                        .map(([id, notif]) => ({ id, ...notif }))
                        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    console.log(`Found ${notifArray.length} notifications`);

                    if (notifArray.length > 0) {
                        notifArray.forEach(notif => {
                            const item = document.createElement('div');
                            item.className = `notification-item ${!notif.read ? 'unread' : ''}`;
                            item.dataset.notificationId = notif.id;

                            const time = notif.timestamp ? new Date(notif.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'Recently';

                            const avatarSrc = notif.imageUrl || 'https://static.vecteezy.com/system/resources/previews/068/775/757/non_2x/golden-bell-notification-icon-isolated-on-transparent-background-free-png.png';

                            // âœ… ACTION BUTTONS (Download, Visit, Friend Request Accept/Reject)
let actionButtonsHTML = '';

// Friend Request Notification Buttons
if (notif.type === 'friend_request' && notif.requestId && notif.fromUserId) {
    actionButtonsHTML += `
        <div class="friend-request-actions" style="display: flex; gap: 8px; margin-top: 10px;">
            <button class="btn btn-sm btn-custom-accent ripple accept-friend-btn" 
                    data-request-id="${notif.requestId}" 
                    data-user-id="${notif.fromUserId}" 
                    style="flex: 1; padding: 8px 16px; font-size: 0.85rem;">
                <i class="bi bi-check-circle-fill"></i> Accept
            </button>
            <button class="btn btn-sm btn-custom-secondary ripple reject-friend-btn" 
                    data-request-id="${notif.requestId}" 
                    style="flex: 1; padding: 8px 16px; font-size: 0.85rem;">
                <i class="bi bi-x-circle-fill"></i> Reject
            </button>
        </div>
    `;
}

// Download Button
if (notif.downloadLink) {
    actionButtonsHTML += `
        <a href="${notif.downloadLink}" target="_blank" class="btn btn-sm btn-custom-accent mt-2 me-2" style="padding: 6px 12px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px; text-decoration: none;">
            <i class="bi bi-download"></i> Download
        </a>
    `;
}

// Visit Button
if (notif.visitLink) {
    actionButtonsHTML += `
        <a href="${notif.visitLink}" target="_blank" class="btn btn-sm btn-custom-primary mt-2" style="padding: 6px 12px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px; text-decoration: none;">
            <i class="bi bi-box-arrow-up-right"></i> Visit
        </a>
    `;
}

item.innerHTML = `
    <img src="${avatarSrc}" alt="Notification" class="notification-avatar" onerror="this.src='https://static.vecteezy.com/system/resources/previews/068/775/757/non_2x/golden-bell-notification-icon-isolated-on-transparent-background-free-png.png'">
    <div class="notification-content">
        <div class="notification-header">
            <span class="notification-title">${notif.title || 'Notification'}</span>
            <span class="notification-time">${time}</span>
        </div>
        <div class="notification-message">${notif.message || 'No message'}</div>
        ${actionButtonsHTML}
    </div>
`;

// âœ… ADD EVENT LISTENERS FOR ACCEPT/REJECT BUTTONS
const acceptBtn = item.querySelector('.accept-friend-btn');
if (acceptBtn) {
    acceptBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const reqId = acceptBtn.dataset.requestId;
        const userId = acceptBtn.dataset.userId;
        
        acceptBtn.disabled = true;
        acceptBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        await acceptFriendRequestFromNotification(reqId, userId, notif.id);
    });
}

const rejectBtn = item.querySelector('.reject-friend-btn');
if (rejectBtn) {
    rejectBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const reqId = rejectBtn.dataset.requestId;
        
        rejectBtn.disabled = true;
        rejectBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        await rejectFriendRequestFromNotification(reqId, notif.id);
    });
}

                            // âœ… CLICK TO MARK AS READ
item.addEventListener('click', () => markNotificationAsRead(notif.id));

// âœ… LONG PRESS TO DELETE NOTIFICATION
let pressTimer;

item.addEventListener('touchstart', (e) => {
    pressTimer = setTimeout(() => {
        showDeleteNotificationOption(notif.id, item);
    }, 800); // 800ms long press
});

item.addEventListener('touchend', () => {
    clearTimeout(pressTimer);
});

item.addEventListener('touchmove', () => {
    clearTimeout(pressTimer);
});

// Desktop right-click support
item.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    showDeleteNotificationOption(notif.id, item);
});

elements.notificationsList.appendChild(item);
                        });

                        updateUnreadNotificationCount(notifArray.filter(n => !n.read).length);
                    } else {
                        if (elements.noNotificationsMessage) {
                            elements.noNotificationsMessage.style.display = 'block';
                        }
                    }
                } else {
                    if (elements.noNotificationsMessage) {
                        elements.noNotificationsMessage.style.display = 'block';
                    }
                    updateUnreadNotificationCount(0);
                }
            } catch (e) {
                console.error("âŒ Notifications load failed:", e);
                removePlaceholders(elements.notificationsList);
                elements.notificationsList.innerHTML = '<p class="text-danger text-center">Could not load notifications</p>';
            }
        }

        async function markNotificationAsRead(notificationId) {
            if (!currentUser || !notificationId) return;
            try {
                const notifRef = ref(db, `notifications/${currentUser.uid}/${notificationId}`);
                await update(notifRef, { read: true });
                loadNotifications();
            } catch (e) {
                console.error("âŒ Failed to mark notification as read:", e);
            }
        }

function showDeleteNotificationOption(notificationId, itemElement) {
    if (!notificationId || !itemElement) return;

    // Check if delete button already exists
    const existingBtn = itemElement.querySelector('.delete-notif-btn');
    if (existingBtn) {
        existingBtn.remove();
    }

    // Create delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-notif-btn';
    deleteBtn.style.cssText = `
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(135deg, var(--danger-color), #DC2626);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        animation: slideInRight 0.3s ease;
    `;
    deleteBtn.innerHTML = '<i class="bi bi-trash-fill"></i> Remove';

    // Add click handler
    deleteBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        e.preventDefault();
        await deleteNotification(notificationId, itemElement);
    });

    // Make item relative positioned
    itemElement.style.position = 'relative';
    
    // Add button to item
    itemElement.appendChild(deleteBtn);

    // Auto-remove button after 3 seconds
    setTimeout(() => {
        if (deleteBtn.parentNode === itemElement) {
            deleteBtn.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (deleteBtn.parentNode) deleteBtn.remove();
            }, 300);
        }
    }, 3000);

    console.log("ðŸ—‘ï¸ Delete option shown for:", notificationId);
}

async function deleteNotification(notificationId, itemElement = null) {
    if (!currentUser || !notificationId) {
        console.error("âŒ Invalid parameters:", { currentUser, notificationId });
        return;
    }

    try {
        console.log("ðŸ—‘ï¸ Deleting notification:", notificationId);
        
        const notifRef = ref(db, `notifications/${currentUser.uid}/${notificationId}`);
        
        // Complete deletion instead of soft delete
        await set(notifRef, null);
        
        console.log("âœ… Notification deleted from database");
        
        // Remove from UI immediately
        if (itemElement && itemElement.parentNode) {
            itemElement.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (itemElement.parentNode) {
                    itemElement.remove();
                }
                
                // Check if no notifications left
                const notificationsList = document.getElementById('notificationsListEl');
                if (notificationsList && notificationsList.children.length === 0) {
                    const noNotificationsMessage = document.getElementById('noNotificationsMessageEl');
                    if (noNotificationsMessage) {
                        noNotificationsMessage.style.display = 'block';
                        noNotificationsMessage.innerHTML = `
                            <div class="empty-state">
                                <i class="bi bi-inbox empty-state-icon"></i>
                                <div class="empty-state-title">No Notifications</div>
                                <div class="empty-state-text">You're all caught up! ðŸŽ‰</div>
                            </div>
                        `;
                    }
                }
            }, 300);
        }
        
        showToast('âœ… Notification removed', 'success', 2000);
        
        // Reload notifications list after 500ms
        setTimeout(() => {
            loadNotifications();
        }, 500);
        
        console.log("âœ… Notification UI updated");
        
    } catch (error) {
        console.error('âŒ Delete notification error:', error);
        showToast(`Failed to delete: ${error.message}`, 'error');
        loadNotifications();
    }
}

        function updateUnreadNotificationCount(count) {
            unreadNotificationsCount = count;
            if (elements.notificationBadge) {
                if (count > 0) {
                    elements.notificationBadge.textContent = count > 9 ? '9+' : count;
                    elements.notificationBadge.style.display = 'flex';
                } else {
                    elements.notificationBadge.style.display = 'none';
                }
            }
        }

        async function loadChatMessages() {
    console.log("ðŸ’¬ Loading Chat Messages");

    if (!currentUser || !elements.chatMessages) return;

    const chatRef = ref(db, 'chat');
    
    if (dbListeners['chat']) {
        off(chatRef, 'value', dbListeners['chat']);
        delete dbListeners['chat'];
    }

    // âœ… FIX: Show loading only on initial load
    const isInitialLoad = !elements.chatMessages.dataset.loaded;
    
    if (isInitialLoad) {
        elements.chatMessages.innerHTML = `
            <div class="text-center p-5">
                <div class="spinner-border text-accent" style="width: 3rem; height: 3rem;"></div>
                <p class="mt-3 text-secondary">Loading messages...</p>
            </div>
        `;
    }

    const chatListener = onValue(chatRef, async (snapshot) => {
        if (snapshot.exists()) {
            const messages = snapshot.val();
            const messagesArray = Object.entries(messages)
                .filter(([, msg]) => !msg.deleted)
                .map(([id, msg]) => ({ id, ...msg }))
                .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

            // âœ… FIX: Cache user data to avoid repeated fetches
            const userCache = {};
            
            // âœ… FIX: Batch load all unique users at once
            const uniqueUserIds = [...new Set(messagesArray.map(m => m.userId).filter(Boolean))];
            
            await Promise.all(uniqueUserIds.map(async (userId) => {
                try {
                    const userRef = ref(db, `users/${userId}`);
                    const userSnap = await get(userRef);
                    if (userSnap.exists()) {
                        const userData = userSnap.val();
                        userCache[userId] = {
                            photoURL: userData.photoURL,
                            totalMatches: userData.totalMatches || 0
                        };
                    }
                } catch (e) {
                    console.error("Error loading user:", userId, e);
                }
            }));

            // âœ… FIX: Build all messages at once without delay
            const fragment = document.createDocumentFragment();

            for (const msg of messagesArray) {
                const isOwnMessage = msg.userId === currentUser.uid;
                const messageDiv = document.createElement('div');
                // âœ… FIX: Only animate NEW messages, not initial load
                const isNewMessage = elements.chatMessages.dataset.loaded === 'true';
                messageDiv.className = `chat-message ${isOwnMessage ? 'own-message' : ''} ${isNewMessage ? 'new-message' : ''}`;

                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleString([], { timeStyle: 'short' }) : '';
                // âœ… FIX: Use cached user data instead of repeated fetches
                const userData = userCache[msg.userId];
                let avatar = msg.userAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(msg.userName)}&background=random&size=40`;
                
                if (userData?.photoURL) {
                    avatar = userData.photoURL;
                }

                // âœ… FIX: Badge from cached data
                let chatBadgeHTML = '';
                if (userData?.totalMatches) {
                    const chatTier = getUserBadgeTier(userData.totalMatches);
                    chatBadgeHTML = createBadgeHTML(chatTier, 'small');
                }

                const editedBadge = msg.edited ? ' <span style="color: var(--text-secondary); font-size: 0.7rem;">(edited)</span>' : '';
                
                // âœ… DOWNLOAD & VISIT BUTTONS
                let actionButtonsHTML = '';
                if (msg.downloadLink) {
                    actionButtonsHTML += `
                        <a href="${msg.downloadLink}" target="_blank" class="btn btn-sm btn-custom-accent mt-2 me-2" style="padding: 6px 12px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px; text-decoration: none;">
                            <i class="bi bi-download"></i> Download
                        </a>
                    `;
                }
                if (msg.visitLink) {
                    actionButtonsHTML += `
                        <a href="${msg.visitLink}" target="_blank" class="btn btn-sm btn-custom-primary mt-2" style="padding: 6px 12px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px; text-decoration: none;">
                            <i class="bi bi-box-arrow-up-right"></i> Visit
                        </a>
                    `;
                }

                messageDiv.innerHTML = `
    <img src="${avatar}" alt="${msg.userName}" class="chat-avatar" onerror="this.src='https://ui-avatars.com/api/?name=User&background=334155&color=94A3B8&size=40'">
    <div class="chat-bubble">
                        <div class="chat-user-name">${msg.userName}${chatBadgeHTML}${editedBadge}</div>                        <div class="chat-text">${msg.message}</div>
                        ${actionButtonsHTML}
                        <div class="chat-time">${time}</div>
                    </div>
                `;

                if (isOwnMessage) {
                    let pressTimer;
                    
                    messageDiv.addEventListener('touchstart', (e) => {
                        pressTimer = setTimeout(() => {
                            showChatMessageOptions(msg.id, msg.message);
                        }, 500);
                    });
                    
                    messageDiv.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                    });
                    
                    messageDiv.addEventListener('touchmove', () => {
                        clearTimeout(pressTimer);
                    });
                    
                    messageDiv.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showChatMessageOptions(msg.id, msg.message);
                    });
                }

                fragment.appendChild(messageDiv);
            }

            // Add all messages at once
            elements.chatMessages.appendChild(fragment);

            // Scroll to bottom smoothly
            requestAnimationFrame(() => {
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            });
        } else {
            // Show empty state if no messages
            elements.chatMessages.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi bi-chat-text"></i>
                    </div>
                    <div class="empty-state-title">Start Chatting!</div>
                    <div class="empty-state-text">Send a message to start conversation with other players</div>
                </div>
            `;
        }
    });

    dbListeners['chat'] = chatListener;
}

// Load Socials Page Data - NEW
async function loadSocialsPageData() {
    if (!currentUser) return;

    try {
        // Update total friends count
        const friendsRef = ref(db, `friends/${currentUser.uid}`);
        const friendsSnapshot = await get(friendsRef);
        
        let totalFriends = 0;
        if (friendsSnapshot.exists()) {
            const friends = friendsSnapshot.val();
            totalFriends = Object.values(friends).filter(f => f.status === 'accepted').length;
        }
        
        const totalFriendsEl = document.getElementById('totalFriendsCount');
        if (totalFriendsEl) totalFriendsEl.textContent = totalFriends;

        // Update pending requests count
        const requestsRef = ref(db, `friendRequests/${currentUser.uid}`);
        const requestsSnapshot = await get(requestsRef);
        
        let pendingRequests = 0;
        if (requestsSnapshot.exists()) {
            const requests = requestsSnapshot.val();
            pendingRequests = Object.values(requests).filter(r => r.status === 'pending').length;
        }
        
        const pendingRequestsEl = document.getElementById('pendingRequestsCount');
        if (pendingRequestsEl) pendingRequestsEl.textContent = pendingRequests;

        // Update badges
        const requestsBadge = document.getElementById('requestsBadge1');
        if (requestsBadge) {
            if (pendingRequests > 0) {
                requestsBadge.textContent = pendingRequests;
                requestsBadge.style.display = 'inline-block';
            } else {
                requestsBadge.style.display = 'none';
            }
        }

        // Update social notification badge in profile
        const socialBadge = document.getElementById('socialNotificationBadge');
        if (socialBadge) {
            if (pendingRequests > 0) {
                socialBadge.textContent = pendingRequests;
                socialBadge.style.display = 'inline-block';
            } else {
                socialBadge.style.display = 'none';
            }
        }

    } catch (e) {
        console.error("âŒ Load socials data error:", e);
    }
}

        // ðŸ†• =========================
// ðŸ†• PREMIUM BADGE SYSTEM
// ðŸ†• =========================

const BADGE_TIERS = {
    bronze: {
        name: 'Bronze Explorer',
        icon: 'ðŸ¥‰',
        minMatches: 0,
        color: '#CD7F32',
        gradient: 'linear-gradient(135deg, #CD7F32, #8B4513)',
        glow: 'rgba(205, 127, 50, 0.4)',
        animation: 'none'
    },
    silver: {
        name: 'Silver Champion',
        icon: 'ðŸ¥ˆ',
        minMatches: 10,
        color: '#C0C0C0',
        gradient: 'linear-gradient(135deg, #C0C0C0, #A8A8A8)',
        glow: 'rgba(192, 192, 192, 0.6)',
        animation: 'silverShine 3s ease-in-out infinite'
    },
    gold: {
        name: 'Gold Legend',
        icon: 'ðŸ¥‡',
        minMatches: 50,
        color: '#FFD700',
        gradient: 'linear-gradient(135deg, #FFD700, #FFA500)',
        glow: 'rgba(255, 215, 0, 0.8)',
        animation: 'goldGlow 2s ease-in-out infinite'
    },
    platinum: {
        name: 'Platinum Elite',
        icon: 'ðŸ’Ž',
        minMatches: 100,
        color: '#E5E4E2',
        gradient: 'linear-gradient(135deg, #E5E4E2 0%, #B9B8B6 50%, #E5E4E2 100%)',
        glow: 'rgba(229, 228, 226, 1)',
        animation: 'platinumGlow 2s ease-in-out infinite, platinumShine 3s linear infinite'
    }
};

function getUserBadgeTier(totalMatches) {
    if (totalMatches >= 100) return 'platinum';
    if (totalMatches >= 50) return 'gold';
    if (totalMatches >= 10) return 'silver';
    return 'bronze';
}

function createBadgeHTML(tier, size = 'medium') {
    // âœ… FIX: Only Gold & Platinum badges show karo
    if (tier !== 'gold' && tier !== 'platinum') {
        return ''; // Bronze aur Silver ke liye kuch nahi
    }
    
    const badge = BADGE_TIERS[tier];
    if (!badge) return '';
    
    const sizes = {
        small: { fontSize: '0.65rem', padding: '3px 8px', icon: '0.75rem' },
        medium: { fontSize: '0.75rem', padding: '4px 12px', icon: '0.9rem' },
        large: { fontSize: '0.85rem', padding: '6px 16px', icon: '1.1rem' }
    };
    
    const s = sizes[size];
    
    // âœ… FIX: "EXPLORER", "CHAMPION", "LEGEND", "ELITE" remove karo - sirf icon rakho
    const displayText = badge.icon; // Only emoji icon
    
    return `
        <span class="premium-badge premium-badge-${tier}" 
              style="
                  display: inline-flex;
                  align-items: center;
                  gap: 6px;
                  background: ${badge.gradient};
                  color: var(--primary-bg);
                  padding: ${s.padding};
                  border-radius: 14px;
                  font-size: ${s.fontSize};
                  font-weight: 700;
                  box-shadow: 0 2px 8px ${badge.glow};
                  position: relative;
                  overflow: hidden;
                  animation: ${badge.animation};
                  border: 2px solid ${badge.color};
                  margin-left: 6px;
                  vertical-align: middle;
              ">
            <span style="position: relative; z-index: 1;">${displayText}</span>
        </span>
    `;
}

// VIP Program Page (existing function ko update karo)
async function loadVIPProgramPage() {
    if (!currentUser) return;

    const vipCurrentTierName = document.getElementById('vipCurrentTierNameEl');
    const vipCurrentTierDesc = document.getElementById('vipCurrentTierDescEl');
    const vipTierProgressText = document.getElementById('vipTierProgressTextEl');
    const vipTierProgressFill = document.getElementById('vipTierProgressFillEl');
    const vipTierProgressHint = document.getElementById('vipTierProgressHintEl');

    if (!vipCurrentTierName) return;

    try {
        const totalMatches = userProfile.totalMatches || 0;
        const currentTier = getUserBadgeTier(totalMatches);
        const badge = BADGE_TIERS[currentTier];

        let nextTier = 'Max Level';
        let requiredMatches = 100;
        let progress = 100;

        if (totalMatches < 10) {
            nextTier = 'Silver Champion';
            requiredMatches = 10;
            progress = (totalMatches / 10) * 100;
        } else if (totalMatches < 50) {
            nextTier = 'Gold Legend';
            requiredMatches = 50;
            progress = ((totalMatches - 10) / 40) * 100;
        } else if (totalMatches < 100) {
            nextTier = 'Platinum Elite';
            requiredMatches = 100;
            progress = ((totalMatches - 50) / 50) * 100;
        }

        vipCurrentTierName.innerHTML = `${badge.icon} ${badge.name}`;
        vipCurrentTierName.style.color = badge.color;
        
        vipCurrentTierDesc.textContent = `You are in ${badge.name} tier (${totalMatches} matches played)`;
        
        vipTierProgressText.textContent = `${Math.round(progress)}%`;
        vipTierProgressFill.style.width = `${Math.min(progress, 100)}%`;
        vipTierProgressFill.style.background = badge.gradient;
        
        if (progress < 100) {
            const matchesNeeded = requiredMatches - totalMatches;
            vipTierProgressHint.textContent = `${matchesNeeded} more match${matchesNeeded === 1 ? '' : 'es'} to reach ${nextTier}`;
        } else {
            vipTierProgressHint.textContent = 'Maximum tier reached! ðŸŽ‰';
        }

        console.log(`âœ… VIP Tier Loaded: ${badge.name} (${totalMatches} matches)`);

    } catch (e) {
        console.error("âŒ Load VIP program error:", e);
        vipCurrentTierName.textContent = 'Error';
        vipCurrentTierDesc.textContent = 'Failed to load tier info';
    }
}

// ðŸ†• Show Edit/Delete Options Modal
function showChatMessageOptions(messageId, currentMessage) {
    if (!currentUser || !messageId) return;
    
    console.log("ðŸ’¬ Showing message options for:", messageId);
    
    // Create overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 10000;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        animation: fadeIn 0.2s ease;
    `;
    
    // Create options panel
    const panel = document.createElement('div');
    panel.style.cssText = `
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.98) 100%);
        backdrop-filter: blur(20px);
        border-radius: 20px 20px 0 0;
        padding: 25px;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(250, 204, 21, 0.3);
        animation: slideUp 0.3s ease;
    `;
    
    panel.innerHTML = `
        <h4 style="color: var(--text-primary); font-weight: 700; margin-bottom: 20px; text-align: center;">
            <i class="bi bi-chat-dots-fill" style="color: var(--accent-color);"></i>
            Message Options
        </h4>
        
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <button class="btn btn-custom btn-custom-primary w-100 ripple" id="editMessageBtn" style="padding: 14px 20px; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <i class="bi bi-pencil-fill" style="font-size: 1.2rem;"></i>
                <span>Edit Message</span>
            </button>
            
            <button class="btn btn-custom btn-custom-secondary w-100 ripple" id="deleteMessageBtn" style="padding: 14px 20px; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, var(--danger-color), #DC2626); color: white;">
                <i class="bi bi-trash-fill" style="font-size: 1.2rem;"></i>
                <span>Delete Message</span>
            </button>
            
            <button class="btn btn-custom btn-custom-secondary w-100 ripple" id="cancelMessageBtn" style="padding: 14px 20px; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <i class="bi bi-x-circle" style="font-size: 1.2rem;"></i>
                <span>Cancel</span>
            </button>
        </div>
    `;
    
    overlay.appendChild(panel);
    document.body.appendChild(overlay);
    
    // Close function
    const closePanel = () => {
        overlay.style.animation = 'fadeOut 0.2s ease';
        panel.style.animation = 'slideDown 0.3s ease';
        setTimeout(() => {
            if (overlay.parentNode) {
                overlay.remove();
            }
        }, 200);
    };
    
    // Edit button
    const editBtn = panel.querySelector('#editMessageBtn');
    editBtn.addEventListener('click', () => {
        closePanel();
        editChatMessage(messageId, currentMessage);
    });
    
    // Delete button
    const deleteBtn = panel.querySelector('#deleteMessageBtn');
    deleteBtn.addEventListener('click', async () => {
        closePanel();
        await deleteChatMessage(messageId);
    });
    
    // Cancel button
    const cancelBtn = panel.querySelector('#cancelMessageBtn');
    cancelBtn.addEventListener('click', closePanel);
    
    // Close on overlay click
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            closePanel();
        }
    });
}

// âœ… Edit Chat Message Function
async function editChatMessage(messageId, currentMessage) {
    if (!currentUser || !elements.chatInput) return;
    
    console.log("âœï¸ Editing message:", messageId);
    
    elements.chatInput.value = currentMessage;
    elements.chatInput.focus();
    elements.chatInput.style.border = '2px solid var(--accent-color)';
    elements.chatInput.style.boxShadow = '0 0 0 0.25rem rgba(250, 204, 21, 0.25)';
    
    const originalSendHandler = elements.chatSendBtn.onclick;
    const originalHTML = elements.chatSendBtn.innerHTML;
    
    elements.chatSendBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
    elements.chatSendBtn.style.background = 'linear-gradient(135deg, #10B981, #059669)';
    
    showToast('âœï¸ Editing message... (Press ESC to cancel)', 'info', 3000);
    
    const editHandler = async () => {
        const newMessage = elements.chatInput.value.trim();
        if (!newMessage) {
            showToast('Message cannot be empty', 'warning');
            return;
        }
        
        if (newMessage === currentMessage) {
            showToast('No changes made', 'info');
            cancelEdit();
            return;
        }
        
        try {
            elements.chatSendBtn.disabled = true;
            elements.chatSendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            
            const messageRef = ref(db, `chat/${messageId}`);
            await update(messageRef, {
                message: newMessage,
                edited: true,
                editedAt: Date.now()
            });
            
            cancelEdit();
            showToast('âœ… Message updated!', 'success');
            console.log("âœ… Message edited successfully");
        } catch (e) {
            console.error("âŒ Edit failed:", e);
            showToast('Failed to edit message', 'error');
            elements.chatSendBtn.disabled = false;
            elements.chatSendBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
        }
    };
    
    const cancelEdit = () => {
        elements.chatInput.value = '';
        elements.chatInput.style.border = '';
        elements.chatInput.style.boxShadow = '';
        elements.chatSendBtn.innerHTML = originalHTML;
        elements.chatSendBtn.style.background = '';
        elements.chatSendBtn.disabled = false;
        elements.chatSendBtn.onclick = originalSendHandler;
        elements.chatInput.onkeypress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        };
    };
    
    elements.chatSendBtn.onclick = editHandler;
    
    elements.chatInput.onkeypress = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            editHandler();
        }
        if (e.key === 'Escape') {
            cancelEdit();
        }
    };
}

// âœ… Delete Chat Message Function
async function deleteChatMessage(messageId) {
    if (!currentUser) return;
    
    if (!confirm('Delete this message permanently?')) return;
    
    console.log("ðŸ—‘ï¸ Deleting message:", messageId);
    
    try {
        const messageRef = ref(db, `chat/${messageId}`);
        
        // Complete deletion
        await set(messageRef, null);
        
        showToast('âœ… Message deleted', 'success');
        console.log("âœ… Message deleted successfully");
    } catch (e) {
        console.error("âŒ Delete failed:", e);
        showToast('Failed to delete message', 'error');
    }
}

        async function sendChatMessage() {
    if (!currentUser || !elements.chatInput) return;

    const message = elements.chatInput.value.trim();
    if (!message) {
        showToast('Please enter a message', 'warning');
        return;
    }

    // Prevent duplicate sends
    if (elements.chatSendBtn.disabled) {
        console.log("âš ï¸ Already sending message...");
        return;
    }

    elements.chatSendBtn.disabled = true;
    elements.chatSendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    elements.chatInput.disabled = true;

    try {
        const chatRef = ref(db, 'chat');
        
        // Parse for download and visit links
        const downloadMatch = message.match(/download:\s*(https?:\/\/[^\s]+)/i);
        const visitMatch = message.match(/visit:\s*(https?:\/\/[^\s]+)/i);
        
        let cleanMessage = message;
        let downloadLink = null;
        let visitLink = null;
        
        if (downloadMatch) {
            downloadLink = downloadMatch[1];
            cleanMessage = cleanMessage.replace(downloadMatch[0], '').trim();
        }
        
        if (visitMatch) {
            visitLink = visitMatch[1];
            cleanMessage = cleanMessage.replace(visitMatch[0], '').trim();
        }

        const newMessage = {
            userId: currentUser.uid,
            userName: userProfile.displayName || currentUser.email?.split('@')[0] || 'User',
            userAvatar: userProfile.photoURL || null,
            message: cleanMessage || message,
            timestamp: Date.now()
        };

        if (downloadLink) newMessage.downloadLink = downloadLink;
        if (visitLink) newMessage.visitLink = visitLink;

        await push(chatRef, newMessage);
        
        elements.chatInput.value = '';
        console.log("âœ… Chat message sent successfully");
        
        // Re-enable after 1 second
        setTimeout(() => {
            elements.chatSendBtn.disabled = false;
            elements.chatSendBtn.innerHTML = '<i class="bi bi-send-fill"></i>';
            elements.chatInput.disabled = false;
            elements.chatInput.focus();
        }, 1000);
        
    } catch (error) {
        console.error("âŒ Failed to send chat message:", error);
        showToast('Failed to send message: ' + error.message, 'error');
        
        elements.chatSendBtn.disabled = false;
        elements.chatSendBtn.innerHTML = '<i class="bi bi-send-fill"></i>';
        elements.chatInput.disabled = false;
    }
}

        async function recordTransaction(userId, type, amount, description, balanceType = 'bonusCash') {
            if (!userId) return;
            const transactionRef = ref(db, `transactions/${userId}`);
            const newTransaction = {
                type,
                amount,
                description,
                timestamp: Date.now(),
                balanceType: balanceType
            };
            try {
                await push(transactionRef, newTransaction);
                console.log(`ðŸ’³ Transaction recorded: ${type}, â‚¹${amount}, Type: ${balanceType}`);
            } catch (e) {
                console.error("âŒ Transaction record failed:", e);
            }
        }

        async function loadRecentTransactions() {
            console.log("ðŸ“œ Loading Recent Transactions");

            if (!currentUser || !elements.recentTransactionsList) return;

            const limit = 5;
            elements.recentTransactionsList.innerHTML = '';
            elements.recentTransactionsList.classList.add('placeholder-glow');
            for (let i = 0; i < 3; i++) {
                elements.recentTransactionsList.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5" style="height:16px"></span><span class="placeholder col-3" style="height:16px"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6" style="height:14px"></span></div></div>`;
            }
            if (elements.noTransactionsMessage) {
                elements.noTransactionsMessage.style.display = 'block';
                elements.noTransactionsMessage.textContent = 'Loading...';
            }

            try {
                const transRef = query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit));
                const s = await get(transRef);
                const transactions = s.val() || {};
                const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                console.log(`Found ${sortedT.length} recent transactions`);

                removePlaceholders(elements.recentTransactionsList);
                elements.recentTransactionsList.innerHTML = '';

                if (sortedT.length > 0) {
                    if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none';

                    sortedT.forEach(t => {
                        const item = document.createElement('div');
                        item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center';
                        const isCredit = t.amount > 0;
                        const amt = `${isCredit ? '+' : ''}â‚¹${Math.abs(t.amount || 0).toFixed(2)}`;
                        const time = t.timestamp ? new Date(t.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';
                        item.innerHTML = `<div><div class="small fw-bold">${t.description || t.type || 'Transaction'}</div><div class="small text-secondary">${time}</div></div><div class="fw-bold ${isCredit ? 'text-success' : 'text-danger'}">${amt}</div>`;
                        elements.recentTransactionsList.appendChild(item);
                    });
                } else if (elements.noTransactionsMessage) {
                    elements.noTransactionsMessage.style.display = 'block';
                    elements.noTransactionsMessage.textContent = 'No transactions yet';
                }
            } catch (e) {
                console.error("âŒ Transactions load failed:", e);
                removePlaceholders(elements.recentTransactionsList);
                elements.recentTransactionsList.innerHTML = '<p class="text-danger text-center">Could not load transactions</p>';
                if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none';
            }
        }

        async function loadFullTransactionHistory() {
            console.log("ðŸ“œ Loading Full Transaction History");

            if (!currentUser || !elements.fullTransactionsList) return;

            elements.fullTransactionsList.innerHTML = '';
            elements.fullTransactionsList.classList.add('placeholder-glow');
            for (let i = 0; i < 5; i++) {
                elements.fullTransactionsList.innerHTML += `<div class="transaction-item placeholder-glow mb-2"><div class="transaction-header"><span class="placeholder col-5" style="height: 18px;"></span><span class="placeholder col-3" style="height: 20px;"></span></div><div class="transaction-details"><span class="placeholder col-8" style="height: 14px;"></span></div></div>`;
            }
            if (elements.noFullTransactionsMessage) {
                elements.noFullTransactionsMessage.style.display = 'none';
            }

            try {
                const transRef = ref(db, `transactions/${currentUser.uid}`);
                const snapshot = await get(transRef);

                removePlaceholders(elements.fullTransactionsList);
                elements.fullTransactionsList.innerHTML = '';

                if (snapshot.exists()) {
                    const transactions = snapshot.val();
                    const transArray = Object.entries(transactions)
                        .map(([id, trans]) => ({ id, ...trans }))
                        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    console.log(`Found ${transArray.length} total transactions`);

                    if (transArray.length > 0) {
                        transArray.forEach(trans => {
                            const item = document.createElement('div');
                            item.className = 'transaction-item';

                            const isCredit = trans.amount > 0;
                            const time = trans.timestamp ? new Date(trans.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';
                            const amount = `${isCredit ? '+' : ''}â‚¹${Math.abs(trans.amount || 0).toFixed(2)}`;

                            item.innerHTML = `
                                <div class="transaction-header">
                                    <span class="transaction-type">${trans.description || trans.type || 'Transaction'}</span>
                                    <span class="transaction-amount ${isCredit ? 'credit' : 'debit'}">${amount}</span>
                                </div>
                                <div class="transaction-details">${time}</div>
                            `;

                            elements.fullTransactionsList.appendChild(item);
                        });
                    } else {
                        if (elements.noFullTransactionsMessage) {
                            elements.noFullTransactionsMessage.style.display = 'block';
                        }
                    }
                } else {
                    if (elements.noFullTransactionsMessage) {
                        elements.noFullTransactionsMessage.style.display = 'block';
                    }
                }
            } catch (e) {
                console.error("âŒ Full transaction history load failed:", e);
                removePlaceholders(elements.fullTransactionsList);
                elements.fullTransactionsList.innerHTML = '<p class="text-danger text-center">Could not load transaction history</p>';
            }
        }

        async function loadWithdrawHistory() {
            console.log("ðŸ’¸ Loading Withdraw History");

            if (!currentUser || !elements.withdrawHistoryList) return;

            elements.withdrawHistoryList.innerHTML = '';
            elements.withdrawHistoryList.classList.add('placeholder-glow');
            for (let i = 0; i < 3; i++) {
                elements.withdrawHistoryList.innerHTML += `<div class="transaction-item placeholder-glow mb-2"><div class="transaction-header"><span class="placeholder col-5" style="height: 18px;"></span><span class="placeholder col-3" style="height: 20px;"></span></div><div class="transaction-details"><span class="placeholder col-8" style="height: 14px;"></span></div></div>`;
            }
            if (elements.noWithdrawHistoryMessage) {
                elements.noWithdrawHistoryMessage.style.display = 'none';
            }

            try {
                const withdrawRef = ref(db, 'withdrawals');
                const q = query(withdrawRef, orderByChild('userId'), equalTo(currentUser.uid));
                const snapshot = await get(q);

                removePlaceholders(elements.withdrawHistoryList);
                elements.withdrawHistoryList.innerHTML = '';

                if (snapshot.exists()) {
                    const withdrawals = snapshot.val();
                    const withdrawArray = Object.entries(withdrawals)
                        .map(([id, withdraw]) => ({ id, ...withdraw }))
                        .sort((a, b) => (b.requestTimestamp || 0) - (a.requestTimestamp || 0));

                    console.log(`Found ${withdrawArray.length} withdrawals`);

                    if (withdrawArray.length > 0) {
                        withdrawArray.forEach(withdraw => {
                            const item = document.createElement('div');
                            item.className = 'transaction-item';

                            const time = withdraw.requestTimestamp ? new Date(withdraw.requestTimestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';
                            const statusBadge = withdraw.status === 'approved' ? '<span class="badge bg-success">Approved</span>' :
                                withdraw.status === 'rejected' ? '<span class="badge bg-danger">Rejected</span>' :
                                    '<span class="badge bg-warning">Pending</span>';

                            item.innerHTML = `
                                <div class="transaction-header">
                                    <span class="transaction-type">Withdraw Request ${statusBadge}</span>
                                    <span class="transaction-amount debit">-â‚¹${(withdraw.amount || 0).toFixed(2)}</span>
                                </div>
                                <div class="transaction-details">
                                    ${withdraw.methodDetails?.accountInfo || 'N/A'} â€¢ ${time}
                                </div>
                            `;

                            elements.withdrawHistoryList.appendChild(item);
                        });
                    } else {
                        if (elements.noWithdrawHistoryMessage) {
                            elements.noWithdrawHistoryMessage.style.display = 'block';
                        }
                    }
                } else {
                    if (elements.noWithdrawHistoryMessage) {
                        elements.noWithdrawHistoryMessage.style.display = 'block';
                    }
                }
            } catch (e) {
                console.error("âŒ Withdraw history load failed:", e);
                removePlaceholders(elements.withdrawHistoryList);
                elements.withdrawHistoryList.innerHTML = '<p class="text-danger text-center">Could not load withdraw history</p>';
            }
        }

        async function loadMatchHistory() {
            console.log("ðŸŽ¯ Loading Match History");

            if (!currentUser || !elements.matchHistoryList) return;

            elements.matchHistoryList.innerHTML = '';
            elements.matchHistoryList.classList.add('placeholder-glow');
            for (let i = 0; i < 3; i++) {
                elements.matchHistoryList.innerHTML += `<div class="match-history-item placeholder-glow mb-2"><div class="match-history-header"><span class="placeholder col-6" style="height: 18px;"></span><span class="placeholder col-3" style="height: 20px; border-radius: 20px;"></span></div><div class="match-history-details mt-2"><div class="match-detail-item"><span class="placeholder col-8" style="height: 14px;"></span><span class="placeholder col-6 mt-1" style="height: 16px;"></span></div></div></div>`;
            }
            if (elements.noMatchHistoryMessage) {
                elements.noMatchHistoryMessage.style.display = 'none';
            }

            try {
                const joinedIds = Object.keys(userProfile.joinedTournaments || {});

                if (joinedIds.length === 0) {
                    removePlaceholders(elements.matchHistoryList);
                    elements.matchHistoryList.innerHTML = '';
                    if (elements.noMatchHistoryMessage) {
                        elements.noMatchHistoryMessage.style.display = 'block';
                        elements.noMatchHistoryMessage.textContent = 'No match history found';
                    }
                    return;
                }

                const matchPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`)));
                const snapshots = await Promise.all(matchPromises);

                removePlaceholders(elements.matchHistoryList);
                elements.matchHistoryList.innerHTML = '';

                const matches = [];
                snapshots.forEach((snapshot, index) => {
                    if (snapshot.exists()) {
                        const t = snapshot.val();
                        matches.push({ id: joinedIds[index], ...t });
                    }
                });

                matches.sort((a, b) => (b.startTime || 0) - (a.startTime || 0));

                if (matches.length > 0) {
                    matches.forEach(match => {
                        const item = document.createElement('div');
                        item.className = 'match-history-item';

                        const isWin = match.winners && match.winners[currentUser.uid];
                        const time = match.startTime ? new Date(match.startTime).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';

                        item.innerHTML = `
                            <div class="match-history-header">
                                <span class="match-tournament-name">${match.name || 'Tournament'}</span>
                                <span class="match-result-badge ${isWin ? 'win' : 'loss'}">${isWin ? 'Won' : 'Played'}</span>
                            </div>
                            <div class="match-history-details">
                                <div class="match-detail-item">
                                    <span>Date</span>
                                    <strong>${time}</strong>
                                </div>
                                <div class="match-detail-item">
                                    <span>Prize Pool</span>
                                    <strong>â‚¹${match.prizePool || 0}</strong>
                                </div>
                                <div class="match-detail-item">
                                    <span>Entry Fee</span>
                                    <strong>â‚¹${match.entryFee || 0}</strong>
                                </div>
                            </div>
                        `;

                        elements.matchHistoryList.appendChild(item);
                    });
                } else {
                    if (elements.noMatchHistoryMessage) {
                        elements.noMatchHistoryMessage.style.display = 'block';
                    }
                }
            } catch (e) {
                console.error("âŒ Match history load failed:", e);
                removePlaceholders(elements.matchHistoryList);
                elements.matchHistoryList.innerHTML = '<p class="text-danger text-center">Could not load match history</p>';
            }
        }

        const handleJoinTournamentClick = (function () {
            let isProcessing = false;

            return async function (event) {
                if (isProcessing) {
                    console.log("âš ï¸ Already processing join request, ignoring click...");
                    return;
                }

                if (!currentUser) {
                    showToast("Please login to join tournaments", 'warning');
                    showSection('login-section');
                    return;
                }

                const btn = event.currentTarget;
                const tId = btn.dataset.tournamentId;
                const fee = parseFloat(btn.dataset.fee || 0);
                const matchType = btn.dataset.matchType || 'Solo';

                if (!tId) return;

                try {
                    const tRef = ref(db, `tournaments/${tId}`);
                    const tSnapshot = await get(tRef);

                    if (!tSnapshot.exists()) {
                        throw new Error("Tournament not found");
                    }

                    const tData = tSnapshot.val();
                    currentJoiningTournament = { id: tId, data: tData, fee: fee };

                    showTeamDetailsModal(matchType, tData);

                } catch (e) {
                    console.error("âŒ Error loading tournament:", e);
                    showToast(`Error: ${e.message}`, 'error');
                }
            };
        })();

        function showTeamDetailsModal(matchType, tournamentData) {
            if (!elements.teamDetailsModalInstance) {
                const modalEl = document.getElementById('teamDetailsModalEl');
                elements.teamDetailsModalInstance = new bootstrap.Modal(modalEl);
            }

            clearStatusMessage(elements.teamDetailsStatusMessage);
            elements.teamDetailsInputSection.innerHTML = '';

            let infoText = '';
            let inputsHTML = '';

            if (matchType === 'Solo' || !matchType) {
                infoText = 'Enter your Game UID to join this solo tournament.';
                inputsHTML = `
                    <div class="section-title">
                        <i class="bi bi-person-fill"></i>
                        Solo Player Details
                    </div>
                    <div class="team-member-input">
                        <label for="playerUid1">Your Game UID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="playerUid1" placeholder="Enter your game UID" required>
                    </div>
                `;
            } else if (matchType === 'Duo') {
                infoText = 'Enter both players\' Game UIDs to join this duo tournament.';
                inputsHTML = `
                    <div class="section-title">
                        <i class="bi bi-people-fill"></i>
                        Duo Team Details
                    </div>
                    <div class="team-member-input">
                        <label for="playerUid1">Player 1 Game UID (You) <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="playerUid1" placeholder="Enter your game UID" required>
                    </div>
                    <div class="team-member-input">
                        <label for="playerUid2">Player 2 Game UID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="playerUid2" placeholder="Enter partner's game UID" required>
                    </div>
                `;
            } else if (matchType === 'Squad') {
                infoText = 'Enter all 4 squad members\' Game UIDs to join this squad tournament.';
                inputsHTML = `
                    <div class="section-title">
                        <i class="bi bi-people-fill"></i>
                        Squad Team Details
                    </div>
                    <div class="team-member-input">
                        <label for="playerUid1">Player 1 Game UID (You) <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="playerUid1" placeholder="Enter your game UID" required>
                    </div>
                    <div class="team-member-input">
                        <label for="playerUid2">Player 2 Game UID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="playerUid2" placeholder="Enter teammate's game UID" required>
                    </div>
                    <div class="team-member-input">
                        <label for="playerUid3">Player 3 Game UID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="playerUid3" placeholder="Enter teammate's game UID" required>
                    </div>
                    <div class="team-member-input">
                        <label for="playerUid4">Player 4 Game UID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="playerUid4" placeholder="Enter teammate's game UID" required>
                    </div>
                `;
            }

            elements.teamDetailsInfoText.textContent = infoText;
            elements.teamDetailsInputSection.innerHTML = `
                <div class="team-details-section">
                    ${inputsHTML}
                </div>
            `;

            elements.teamDetailsModalInstance.show();
        }

        async function submitTeamDetails() {
            if (!currentUser || !currentJoiningTournament) return;

            // âœ… VALIDATE SESSION
            if (!auth.currentUser || auth.currentUser.uid !== currentUser.uid) {
                showToast("âŒ Session expired. Please login again.", 'error');
                await logoutUser();
                return;
            }

            const tId = currentJoiningTournament.id;
            const tData = currentJoiningTournament.data;
            const fee = currentJoiningTournament.fee;
            const matchType = tData.matchType || 'Solo';

            clearStatusMessage(elements.teamDetailsStatusMessage);

            const teamUIDs = [];
            let requiredFields = 1;

            if (matchType === 'Duo') requiredFields = 2;
            else if (matchType === 'Squad') requiredFields = 4;

            for (let i = 1; i <= requiredFields; i++) {
                const input = document.getElementById(`playerUid${i}`);
                if (!input || !input.value.trim()) {
                    showStatusMessage(elements.teamDetailsStatusMessage, `Please enter Player ${i} Game UID`, 'warning');
                    showToast(`Player ${i} UID is required`, 'warning');
                    return;
                }
                teamUIDs.push(input.value.trim());
            }

            const uniqueUIDs = new Set(teamUIDs);
            if (uniqueUIDs.size !== teamUIDs.length) {
                showStatusMessage(elements.teamDetailsStatusMessage, 'All player UIDs must be unique', 'warning');
                showToast('Duplicate UIDs not allowed', 'warning');
                return;
            }

            elements.submitTeamDetailsBtn.disabled = true;
            elements.submitTeamDetailsBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

            try {
                const tRef = ref(db, `tournaments/${tId}`);
                const tSnapshot = await get(tRef);

                if (!tSnapshot.exists()) {
                    throw new Error("Tournament not found");
                }

                const latestTData = tSnapshot.val();

                if (latestTData.status !== 'upcoming') {
                    throw new Error("Tournament is not accepting registrations");
                }

                const regCount = latestTData.registeredPlayers ? Object.keys(latestTData.registeredPlayers).length : 0;
                if (latestTData.maxPlayers > 0 && regCount >= latestTData.maxPlayers) {
                    throw new Error("Tournament is full");
                }

                const winningCash = Number(userProfile.winningCash || 0);
                const cashBalance = Number(userProfile.cashBalance || 0);
                const bonusCash = Number(userProfile.bonusCash || 0);
                const totalBalance = winningCash + cashBalance + bonusCash;

// Only check balance if entry fee is greater than 0
if (fee > 0 && totalBalance < fee) {
    throw new Error(`Insufficient balance! You have â‚¹${totalBalance.toFixed(2)} but need â‚¹${fee.toFixed(2)}`);
}

                if (!confirm(`Join this tournament for â‚¹${fee.toFixed(2)}?\n\nYour balance: â‚¹${totalBalance.toFixed(2)}`)) {
                    elements.submitTeamDetailsBtn.disabled = false;
                    elements.submitTeamDetailsBtn.innerHTML = '<i class="bi bi-check-circle"></i> Join Tournament';
                    return;
                }

                const uRef = ref(db, `users/${currentUser.uid}`);
                let transactionResult = null;

                transactionResult = await runTransaction(uRef, (profileData) => {
                    if (!profileData) {
                        throw new Error("User profile not found");
                    }

                    if (profileData.joinedTournaments?.[tId]) {
                        throw new Error("You have already joined this tournament");
                    }

                    const winningCash = Number(profileData.winningCash || 0);
                    const cashBalance = Number(profileData.cashBalance || 0);
                    const bonusCash = Number(profileData.bonusCash || 0);
                    const totalBalance = winningCash + cashBalance + bonusCash;

                    if (totalBalance < fee) {
                        throw new Error(`Insufficient balance! You have â‚¹${totalBalance.toFixed(2)} but need â‚¹${fee.toFixed(2)}`);
                    }

                    let remainingFee = fee;
let newWinning = winningCash;
let newCash = cashBalance;
let newBonus = bonusCash;

// âœ… FIX: Deduct order changed to Bonus â†’ Cash â†’ Winning
if (remainingFee > 0 && newBonus > 0) {
    const deduct = Math.min(newBonus, remainingFee);
    newBonus -= deduct;
    remainingFee -= deduct;
}

if (remainingFee > 0 && newCash > 0) {
    const deduct = Math.min(newCash, remainingFee);
    newCash -= deduct;
    remainingFee -= deduct;
}

if (remainingFee > 0 && newWinning > 0) {
    const deduct = Math.min(newWinning, remainingFee);
    newWinning -= deduct;
    remainingFee -= deduct;
}

                    profileData.winningCash = newWinning;
                    profileData.cashBalance = newCash;
                    profileData.bonusCash = newBonus;

                    if (!profileData.joinedTournaments) profileData.joinedTournaments = {};
                    profileData.joinedTournaments[tId] = true;

                    if (!profileData.totalMatches) profileData.totalMatches = 0;
                    profileData.totalMatches += 1;
                    
                    // Track total spent for Big Spender achievement
                    if (!profileData.totalSpent) profileData.totalSpent = 0;
                    profileData.totalSpent += fee;
                    
                    // Track last join date for Daily Grinder
                    if (!profileData.lastJoinDate) profileData.lastJoinDate = null;
                    if (!profileData.joinStreak) profileData.joinStreak = 0;
                    
                    const today = new Date().toDateString();
                    const lastJoin = profileData.lastJoinDate ? new Date(profileData.lastJoinDate).toDateString() : null;
                    
                    if (lastJoin !== today) {
                        // Check if consecutive day
                        const yesterday = new Date(Date.now() - 86400000).toDateString();
                        if (lastJoin === yesterday) {
                            profileData.joinStreak += 1;
                        } else {
                            profileData.joinStreak = 1;
                        }
                        profileData.lastJoinDate = Date.now();
                    }

                    return profileData
                });

                if (!transactionResult.committed) {
                    if (userProfile?.joinedTournaments?.[tId]) {
                        throw new Error("You have already joined this tournament");
                    } else {
                        throw new Error("Failed to join tournament. Please try again.");
                    }
                }

                console.log("âœ… Balance deducted successfully");

                const currentSlotNumber = regCount + 1;

                const teamData = {
                    userId: currentUser.uid,
                    userName: userProfile.displayName || currentUser.email,
                    joinedAt: serverTimestamp(),
                    slotNumber: currentSlotNumber,
                    matchType: matchType,
                    teamUIDs: teamUIDs
                };

                const updates = {};
                updates[`tournaments/${tId}/registeredPlayers/${currentUser.uid}`] = teamData;

                await update(ref(db), updates);
                console.log("âœ… Successfully joined tournament with slot:", currentSlotNumber);

                await recordTransaction(currentUser.uid, 'tournament_join', -fee, `Joined: ${tData.name || 'Tournament'}`, 'mixed');
                
                // Update achievements
                if (userProfile.totalMatches === 1) {
                    await updateAchievementProgress('tournament_join', 1);
                }
                
                // Quick Joiner achievement
                await updateAchievementProgress('quick_join', 1, tData);
                
                // Daily Grinder achievement
                if (userProfile.joinStreak === 7) {
                    await updateAchievementProgress('daily_streak', 7);
                }
                
                // Big Spender achievement
                if (userProfile.totalSpent >= 500) {
                    await updateAchievementProgress('total_spent', 500);
                }

                await invalidateCache('all');

                showStatusMessage(elements.teamDetailsStatusMessage, `âœ… Successfully joined! Your Slot Number: ${currentSlotNumber}`, 'success', false);
                showToast(`âœ… Joined successfully! Slot #${currentSlotNumber}`, 'success', 6000);

                setTimeout(() => {
                    const modalEl = document.getElementById('teamDetailsModalEl');
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    if (modalInstance) modalInstance.hide();

                    clearStatusMessage(elements.teamDetailsStatusMessage);
                    currentJoiningTournament = null;
                }, 3000);

                const finalSnapshot = await get(tRef);
                if (finalSnapshot.exists()) {
                    const finalTData = finalSnapshot.val();
                    const cardEl = document.querySelector(`.tournament-card[data-tournament-id="${tId}"]`);
                    if (cardEl && cardEl.parentNode) {
                        cardEl.parentNode.replaceChild(createTournamentCardElement(tId, finalTData), cardEl);
                    }
                    if (currentSectionId === 'home-section') loadMyContests();
                }
                if (currentSectionId === 'wallet-section') loadRecentTransactions();

            } catch (e) {
                console.error("âŒ Join failed:", e);

                let errorMessage = e.message || "Failed to join tournament";

                if (errorMessage.includes("Insufficient balance")) {
                    showStatusMessage(elements.teamDetailsStatusMessage, `âŒ ${errorMessage}`, 'danger');
                    showToast(`âŒ ${errorMessage}`, 'error', 6000);
                } else if (errorMessage.includes("already joined")) {
                    showStatusMessage(elements.teamDetailsStatusMessage, `âš ï¸ ${errorMessage}`, 'warning');
                    showToast(`âš ï¸ ${errorMessage}`, 'warning', 4000);
                } else if (errorMessage.includes("full")) {
                    showStatusMessage(elements.teamDetailsStatusMessage, `âš ï¸ Tournament is full`, 'warning');
                    showToast(`âš ï¸ Tournament is full`, 'warning', 4000);
                } else if (errorMessage.includes("not accepting")) {
                    showStatusMessage(elements.teamDetailsStatusMessage, `âš ï¸ Tournament is not accepting registrations`, 'warning');
                    showToast(`âš ï¸ Tournament is not accepting registrations`, 'warning', 4000);
                } else {
                    showStatusMessage(elements.teamDetailsStatusMessage, `âŒ ${errorMessage}`, 'danger');
                    showToast(`âŒ ${errorMessage}`, 'error', 5000);
                }
            } finally {
                elements.submitTeamDetailsBtn.disabled = false;
                elements.submitTeamDetailsBtn.innerHTML = '<i class="bi bi-check-circle"></i> Join Tournament';
            }
        }

        function setupUtrTypeSelector() {
    const utrTypeBtns = document.querySelectorAll('.utr-type-btn');

    utrTypeBtns.forEach(btn => {
        btn.addEventListener('click', function () {
            utrTypeBtns.forEach(b => b.classList.remove('active'));

            this.classList.add('active');

            selectedUtrType = this.dataset.utrType;

            if (elements.addUtrInput) {
                if (selectedUtrType === '12') {
                    // PhonePe: 12-35 alphanumeric
                    elements.addUtrInput.maxLength = 35;
                    elements.addUtrInput.pattern = '[A-Za-z0-9]*';
                    elements.addUtrInput.inputMode = 'text';
                    elements.addUtrInput.placeholder = 'Enter PhonePe Transaction ID (12-35 chars)';

                    if (elements.utrDigitDisplay) {
                        elements.utrDigitDisplay.textContent = '12-35';
                    }
                    if (elements.utrHelperText) {
                        elements.utrHelperText.innerHTML = '<i class="bi bi-exclamation-circle"></i> TID must be 12-35 characters (letters & numbers only)';
                    }
                } else if (selectedUtrType === '16') {
                    // Other Method: 10-50 alphanumeric
                    elements.addUtrInput.maxLength = 50;
                    elements.addUtrInput.pattern = '[A-Za-z0-9]*';
                    elements.addUtrInput.inputMode = 'text';
                    elements.addUtrInput.placeholder = 'Enter Transaction ID (10-50 chars)';

                    if (elements.utrDigitDisplay) {
                        elements.utrDigitDisplay.textContent = '10-50';
                    }
                    if (elements.utrHelperText) {
                        elements.utrHelperText.innerHTML = '<i class="bi bi-exclamation-circle"></i> TID must be 10-50 characters (letters & numbers only)';
                    }
                }

                elements.addUtrInput.value = '';
                elements.addUtrInput.classList.remove('is-valid', 'is-invalid');
            }

            console.log(`âœ… UTR Type selected: ${selectedUtrType}`);
        });
    });
}

        function setupUtrValidation() {
    if (!elements.addUtrInput) return;

    elements.addUtrInput.addEventListener('input', (e) => {
        const value = e.target.value;

        if (selectedUtrType === '12') {
            // PhonePe: 12-35 alphanumeric
            const isValid = /^[A-Za-z0-9]{0,35}$/.test(value);

            if (!isValid) {
                // Remove non-alphanumeric characters and limit to 35
                e.target.value = value.replace(/[^A-Za-z0-9]/g, '').slice(0, 35);
            }

            const length = e.target.value.length;
            if (length >= 12 && length <= 35) {
                e.target.classList.add('is-valid');
                e.target.classList.remove('is-invalid');
            } else if (length > 0) {
                e.target.classList.add('is-invalid');
                e.target.classList.remove('is-valid');
            } else {
                e.target.classList.remove('is-valid', 'is-invalid');
            }
        } else if (selectedUtrType === '16') {
            // Other Method: 10-50 alphanumeric
            const isValid = /^[A-Za-z0-9]{0,50}$/.test(value);

            if (!isValid) {
                // Remove non-alphanumeric characters and limit to 50
                e.target.value = value.replace(/[^A-Za-z0-9]/g, '').slice(0, 50);
            }

            const length = e.target.value.length;
            if (length >= 10 && length <= 50) {
                e.target.classList.add('is-valid');
                e.target.classList.remove('is-invalid');
            } else if (length > 0) {
                e.target.classList.add('is-invalid');
                e.target.classList.remove('is-valid');
            } else {
                e.target.classList.remove('is-valid', 'is-invalid');
            }
        }
    });

    console.log("âœ… UTR validation attached");
}

        async function submitAddAmountRequest() {
            console.log("ðŸ”µ submitAddAmountRequest called!");

            if (!currentUser) {
                showToast("Please login first", 'warning');
                showSection('login-section');
                return;
            }

            const amount = parseFloat(elements.addAmountInput.value);
            const utrId = elements.addUtrInput.value.trim();

            console.log("Amount:", amount);
            console.log("UTR:", utrId);
            console.log("UTR Type:", selectedUtrType);

            clearStatusMessage(elements.addAmountStatusMessage);

            if (isNaN(amount) || amount <= 0) {
                showStatusMessage(elements.addAmountStatusMessage, 'Enter a valid amount', 'warning');
                showToast('Please enter a valid amount', 'warning');
                return;
            }

            if (amount < 1) {
    showStatusMessage(elements.addAmountStatusMessage, 'Please enter a valid amount', 'warning');
    showToast('Please enter a valid amount', 'warning');
    return;
}

            if (!utrId) {
                showStatusMessage(elements.addAmountStatusMessage, 'Enter UTR/Transaction ID', 'warning');
                showToast('Please enter UTR/Transaction ID', 'warning');
                return;
            }

            if (selectedUtrType === '12') {
                // PhonePe: 12-35 alphanumeric
                if (!/^[A-Za-z0-9]+$/.test(utrId)) {
                    showStatusMessage(elements.addAmountStatusMessage, 'PhonePe TID must contain only letters and numbers (no spaces or special characters)', 'danger');
                    showToast('Invalid PhonePe TID format', 'error');
                    return;
                }

                if (utrId.length < 12 || utrId.length > 35) {
                    showStatusMessage(elements.addAmountStatusMessage, 'PhonePe TID must be 12-35 characters', 'danger');
                    showToast('PhonePe TID must be 12-35 characters', 'error');
                    return;
                }
            } else if (selectedUtrType === '16') {
                // Other Method: 10-50 alphanumeric
                if (!/^[A-Za-z0-9]+$/.test(utrId)) {
                    showStatusMessage(elements.addAmountStatusMessage, 'Transaction ID must contain only letters and numbers (no spaces or special characters)', 'danger');
                    showToast('Invalid Transaction ID format', 'error');
                    return;
                }

                if (utrId.length < 10 || utrId.length > 50) {
                    showStatusMessage(elements.addAmountStatusMessage, 'Transaction ID must be 10-50 characters', 'danger');
                    showToast('Transaction ID must be 10-50 characters', 'error');
                    return;
                }
            }

            elements.submitAddAmountBtn.disabled = true;
            elements.submitAddAmountBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Submitting...';

            try {
                const addBalanceRef = ref(db, 'addBalanceRequests');
                const newRequest = {
                    userId: currentUser.uid,
                    userName: userProfile.displayName || currentUser.email,
                    userEmail: currentUser.email || 'N/A',
                    amount: amount,
                    utrId: utrId,
                    utrType: selectedUtrType,
                    status: 'pending',
                    requestTimestamp: serverTimestamp()
                };

                await push(addBalanceRef, newRequest);
                console.log("âœ… Add balance request submitted");

                showStatusMessage(elements.addAmountStatusMessage, 'âœ… Request submitted successfully! Your amount will be added after admin verification. You will receive a notification once approved.', 'success', false);
                showToast('âœ… Request submitted! Waiting for admin approval.', 'success', 5000);

                elements.addAmountInput.value = '';
                elements.addUtrInput.value = '';
                elements.addUtrInput.classList.remove('is-valid', 'is-invalid');

                setTimeout(() => {
                    const modalEl = document.getElementById('addAmountModalEl');
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    if (modalInstance) modalInstance.hide();
                    clearStatusMessage(elements.addAmountStatusMessage);
                }, 3000);

            } catch (e) {
                console.error("âŒ Add amount request error:", e);
                showStatusMessage(elements.addAmountStatusMessage, `Error: ${e.message}`, 'danger');
                showToast(`Error: ${e.message}`, 'error');
            } finally {
                elements.submitAddAmountBtn.disabled = false;
                elements.submitAddAmountBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Request';
            }
        }

        function handleWithdrawClick() {
            if (!currentUser) return;

            const wc = userProfile.winningCash || 0;
            const minW = appSettings?.minWithdraw || 50;

            if (elements.minWithdrawAmount) elements.minWithdrawAmount.textContent = minW;
            if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = `â‚¹${wc.toFixed(2)}`;
            if (elements.withdrawAmountInput) {
                elements.withdrawAmountInput.value = '';
                elements.withdrawAmountInput.min = minW;
            }
            if (elements.withdrawMethodInput) elements.withdrawMethodInput.value = userProfile.upiId || '';

            clearStatusMessage(elements.withdrawStatusMessage);

            const modalEl = document.getElementById('withdrawModalEl');
            const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInstance.show();
        }

        async function submitWithdrawRequestHandler() {
            if (!currentUser) return;

            const amt = parseFloat(elements.withdrawAmountInput.value);
            const mtd = elements.withdrawMethodInput.value.trim();
            const wc = userProfile.winningCash || 0;
            const minW = appSettings?.minWithdraw || 50;

            clearStatusMessage(elements.withdrawStatusMessage);

            if (isNaN(amt) || amt <= 0) {
                showStatusMessage(elements.withdrawStatusMessage, 'Invalid amount', 'warning');
                showToast('Please enter a valid amount', 'warning');
                return;
            }
            if (amt < minW) {
                showStatusMessage(elements.withdrawStatusMessage, `Minimum withdrawal: â‚¹${minW}`, 'warning');
                showToast(`Minimum withdrawal: â‚¹${minW}`, 'warning');
                return;
            }
            if (amt > wc) {
                showStatusMessage(elements.withdrawStatusMessage, 'Insufficient winning balance', 'warning');
                showToast('Insufficient balance', 'warning');
                return;
            }
            if (!mtd) {
                showStatusMessage(elements.withdrawStatusMessage, 'Enter withdrawal method Phone Pe/Other method', 'warning');
                showToast('Please enter Phone Pe/Other method', 'warning');
                return;
            }

            elements.submitWithdrawRequestBtn.disabled = true;
            elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

            let transactionCommitted = false;

            try {
                const uRef = ref(db, `users/${currentUser.uid}`);
                const txResult = await runTransaction(uRef, (prof) => {
                    if (prof) {
                        if ((prof.winningCash || 0) >= amt) {
                            prof.winningCash = (prof.winningCash || 0) - amt;
                            return prof;
                        } else {
                            throw new Error("Insufficient winning balance");
                        }
                    } else {
                        throw new Error("Profile not found");
                    }
                });

                if (!txResult.committed) {
                    throw new Error("Failed to update balance");
                }

                transactionCommitted = true;
                console.log("Winning cash deducted");

                const wrRef = ref(db, 'withdrawals');
                const newReq = {
                    userId: currentUser.uid,
                    userName: userProfile.displayName || currentUser.email,
                    amount: amt,
                    methodDetails: {
                        methodName: mtd.includes('@') ? 'UPI' : 'Phone Pe/Other method',
                        accountInfo: mtd
                    },
                    status: 'pending',
                    requestTimestamp: serverTimestamp(),
                    userEmail: currentUser.email || 'N/A'
                };
                await push(wrRef, newReq);
                console.log("âœ… Withdrawal request created");

                await recordTransaction(currentUser.uid, 'withdraw_request', -amt, `Withdrawal Request to ${mtd}`, 'winningCash');

                showStatusMessage(elements.withdrawStatusMessage, 'âœ… Request submitted successfully!', 'success', false);
                showToast('âœ… Withdrawal request submitted!', 'success');

                setTimeout(() => {
                    const modalEl = document.getElementById('withdrawModalEl');
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    if (modalInstance) modalInstance.hide();
                }, 2500);

                if (currentSectionId === 'wallet-section') loadRecentTransactions();

            } catch (e) {
                console.error("âŒ Withdraw error:", e);
                showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}`, 'danger');
                showToast(`Error: ${e.message}`, 'error');

                if (transactionCommitted) {
                    console.warn("âš ï¸ Attempting refund...");
                    const uRef = ref(db, `users/${currentUser.uid}`);
                    try {
                        await runTransaction(uRef, (prof) => {
                            if (prof) {
                                prof.winningCash = (prof.winningCash || 0) + amt;
                            }
                            return prof;
                        });
                        await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amt, `Refund Failed Withdrawal`, 'winningCash');
                        console.log("âœ… Refund successful");
                        showToast('Amount refunded to your account', 'info');
                    } catch (refundError) {
                        console.error("âŒ CRITICAL: REFUND FAILED!", {
                            error: refundError,
                            userId: currentUser.uid,
                            amount: amt,
                            timestamp: new Date().toISOString()
                        });

                        await push(ref(db, 'criticalErrors'), {
                            type: 'REFUND_FAILURE',
                            userId: currentUser.uid,
                            userName: userProfile.displayName || currentUser.email,
                            amount: amt,
                            error: refundError.message,
                            timestamp: serverTimestamp()
                        });

                        showStatusMessage(elements.withdrawStatusMessage, `CRITICAL: Error occurred and refund failed! Contact support immediately. Amount: â‚¹${amt.toFixed(2)}`, 'danger', false);
                        showToast(`CRITICAL: Refund failed! Contact support. Amount: â‚¹${amt.toFixed(2)}`, 'error', 10000);
                    }
                }
            } finally {
                elements.submitWithdrawRequestBtn.disabled = false;
                elements.submitWithdrawRequestBtn.innerHTML = 'Submit Request';
            }
        }

// After tournament completes, update user's completedTournaments
async function onTournamentComplete(tournamentId, userId, rank) {
    const userRef = ref(db, `users/${userId}`);
    
    await runTransaction(userRef, (userData) => {
        if (userData) {
            if (!userData.completedTournaments) userData.completedTournaments = 0;
            userData.completedTournaments += 1;
            
            if (!userData.top5Finishes) userData.top5Finishes = 0;
            if (rank <= 5) userData.top5Finishes += 1;
            
            if (!userData.top3History) userData.top3History = [];
            if (rank <= 3) {
                userData.top3History.push({
                    tournamentId: tournamentId,
                    rank: rank,
                    timestamp: Date.now()
                });
                
                // Keep only last 10 records
                if (userData.top3History.length > 10) {
                    userData.top3History = userData.top3History.slice(-10);
                }
            }
        }
        return userData;
    });
    
    // Update achievements
    await updateAchievementProgress('tournament_complete', 1);
    
    if (userData.completedTournaments === 50) {
        await updateAchievementProgress('tournament_complete_50', 50);
    }
    
    if (rank === 1) {
        await updateAchievementProgress('tournament_win', 1);
    }
    
    if (rank <= 5 && userData.top5Finishes >= 3) {
        await updateAchievementProgress('top5_multi', 3);
    }
    
    // Check top3 streak
    if (userData.top3History && userData.top3History.length >= 3) {
        const last3 = userData.top3History.slice(-3);
        const isConsecutive = last3.every((entry, i) => {
            if (i === 0) return true;
            return entry.timestamp - last3[i-1].timestamp <= 604800000; // Within 7 days
        });
        
        if (isConsecutive) {
            await updateAchievementProgress('top3_streak', 3);
        }
    }
}

        async function handleMatchDetailsClick(event) {
            if (!elements.matchDetailsModalInstance) {
                const modalEl = document.getElementById('matchDetailsModalEl');
                elements.matchDetailsModalInstance = new bootstrap.Modal(modalEl);
            }

            const tId = event.currentTarget.dataset.tournamentId;
            if (!tId) return;

            elements.matchDetailsModalTitle.textContent = 'Loading...';
            elements.matchDetailsModalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>';

            elements.matchDetailsModalInstance.show();

            try {
                const tRef = ref(db, `tournaments/${tId}`);
                const s = await get(tRef);

                if (s.exists()) {
                    const t = s.val();
                    const gName = appSettings.games?.[t.gameId]?.name || t.gameId || 'N/A';
                    const sTimeLoc = t.startTime ? new Date(t.startTime).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' }) : 'TBA';

                    let pDistHTML = '';
                    if (t.prizeDistribution) {
                        let fmtDist = '';
                        if (typeof t.prizeDistribution === 'object') {
                            fmtDist = Object.entries(t.prizeDistribution)
                                .map(([rank, prize]) => `Rank ${rank}: â‚¹${prize}`)
                                .join('\n');
                        } else {
                            fmtDist = String(t.prizeDistribution).replace(/\\n/g, '\n');
                        }
                        pDistHTML = `<h5 class="mt-3">Prize Distribution:</h5><pre style="background: var(--primary-bg); padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.85rem; white-space: pre-wrap;">${fmtDist}</pre>`;
                    }

                    const desc = t.description || 'Standard tournament rules apply.';
                    const fmtDesc = desc.replace(/\n/g, '<br>');

                    elements.matchDetailsModalTitle.textContent = t.name || 'Match Details';
                    elements.matchDetailsModalBody.innerHTML = `
                        <p><strong>Game:</strong> ${gName}</p>
                        <p><strong>Mode:</strong> ${t.mode || 'N/A'}</p>
                        <p><strong>Map:</strong> ${t.map || 'N/A'}</p>
                        <p><strong>Match Type:</strong> ${t.matchType || 'Solo'}</p>
                        <p><strong>Starts:</strong> ${sTimeLoc}</p>
                        <hr>
                        <p><strong>Entry Fee:</strong> ${t.entryFee > 0 ? `â‚¹${t.entryFee}` : 'Free'}</p>
                        <p><strong>Prize Pool:</strong> â‚¹${t.prizePool || 0}</p>
                        <p><strong>Per Kill Prize:</strong> â‚¹${t.perKillPrize || 0}</p>
                        <p><strong>Max Players:</strong> ${t.maxPlayers > 0 ? t.maxPlayers : 'Unlimited'}</p>
                        <hr>
                        <h5>Rules & Description:</h5>
                        <div style="white-space: pre-wrap; line-height: 1.6;">${fmtDesc}</div>
                        ${pDistHTML}
                    `;
                } else {
                    elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Tournament details not found</p>';
                }
            } catch (e) {
                console.error("âŒ Details load failed:", e);
                elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details</p>';
            }
        }

        async function handleIdPasswordClick(event) {
            const tId = event.currentTarget.dataset.tournamentId;
            if (!tId) return;

            if (!currentUser || !userProfile?.joinedTournaments?.[tId]) {
                showToast("You must join this tournament first", 'warning');
                return;
            }

            elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>';
            elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>';

            const modalEl = document.getElementById('idPasswordModalEl');
            const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInstance.show();

            try {
                const tournamentRef = ref(db, `tournaments/${tId}`);
                const s = await get(tournamentRef);

                removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));

                if (s.exists()) {
    const tournamentData = s.val();
    // Password hamesha show hoga agar available hai
    elements.roomIdDisplay.textContent = tournamentData.roomId || 'Not updated yet';
    elements.roomPasswordDisplay.textContent = tournamentData.roomPassword || 'Not updated yet';
}
            } catch (e) {
                console.error("âŒ ID/Pass fetch error:", e);
                removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));
                elements.roomIdDisplay.textContent = 'Error';
                elements.roomPasswordDisplay.textContent = 'Error';
                showToast("Error loading ID/Password", 'error');
            }
        }

        async function handleResultClaimClick(event) {
            const tId = event.currentTarget.dataset.tournamentId;
            if (!tId) return;

            if (!currentUser || !userProfile?.joinedTournaments?.[tId]) {
                showToast("You must join this tournament first", 'warning');
                return;
            }

            // Load and show results page
            showLoader(true);
            try {
                const tRef = ref(db, `tournaments/${tId}`);
                const snapshot = await get(tRef);

                if (!snapshot.exists()) {
                    throw new Error("Tournament not found");
                }

                const tournamentData = snapshot.val();
                
                // Show result section
                showSection('tournament-result-section');
                
                // Display tournament name
                const resultTournamentName = document.getElementById('resultTournamentNameEl');
                if (resultTournamentName) {
                    resultTournamentName.textContent = tournamentData.name || 'Tournament Results';
                }

                // Display top 3 winners
                if (tournamentData.winners && tournamentData.prizeDistribution) {
                    const winners = tournamentData.winners;
                    const prizes = tournamentData.prizeDistribution;

                    // First Place
                    const resultFirstName = document.getElementById('resultFirstNameEl');
                    const resultFirstPrize = document.getElementById('resultFirstPrizeEl');
                    if (winners['1']) {
                        const winnerData = winners['1'];
                        resultFirstName.textContent = winnerData.name || 'Winner';
                        resultFirstPrize.textContent = prizes['1'] ? `â‚¹${prizes['1']}` : 'â‚¹0';
                    } else {
                        resultFirstName.textContent = 'Not Announced';
                        resultFirstPrize.textContent = prizes['1'] ? `â‚¹${prizes['1']}` : 'â‚¹0';
                    }

                    // Second Place
                    const resultSecondName = document.getElementById('resultSecondNameEl');
                    const resultSecondPrize = document.getElementById('resultSecondPrizeEl');
                    if (winners['2']) {
                        const winnerData = winners['2'];
                        resultSecondName.textContent = winnerData.name || 'Runner Up';
                        resultSecondPrize.textContent = prizes['2'] ? `â‚¹${prizes['2']}` : 'â‚¹0';
                    } else {
                        resultSecondName.textContent = 'Not Announced';
                        resultSecondPrize.textContent = prizes['2'] ? `â‚¹${prizes['2']}` : 'â‚¹0';
                    }

                    // Third Place
                    const resultThirdName = document.getElementById('resultThirdNameEl');
                    const resultThirdPrize = document.getElementById('resultThirdPrizeEl');
                    if (winners['3']) {
                        const winnerData = winners['3'];
                        resultThirdName.textContent = winnerData.name || 'Third Place';
                        resultThirdPrize.textContent = prizes['3'] ? `â‚¹${prizes['3']}` : 'â‚¹0';
                    } else {
                        resultThirdName.textContent = 'Not Announced';
                        resultThirdPrize.textContent = prizes['3'] ? `â‚¹${prizes['3']}` : 'â‚¹0';
                    }

                    // Display full results list
                    const fullResultsList = document.getElementById('fullResultsListEl');
                    if (fullResultsList && prizes) {
                        fullResultsList.innerHTML = '';
                        
                        Object.entries(prizes).sort(([a], [b]) => parseInt(a) - parseInt(b)).forEach(([rank, prize]) => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'result-item';
                            resultItem.style.cssText = 'background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255, 255, 255, 0.05);';
                            
                            const winnerName = winners && winners[rank] ? winners[rank].name : 'Not Announced';
                            
                            let rankBadge = '';
                            if (rank === '1') {
                                rankBadge = `<span style="background: linear-gradient(135deg, #FFD700, #FFA500); color: var(--primary-bg); padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">#${rank}</span>`;
                            } else if (rank === '2') {
                                rankBadge = `<span style="background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: white; padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">#${rank}</span>`;
                            } else if (rank === '3') {
                                rankBadge = `<span style="background: linear-gradient(135deg, #CD7F32, #8B4513); color: white; padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">#${rank}</span>`;
                            } else {
                                rankBadge = `<span style="background: rgba(59, 130, 246, 0.2); color: var(--info-color); padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">#${rank}</span>`;
                            }
                            
                            resultItem.innerHTML = `
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    ${rankBadge}
                                    <span style="font-weight: 600; color: var(--text-primary);">${winnerName}</span>
                                </div>
                                <span style="font-weight: 700; font-size: 1.1rem; color: var(--accent-color);">â‚¹${prize}</span>
                            `;
                            
                            fullResultsList.appendChild(resultItem);
                        });
                    }
                } else {
                    // No winners announced yet
                    document.getElementById('resultFirstNameEl').textContent = 'Pending';
                    document.getElementById('resultSecondNameEl').textContent = 'Pending';
                    document.getElementById('resultThirdNameEl').textContent = 'Pending';
                    
                    const fullResultsList = document.getElementById('fullResultsListEl');
                    if (fullResultsList) {
                        fullResultsList.innerHTML = '<p class="text-warning text-center">Results not announced yet</p>';
                    }
                }

                showLoader(false);
                return; // Exit early, don't show claim modal

            } catch (e) {
                console.error("âŒ Result display error:", e);
                showToast("Error loading results", 'error');
                showLoader(false);
                return;
            }


            // OLD CLAIM MODAL CODE BELOW (Keep for backward compatibility)

            if (!elements.resultClaimModalInstance) {
                const modalEl = document.getElementById('resultClaimModalEl');
                elements.resultClaimModalInstance = new bootstrap.Modal(modalEl);
            }

            clearStatusMessage(elements.claimStatusMessage);
            elements.prizesList.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></div>';

            elements.resultClaimModalInstance.show();

            try {
                const tRef = ref(db, `tournaments/${tId}`);
                const snapshot = await get(tRef);

                if (!snapshot.exists()) {
                    throw new Error("Tournament not found");
                }

                const tournamentData = snapshot.val();
                elements.claimTournamentName.textContent = tournamentData.name || 'Tournament';

                elements.prizesList.innerHTML = '';

                if (tournamentData.prizeDistribution && typeof tournamentData.prizeDistribution === 'object') {
                    const prizes = Object.entries(tournamentData.prizeDistribution)
                        .sort(([rankA], [rankB]) => parseInt(rankA) - parseInt(rankB));

                    prizes.forEach(([rank, amount]) => {
                        const prizeItem = document.createElement('div');
                        prizeItem.className = 'prize-item';

                        prizeItem.innerHTML = `
                            <div class="prize-info">
                                <div class="prize-rank">#${rank} Position</div>
                                <div class="prize-amount">â‚¹${amount}</div>
                            </div>
                            <button class="prize-claim-btn ripple" data-tournament-id="${tId}" data-rank="${rank}" data-amount="${amount}">
                                <i class="bi bi-trophy-fill"></i> Claim
                            </button>
                        `;

                        const claimBtn = prizeItem.querySelector('.prize-claim-btn');
                        claimBtn.addEventListener('click', handlePrizeClaimSubmit);

                        elements.prizesList.appendChild(prizeItem);
                    });
                } else {
                    elements.prizesList.innerHTML = '<p class="text-secondary text-center">No prize distribution available</p>';
                }

            } catch (e) {
                console.error("âŒ Result claim modal error:", e);
                elements.prizesList.innerHTML = '<p class="text-danger text-center">Error loading prizes</p>';
            }
        }

        async function handlePrizeClaimSubmit(event) {
            if (!currentUser) return;

            const btn = event.currentTarget;
            const tId = btn.dataset.tournamentId;
            const rank = btn.dataset.rank;
            const amount = parseFloat(btn.dataset.amount);

            if (!tId || !rank) return;

            if (!confirm(`Claim prize for Rank #${rank} (â‚¹${amount})?\n\nAdmin will verify your claim.`)) {
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Claiming...';

            try {
                const claimRef = ref(db, 'prizeClaims');
                const newClaim = {
                    userId: currentUser.uid,
                    userName: userProfile.displayName || currentUser.email,
                    userEmail: currentUser.email || 'N/A',
                    tournamentId: tId,
                    tournamentName: elements.claimTournamentName.textContent,
                    rank: rank,
                    amount: amount,
                    status: 'pending',
                    claimTimestamp: serverTimestamp()
                };

                await push(claimRef, newClaim);
                console.log("âœ… Prize claim submitted");

                showStatusMessage(elements.claimStatusMessage, 'âœ… Claim submitted successfully! Admin will verify and approve your claim.', 'success', false);
                showToast('âœ… Prize claim submitted!', 'success');

                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Claimed';

            } catch (e) {
                console.error("âŒ Prize claim error:", e);
                showStatusMessage(elements.claimStatusMessage, `Error: ${e.message}`, 'danger');
                showToast(`Error: ${e.message}`, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-trophy-fill"></i> Claim';
            }
        }

        async function handlePolicyClick(event) {
            event.preventDefault();

            const target = event.currentTarget;
            const policyType = target.dataset.policy;
            if (!policyType) return;

            let title = '',
                modalBodyContent = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.policyModalBody.innerHTML = modalBodyContent;

            switch (policyType) {
                case 'privacy':
                    title = 'Privacy Policy';
                    modalBodyContent = appSettings.policyPrivacy || 'Privacy policy content not available.';
                    break;
                case 'terms':
                    title = 'Terms and Conditions';
                    modalBodyContent = appSettings.policyTerms || 'Terms and conditions not available.';
                    break;
                case 'refund':
                    title = 'Refund and Cancellation';
                    modalBodyContent = appSettings.policyRefund || 'Refund policy not available.';
                    break;
                case 'fairPlay':
                    title = 'Fair Play Policy';
                    modalBodyContent = appSettings.policyFairPlay || 'Fair play policy not available.';
                    break;
                case 'refer':
                    title = 'Refer & Earn';
                    if (!currentUser) {
                        showToast("Please login to view referral details", 'warning');
                        return;
                    }
                    const refCode = userProfile.referralCode || 'N/A';
                    const refBonus = appSettings.referralBonus || 5;
                    const refDesc = `Invite friends and earn â‚¹${refBonus} in cash balance when they sign up using your code! Your friend will also receive â‚¹${refBonus}.`;
                    modalBodyContent = `
                        <div class="text-center">
                            <h4>Refer Friends & Earn!</h4>
                            <p class="text-secondary">Share your code and both of you earn rewards</p>
                            <div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                                <p class="small text-secondary mb-1">Your Referral Code:</p>
                                <h3 class="text-accent referral-code" id="referralCodeDisplay">${refCode}</h3>
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn ripple" onclick="copyToClipboard('#referralCodeDisplay')">
                                        <i class="bi bi-clipboard"></i> Copy
                                    </button>
                                    <button class="btn btn-sm btn-custom btn-custom-secondary ripple" id="shareReferralBtn">
                                        <i class="bi bi-share-fill"></i> Share
                                    </button>
                                </div>
                            </div>
                            <p class="mt-3 small text-secondary">${refDesc}</p>
                            <div class="alert alert-info mt-3 text-start">
                                <strong>How it works:</strong>
                                <ol class="mb-0 mt-2" style="padding-left: 20px;">
                                    <li>Share your referral code with friends</li>
                                    <li>They sign up using your code</li>
                                    <li>You both receive â‚¹${refBonus} in cash balance</li>
                                    <li>No limit on referrals - invite more, earn more!</li>
                                </ol>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    title = 'Information';
                    modalBodyContent = '<p>Content not available.</p>';
            }

            elements.policyModalTitle.textContent = title;
            if (typeof modalBodyContent === 'string' && policyType !== 'refer') {
                elements.policyModalBody.innerHTML = modalBodyContent.replace(/\n/g, '<br>');
            } else {
                elements.policyModalBody.innerHTML = modalBodyContent;
            }

            const modalEl = document.getElementById('policyModalEl');
            const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modalInstance.show();

            if (policyType === 'refer') {
                setTimeout(() => {
                    const shareBtn = document.getElementById('shareReferralBtn');
                    if (shareBtn) {
                        shareBtn.addEventListener('click', () => {
                            const cel = getElement('referralCodeDisplay');
                            if (cel) shareReferral(cel.textContent);
                        });
                    }
                }, 100);
            }
        }

        async function handleUpdateNickname() {
            if (!currentUser) return;

            const newNickname = elements.editNicknameInput.value.trim();

            clearStatusMessage(elements.nicknameStatusMessage);

            if (!newNickname) {
                showStatusMessage(elements.nicknameStatusMessage, 'Please enter a nickname', 'warning');
                showToast('Please enter a nickname', 'warning');
                return;
            }

            if (newNickname.length < 3) {
                showStatusMessage(elements.nicknameStatusMessage, 'Nickname must be at least 3 characters', 'warning');
                showToast('Nickname must be at least 3 characters', 'warning');
                return;
            }

            elements.updateNicknameBtn.disabled = true;
            elements.updateNicknameBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Updating...';

            try {
                const userRef = ref(db, `users/${currentUser.uid}`);
                await update(userRef, { displayName: newNickname });

                console.log("âœ… Nickname updated");
                showStatusMessage(elements.nicknameStatusMessage, 'âœ… Nickname updated successfully!', 'success');
                showToast('âœ… Nickname updated!', 'success');

                setTimeout(() => {
                    showSection('profile-section');
                }, 2000);

            } catch (e) {
                console.error("âŒ Nickname update failed:", e);
                showStatusMessage(elements.nicknameStatusMessage, `Error: ${e.message}`, 'danger');
                showToast(`Error: ${e.message}`, 'error');
            } finally {
                elements.updateNicknameBtn.disabled = false;
                elements.updateNicknameBtn.innerHTML = '<i class="bi bi-check-circle"></i> Update Nickname';
            }
        }

        async function handleRedeemCoupon() {
            if (!currentUser) return;

            const couponCode = elements.couponCodeInput.value.trim().toUpperCase();

            clearStatusMessage(elements.couponStatusMessage);

            if (!couponCode) {
                showStatusMessage(elements.couponStatusMessage, 'Please enter a coupon code', 'warning');
                showToast('Please enter a coupon code', 'warning');
                return;
            }

            elements.redeemCouponBtn.disabled = true;
            elements.redeemCouponBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Redeeming...';

            try {
                const couponRef = ref(db, `coupons/${couponCode}`);
                const snapshot = await get(couponRef);

                if (!snapshot.exists()) {
                    showStatusMessage(elements.couponStatusMessage, 'Invalid coupon code', 'danger');
                    showToast('Invalid coupon code', 'error');
                    return;
                }

                const couponData = snapshot.val();

                if (!couponData.active) {
                    showStatusMessage(elements.couponStatusMessage, 'This coupon is no longer active', 'warning');
                    showToast('Coupon is not active', 'warning');
                    return;
                }

                if (couponData.expiryDate && couponData.expiryDate < Date.now()) {
                    showStatusMessage(elements.couponStatusMessage, 'This coupon has expired', 'warning');
                    showToast('Coupon has expired', 'warning');
                    return;
                }

                if (couponData.usedBy && couponData.usedBy[currentUser.uid]) {
                    showStatusMessage(elements.couponStatusMessage, 'You have already used this coupon', 'warning');
                    showToast('Already used this coupon', 'warning');
                    return;
                }

                if (couponData.maxUses && couponData.usedCount >= couponData.maxUses) {
                    showStatusMessage(elements.couponStatusMessage, 'This coupon has reached its usage limit', 'warning');
                    showToast('Coupon usage limit reached', 'warning');
                    return;
                }

                const couponAmount = couponData.amount || 0;

                if (couponAmount <= 0) {
                    showStatusMessage(elements.couponStatusMessage, 'Invalid coupon amount', 'danger');
                    showToast('Invalid coupon amount', 'error');
                    return;
                }

                const balanceType = couponData.balanceType || 'bonusCash';

                const userRef = ref(db, `users/${currentUser.uid}`);
                const updateResult = await runTransaction(userRef, (userData) => {
                    if (userData) {
                        if (balanceType === 'winningCash') {
                            userData.winningCash = (userData.winningCash || 0) + couponAmount;
                        } else if (balanceType === 'bonusCash') {
                            userData.bonusCash = (userData.bonusCash || 0) + couponAmount;
                        } else {
                            userData.cashBalance = (userData.cashBalance || 0) + couponAmount;
                        }
                        userData.couponEarnings = (userData.couponEarnings || 0) + couponAmount;
                        userData.totalEarnings = (userData.totalEarnings || 0) + couponAmount;
                    }
                    return userData;
                });

                if (updateResult.committed) {
                    const couponUpdates = {};
                    couponUpdates[`coupons/${couponCode}/usedBy/${currentUser.uid}`] = { timestamp: Date.now() };
                    couponUpdates[`coupons/${couponCode}/usedCount`] = (couponData.usedCount || 0) + 1;

                    await update(ref(db), couponUpdates);

                    await recordTransaction(currentUser.uid, 'coupon_redeemed', couponAmount, `Coupon Redeemed: ${couponCode}`, balanceType);
                    await recordEarning(currentUser.uid, 'coupon', couponAmount, `Coupon: ${couponCode}`);

                    console.log("âœ… Coupon redeemed successfully");
                    const balanceLabel = balanceType === 'winningCash' ? 'Winning Cash' : balanceType === 'bonusCash' ? 'Bonus Cash' : 'Cash Balance';
                    showStatusMessage(elements.couponStatusMessage, `âœ… Coupon redeemed! â‚¹${couponAmount.toFixed(2)} added to your ${balanceLabel}`, 'success', false);
                    showToast(`âœ… â‚¹${couponAmount.toFixed(2)} added to ${balanceLabel}!`, 'success', 5000);

                    elements.couponCodeInput.value = '';

                    setTimeout(() => {
                        showSection('profile-section');
                    }, 2000);

                    if (currentSectionId === 'wallet-section') loadRecentTransactions();
                } else {
                    throw new Error("Failed to update balance");
                }

            } catch (e) {
                console.error("âŒ Coupon redeem failed:", e);
                showStatusMessage(elements.couponStatusMessage, `Error: ${e.message}`, 'danger');
                showToast(`Error: ${e.message}`, 'error');
            } finally {
                elements.redeemCouponBtn.disabled = false;
                elements.redeemCouponBtn.innerHTML = '<i class="bi bi-gift-fill me-2"></i>Redeem Coupon';
            }
        }

        async function handleSendFeedback() {
            if (!currentUser) return;

            const feedbackMessage = elements.feedbackMessage.value.trim();

            clearStatusMessage(elements.feedbackStatusMessage);

            if (!feedbackMessage) {
                showStatusMessage(elements.feedbackStatusMessage, 'Please enter your feedback', 'warning');
                showToast('Please enter your feedback', 'warning');
                return;
            }

            if (feedbackMessage.length < 10) {
                showStatusMessage(elements.feedbackStatusMessage, 'Feedback must be at least 10 characters', 'warning');
                showToast('Feedback must be at least 10 characters', 'warning');
                return;
            }

            elements.sendFeedbackBtn.disabled = true;
            elements.sendFeedbackBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

            try {
                const feedbackRef = ref(db, 'feedbacks');
                const newFeedback = {
                    userId: currentUser.uid,
                    userName: userProfile.displayName || 'Anonymous',
                    userEmail: currentUser.email || 'N/A',
                    message: feedbackMessage,
                    timestamp: serverTimestamp(),
                    status: 'pending'
                };

                await push(feedbackRef, newFeedback);
                console.log("âœ… Feedback submitted");

                showStatusMessage(elements.feedbackStatusMessage, 'âœ… Thank you for your feedback! We appreciate your input.', 'success');
                showToast('âœ… Feedback submitted successfully!', 'success');
                elements.feedbackMessage.value = '';

                setTimeout(() => {
                    showSection('profile-section');
                }, 2000);

            } catch (e) {
                console.error("âŒ Feedback submission failed:", e);
                showStatusMessage(elements.feedbackStatusMessage, `Error: ${e.message}`, 'danger');
                showToast(`Error: ${e.message}`, 'error');
            } finally {
                elements.sendFeedbackBtn.disabled = false;
                elements.sendFeedbackBtn.innerHTML = '<i class="bi bi-chat-dots-fill me-2"></i>Send Feedback';
            }
        }

        function setupRealtimeListeners(uid) {
    if (!uid || !db || !currentUser) return;

    // âœ… NEW: Validate session matches current auth user
    if (auth.currentUser && auth.currentUser.uid !== uid) {
        console.error("âŒ Session mismatch detected! Expected:", uid, "Got:", auth.currentUser.uid);
        showToast("Session error. Please re-login.", 'error');
        logoutUser();
        return;
    }

    detachAllDbListeners();

    console.log("ðŸ”— Setting up realtime listeners for:", uid);

    const uRef = ref(db, `users/${uid}`);
            const listFunc = onValue(uRef, (s) => {
                if (currentUser && currentUser.uid === uid) {
                    if (s.exists()) {
                        userProfile = s.val();
                        populateUserInfo(currentUser, userProfile);

                        if (currentSectionId === 'home-section') {
                            loadMyContests();
                            loadMyGames('ongoing');
                        }
                        if (currentSectionId === 'wallet-section') loadRecentTransactions();
                        if (currentSectionId === 'earnings-section') loadEarningsData();
                        if (currentSectionId === 'leaderboard-section') loadLeaderboard();
                    } else {
                        console.warn("âš ï¸ User data deleted");
                        showToast("Account data missing. Logging out.", 'error');
                        logoutUser();
                    }
                }
            }, (e) => {
                console.error("âŒ User profile listener error:", e);
                retryOperation('userProfile', () => setupRealtimeListeners(uid), RETRY_DELAY);
            });

            dbListeners['userProfile'] = listFunc;

            setupNotificationsListener(uid);
        }

function openClaimModal(tId, tournamentData) {
            if (!currentUser || !userProfile?.joinedTournaments?.[tId]) {
                showToast("You must join this tournament first", 'warning');
                return;
            }

            if (!elements.resultClaimModalInstance) {
                const modalEl = document.getElementById('resultClaimModalEl');
                elements.resultClaimModalInstance = new bootstrap.Modal(modalEl);
            }

            clearStatusMessage(elements.claimStatusMessage);
            elements.prizesList.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.claimTournamentName.textContent = tournamentData.name || 'Tournament';

            elements.resultClaimModalInstance.show();

            // Build prize list
            elements.prizesList.innerHTML = '';

            if (tournamentData.prizeDistribution && typeof tournamentData.prizeDistribution === 'object') {
                const prizes = Object.entries(tournamentData.prizeDistribution)
                    .sort(([rankA], [rankB]) => parseInt(rankA) - parseInt(rankB));

                prizes.forEach(([rank, amount]) => {
                    const prizeItem = document.createElement('div');
                    prizeItem.className = 'prize-item';

                    prizeItem.innerHTML = `
                        <div class="prize-info">
                            <div class="prize-rank">#${rank} Position</div>
                            <div class="prize-amount">â‚¹${amount}</div>
                        </div>
                        <button class="prize-claim-btn ripple" data-tournament-id="${tId}" data-rank="${rank}" data-amount="${amount}">
                            <i class="bi bi-trophy-fill"></i> Claim
                        </button>
                    `;

                    const claimBtn = prizeItem.querySelector('.prize-claim-btn');
                    claimBtn.addEventListener('click', handlePrizeClaimSubmit);

                    elements.prizesList.appendChild(prizeItem);
                });
            } else {
                elements.prizesList.innerHTML = '<p class="text-secondary text-center">No prize distribution available</p>';
            }
        }

        function setupNotificationsListener(uid) {
            if (!uid || !db) return;
            console.log("ðŸ”” Setting up notifications listener");

            const notifRef = ref(db, `notifications/${uid}`);

            if (dbListeners['notifications']) {
                off(notifRef, 'value', dbListeners['notifications']);
                delete dbListeners['notifications'];
            }

            const notifListener = onValue(notifRef, (snapshot) => {
                if (currentUser && currentUser.uid === uid) {
                    if (snapshot.exists()) {
                        const notifications = snapshot.val();
                        const unreadCount = Object.values(notifications).filter(n => !n.read).length;
                        updateUnreadNotificationCount(unreadCount);

                        if (currentSectionId === 'notifications-section') {
                            loadNotifications();
                        }
                    } else {
                        updateUnreadNotificationCount(0);
                    }
                }
            }, (error) => {
                console.error("âŒ Notification listener error:", error);
            });

            dbListeners['notifications'] = notifListener;
        }
// Tournament updates ka listener add karo
if (currentTournamentGameId) {
    const tournamentsRef = ref(db, 'tournaments');
    const tournamentQuery = query(tournamentsRef, orderByChild('gameId'), equalTo(currentTournamentGameId));
    
    const tournamentListener = onValue(tournamentQuery, (snapshot) => {
        if (currentSectionId === 'tournaments-section') {
            const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
            filterTournaments(currentTournamentGameId, activeTab);
        }
    });
    
    dbListeners['tournaments'] = tournamentListener;
}

        function detachAllDbListeners(excludeSettings = false) {
    let count = 0;
    for (const k in dbListeners) {
        // âœ… FIX: Skip settings listener if excludeSettings is true
        if (excludeSettings && k === 'settings') {
            console.log("âš™ï¸ Keeping settings listener active");
            continue;
        }
        
        try {
            if (dbListeners[k]) {
                const listener = dbListeners[k];
                if (k === 'userProfile' && currentUser) {
                    off(ref(db, `users/${currentUser.uid}`), 'value', listener);
                } else if (k === 'notifications' && currentUser) {
                    off(ref(db, `notifications/${currentUser.uid}`), 'value', listener);
                } else if (k === 'settings') {
                    off(ref(db, 'settings'), 'value', listener);
                } else if (k === 'chat') {
                    off(ref(db, 'chat'), 'value', listener);
                } else if (k === 'tournaments') {
                    off(ref(db, 'tournaments'), 'value', listener);
                }
                count++;
                
                // âœ… FIX: Only delete if not excluded
                if (!excludeSettings || k !== 'settings') {
                    delete dbListeners[k];
                }
            }
        } catch (e) {
            console.error(`âŒ Detach error ${k}:`, e);
        }
    }
    
    // âœ… FIX: Don't reset entire dbListeners if excluding settings
    if (!excludeSettings) {
        dbListeners = {};
    }
    
    console.log(`ðŸ”Œ Detached ${count} listeners (excluded settings: ${excludeSettings})`);
}

function openUpdateProfilePictureSection() {
    if (!currentUser) {
        showToast('Please login first', 'warning');
        return;
    }

    showSection('update-profile-picture-section');
    
    const previewImg = document.getElementById('profilePicturePreview');
    const inputField = document.getElementById('profilePictureUrlInput');
    const statusMessage = document.getElementById('updatePictureStatusMessage');
    
    if (previewImg && userProfile.photoURL) {
        previewImg.src = userProfile.photoURL;
    } else if (previewImg) {
        previewImg.src = 'https://via.placeholder.com/120/FACC15/0F172A?text=No+Image';
    }
    
    if (inputField) {
        inputField.value = '';
    }
    
    if (statusMessage) {
        statusMessage.style.display = 'none';
        statusMessage.innerHTML = '';
    }
    
    showToast('ðŸ“¸ Long press detected! Update your profile picture', 'info');
}

function handleProfilePicturePreview() {
    const urlInput = document.getElementById('profilePictureUrlInput');
    const previewImg = document.getElementById('profilePicturePreview');
    const statusMessage = document.getElementById('updatePictureStatusMessage');
    
    if (!urlInput || !previewImg) return;
    
    const imageUrl = urlInput.value.trim();
    
    if (!imageUrl) {
        showStatusMessage(statusMessage, 'Please enter an image URL', 'warning');
        showToast('Please enter an image URL', 'warning');
        return;
    }
    
    // Validate URL format
    try {
        const url = new URL(imageUrl);
        
        // Check if URL ends with image extension
        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];
        const hasImageExtension = imageExtensions.some(ext => 
            url.pathname.toLowerCase().endsWith(ext)
        );
        
        if (!hasImageExtension && !url.hostname.includes('imgur') && !url.hostname.includes('imgbb')) {
            showStatusMessage(statusMessage, 'âš ï¸ URL may not be a valid image. Try anyway?', 'warning');
        }
        
    } catch (e) {
        showStatusMessage(statusMessage, 'Invalid URL format', 'danger');
        showToast('Invalid URL format', 'error');
        return;
    }
    
    // Test if image loads
    const testImg = new Image();
    
    testImg.onload = function() {
        previewImg.src = imageUrl;
        showStatusMessage(statusMessage, 'âœ… Image loaded successfully! Click "Save Picture" to update.', 'success');
        showToast('âœ… Preview loaded successfully!', 'success');
    };
    
    testImg.onerror = function() {
        showStatusMessage(statusMessage, 'âŒ Failed to load image. Please check the URL.', 'danger');
        showToast('Failed to load image', 'error');
        previewImg.src = 'https://via.placeholder.com/120/EF4444/FFFFFF?text=Error';
    };
    
    testImg.src = imageUrl;
    
    showStatusMessage(statusMessage, 'Loading preview...', 'info');
}

async function handleSaveProfilePicture() {
    if (!currentUser) {
        showToast('Please login first', 'warning');
        return;
    }
    
    const urlInput = document.getElementById('profilePictureUrlInput');
    const statusMessage = document.getElementById('updatePictureStatusMessage');
    const saveBtn = document.getElementById('saveProfilePictureBtn');
    
    if (!urlInput) return;
    
    const imageUrl = urlInput.value.trim();
    
    if (!imageUrl) {
        showStatusMessage(statusMessage, 'Please enter an image URL', 'warning');
        showToast('Please enter an image URL', 'warning');
        return;
    }
    
    // Validate URL
    try {
        new URL(imageUrl);
    } catch (e) {
        showStatusMessage(statusMessage, 'Invalid URL format', 'danger');
        showToast('Invalid URL format', 'error');
        return;
    }
    
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    
    try {
        const userRef = ref(db, `users/${currentUser.uid}`);
        await update(userRef, { 
            photoURL: imageUrl 
        });
        
        console.log("âœ… Profile picture updated");
        showStatusMessage(statusMessage, 'âœ… Profile picture updated successfully!', 'success');
        showToast('âœ… Profile picture updated!', 'success');
        
        // Update preview in profile section
        const profileAvatar = document.getElementById('profileAvatarEl');
        if (profileAvatar) {
            profileAvatar.src = imageUrl;
        }
        
        setTimeout(() => {
            showSection('profile-section');
        }, 2000);
        
    } catch (error) {
        console.error("âŒ Profile picture update failed:", error);
        showStatusMessage(statusMessage, `Error: ${error.message}`, 'danger');
        showToast(`Error: ${error.message}`, 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> Save Picture';
    }
}

// User Profile Modal Functions
        let currentViewedUser = null;

        function openUserProfileModal(userData) {
            console.log("ðŸ‘¤ Opening user profile modal:", userData.uid);
    
    currentViewedUser = userData;
    
    const modal = document.getElementById('userProfileModalEl');
    const modalUserAvatar = document.getElementById('modalUserAvatarEl');
    const modalUserName = document.getElementById('modalUserNameEl');
    const modalUserTier = document.getElementById('modalUserTierEl');
    const modalUserMatches = document.getElementById('modalUserMatchesEl');
    const modalUserWins = document.getElementById('modalUserWinsEl');
    const modalUserBalance = document.getElementById('modalUserBalanceEl');
    const modalUserEarnings = document.getElementById('modalUserEarningsEl');
    
    if (!modal) return;
    
    // Set user data
    if (modalUserAvatar) modalUserAvatar.src = userData.photoURL;
    if (modalUserName) modalUserName.textContent = userData.displayName;
    
    // Set VIP tier
    const totalMatches = userData.totalMatches || 0;
    let tierText = 'Bronze';
    let tierIcon = 'ðŸ¥‰';
    
    if (totalMatches >= 100) {
        tierText = 'Platinum';
        tierIcon = '';
    } else if (totalMatches >= 50) {
        tierText = 'Gold';
        tierIcon = 'ðŸ¥‡';
    } else if (totalMatches >= 10) {
        tierText = 'Silver';
        tierIcon = 'ðŸ¥ˆ';
    }
    
    if (modalUserTier) {
        modalUserTier.innerHTML = `<i class="bi bi-trophy-fill"></i><span>${tierIcon} ${tierText}</span>`;
    }
    
    // Set stats
    if (modalUserMatches) modalUserMatches.textContent = userData.totalMatches || 0;
    if (modalUserWins) modalUserWins.textContent = userData.wonMatches || 0;
    if (modalUserBalance) modalUserBalance.textContent = `â‚¹${(userData.totalBalance || 0).toFixed(2)}`;
    if (modalUserEarnings) modalUserEarnings.textContent = `â‚¹${(userData.totalEarnings || 0).toFixed(2)}`;
    
    // Show modal
    modal.classList.add('active');
}

        function closeUserProfileModal() {
            const modal = document.getElementById('userProfileModalEl');
            if (modal) {
                modal.classList.remove('active');
                currentViewedUser = null;
            }
        }

async function openFriendsSystemModal() {
    if (!currentUser) {
        showToast('Please login first', 'warning');
        showSection('login-section');
        return;
    }

    const modalEl = document.getElementById('friendsSystemModalEl');
    if (!modalEl) {
        console.error('Friends modal not found');
        return;
    }

    const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
    modalInstance.show();

    // Load initial tab (requests)
    loadFriendRequests();
}

function switchFriendsTab(tabName) {
    const tabs = document.querySelectorAll('.friends-tab');
    const contents = document.querySelectorAll('.friends-tab-content');

    tabs.forEach(tab => {
        if (tab.dataset.friendsTab === tabName) {
            tab.classList.add('active');
            tab.style.background = 'var(--accent-gradient)';
            tab.style.color = 'var(--primary-bg)';
        } else {
            tab.classList.remove('active');
            tab.style.background = 'none';
            tab.style.color = 'var(--text-secondary)';
        }
    });

    contents.forEach(content => {
        content.style.display = 'none';
    });

    const activeContent = document.getElementById(`${tabName}TabEl`);
    if (activeContent) {
        activeContent.style.display = 'block';
    }

    // Load data based on tab
    switch(tabName) {
        case 'requests':
            loadFriendRequests();
            break;
        case 'friends':
            loadMyFriendsList();
            break;
        case 'chats':
            loadPrivateChats();
            break;
        case 'search':
            setupFriendSearch();
            break;
    }

    // Update modal title
    const titleEl = document.getElementById('friendsModalTitleEl');
    if (titleEl) {
        const titles = {
            requests: 'Friend Requests',
            friends: 'My Friends',
            chats: 'Chats',
            search: 'Find Friends'
        };
        titleEl.textContent = titles[tabName] || 'Friends & Chat';
    }
}

async function loadFriendRequests() {
    if (!currentUser) return;

    const listEl = document.getElementById('friendRequestsListEl');
    if (!listEl) return;

    listEl.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></div>';

    try {
        const requestsRef = ref(db, `friendRequests/${currentUser.uid}`);
        const snapshot = await get(requestsRef);

        listEl.innerHTML = '';

        if (snapshot.exists()) {
    const notifications = snapshot.val();
    const notifArray = Object.entries(notifications)
        .map(([id, notif]) => ({ id, ...notif }))
        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            if (pendingRequests.length > 0) {
                for (const [reqId, req] of pendingRequests) {
                    // âœ… Fetch full user data
                    const senderRef = ref(db, `users/${req.fromUserId}`);
                    const senderSnap = await get(senderRef);
                    
                    let senderData = {
                        displayName: req.fromUserName,
                        photoURL: req.fromUserAvatar,
                        totalMatches: 0
                    };
                    
                    if (senderSnap.exists()) {
                        const userData = senderSnap.val();
                        senderData = {
                            displayName: userData.displayName || req.fromUserName,
                            photoURL: userData.photoURL || req.fromUserAvatar,
                            totalMatches: userData.totalMatches || 0
                        };
                    }

                    const avatar = senderData.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(senderData.displayName);

                    // âœ… VIP BADGE
                    let vipBadge = '';
                    if (senderData.totalMatches >= 100) {
                        vipBadge = '';
                    } else if (senderData.totalMatches >= 50) {
                        vipBadge = ' ðŸ¥‡';
                    } else if (senderData.totalMatches >= 10) {
                        vipBadge = ' ðŸ¥ˆ';
                    } else {
                        vipBadge = ' ðŸ¥‰';
                    }

                    const requestCard = document.createElement('div');
                    requestCard.style.cssText = 'background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; border: 1px solid rgba(255, 255, 255, 0.05);';

                    requestCard.innerHTML = `
                        <img src="${avatar}" alt="${senderData.displayName}" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--accent-color); object-fit: cover;">
                        <div style="flex: 1;">
                            <h5 style="margin: 0 0 5px 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">${senderData.displayName}${vipBadge}</h5>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">
                                <i class="bi bi-trophy-fill"></i> ${senderData.totalMatches} matches â€¢ ${new Date(req.timestamp).toLocaleDateString()}
                            </p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-sm btn-custom-accent ripple" onclick="acceptFriendRequest('${reqId}', '${req.fromUserId}')" style="padding: 8px 16px; font-size: 0.85rem;">
                                <i class="bi bi-check-circle"></i> Accept
                            </button>
                            <button class="btn btn-sm btn-custom-secondary ripple" onclick="rejectFriendRequest('${reqId}')" style="padding: 8px 16px; font-size: 0.85rem;">
                                <i class="bi bi-x-circle"></i> Reject
                            </button>
                        </div>
                    `;

                    listEl.appendChild(requestCard);
                }
            } else {
                listEl.innerHTML = '<div class="empty-state" style="padding: 40px 20px; text-align: center;"><i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i><p style="margin-top: 15px; color: var(--text-secondary);">No pending requests</p></div>';
            }
        } else {
            listEl.innerHTML = '<div class="empty-state" style="padding: 40px 20px; text-align: center;"><i class="bi bi-inbox" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i><p style="margin-top: 15px; color: var(--text-secondary);">No requests yet</p></div>';
        }
    } catch (error) {
        console.error('âŒ Error:', error);
        listEl.innerHTML = '<p class="text-danger text-center">Error loading</p>';
    }
}

async function acceptFriendRequest(requestId, fromUserId) {
    if (!currentUser) return;

    try {
        // Add to friends list (both users)
        const updates = {};
        updates[`friends/${currentUser.uid}/${fromUserId}`] = {
            status: 'accepted',
            timestamp: Date.now()
        };
        updates[`friends/${fromUserId}/${currentUser.uid}`] = {
            status: 'accepted',
            timestamp: Date.now()
        };

        // Update request status
        updates[`friendRequests/${currentUser.uid}/${requestId}/status`] = 'accepted';

        await update(ref(db), updates);

        // Send notification
        await sendNotification(
            fromUserId,
            'Friend Request Accepted',
            `${userProfile.displayName || currentUser.email} accepted your friend request!`
        );

        showToast('âœ… Friend request accepted!', 'success');
        loadFriendRequests();
        loadSocialsPageData(); // Update counts

    } catch (error) {
        console.error('âŒ Accept request error:', error);
        showToast(`Failed to accept: ${error.message}`, 'error');
    }
}

async function rejectFriendRequest(requestId) {
    if (!currentUser) return;

    try {
        const requestRef = ref(db, `friendRequests/${currentUser.uid}/${requestId}`);
        await update(requestRef, { status: 'rejected' });

        showToast('Friend request rejected', 'info');
        loadFriendRequests();
        loadSocialsPageData();

    } catch (error) {
        console.error('âŒ Reject request error:', error);
        showToast(`Failed to reject: ${error.message}`, 'error');
    }
}

async function loadMyFriendsList() {
    if (!currentUser) return;

    const listEl = document.getElementById('myFriendsListEl');
    if (!listEl) return;

    listEl.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></div>';

    try {
        const friendsRef = ref(db, `friends/${currentUser.uid}`);
        const snapshot = await get(friendsRef);

        listEl.innerHTML = '';

        if (snapshot.exists()) {
            const friends = snapshot.val();
            const acceptedFriends = Object.entries(friends)
                .filter(([, friend]) => friend.status === 'accepted');

            if (acceptedFriends.length > 0) {
                for (const [friendId] of acceptedFriends) {
                    const friendUserRef = ref(db, `users/${friendId}`);
                    const friendSnap = await get(friendUserRef);

                    if (friendSnap.exists()) {
                        const friendData = friendSnap.val();
                        const avatar = friendData.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(friendData.displayName);

                        // âœ… VIP BADGE
                        let vipBadge = '';
                        const matches = friendData.totalMatches || 0;
                        if (matches >= 100) vipBadge = ' ðŸ’Ž';
                        else if (matches >= 50) vipBadge = ' ðŸ¥‡';
                        else if (matches >= 10) vipBadge = ' ðŸ¥ˆ';
                        else vipBadge = ' ðŸ¥‰';

                        const friendCard = document.createElement('div');
                        friendCard.style.cssText = 'background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; border: 1px solid rgba(255, 255, 255, 0.05);';

                        friendCard.innerHTML = `
                            <img src="${avatar}" alt="${friendData.displayName}" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--accent-color); object-fit: cover; cursor: pointer;">
                            <div style="flex: 1; cursor: pointer;">
                                <h5 style="margin: 0 0 5px 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">${friendData.displayName}${vipBadge}</h5>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">
                                    <i class="bi bi-trophy-fill"></i> ${matches} matches
                                </p>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-custom-primary ripple" onclick="openPrivateChatWith('${friendId}', '${friendData.displayName}')" style="padding: 8px 16px; font-size: 0.85rem;">
                                    <i class="bi bi-chat-dots-fill"></i> Chat
                                </button>
                                <button class="btn btn-sm btn-custom-secondary ripple" onclick="removeFriend('${friendId}')" style="padding: 8px 16px; font-size: 0.85rem;">
                                    <i class="bi bi-person-x"></i>
                                </button>
                            </div>
                        `;

                        friendCard.querySelector('img').onclick = () => {
                            openUserProfileModal({
                                uid: friendId,
                                displayName: friendData.displayName,
                                photoURL: avatar,
                                totalMatches: matches,
                                wonMatches: friendData.wonMatches || 0,
                                totalBalance: (friendData.winningCash || 0) + (friendData.cashBalance || 0) + (friendData.bonusCash || 0),
                                totalEarnings: friendData.totalEarnings || 0
                            });
                        };

                        friendCard.querySelector('div[style*="flex: 1"]').onclick = (e) => {
                            if (!e.target.closest('button')) {
                                openUserProfileModal({
                                    uid: friendId,
                                    displayName: friendData.displayName,
                                    photoURL: avatar,
                                    totalMatches: matches,
                                    wonMatches: friendData.wonMatches || 0,
                                    totalBalance: (friendData.winningCash || 0) + (friendData.cashBalance || 0) + (friendData.bonusCash || 0),
                                    totalEarnings: friendData.totalEarnings || 0
                                });
                            }
                        };

                        listEl.appendChild(friendCard);
                    }
                }
            } else {
                listEl.innerHTML = '<div class="empty-state" style="padding: 40px 20px; text-align: center;"><i class="bi bi-people" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i><p style="margin-top: 15px; color: var(--text-secondary);">No friends yet</p></div>';
            }
        } else {
            listEl.innerHTML = '<div class="empty-state" style="padding: 40px 20px; text-align: center;"><i class="bi bi-people" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i><p style="margin-top: 15px; color: var(--text-secondary);">No friends yet</p></div>';
        }
    } catch (error) {
        console.error('âŒ Error:', error);
        listEl.innerHTML = '<p class="text-danger text-center">Error loading</p>';
    }
}

function openPrivateChatWith(friendId, friendName) {
    const modalEl = document.getElementById('friendsSystemModalEl');
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    if (modalInstance) modalInstance.hide();
    
    showToast(`Private chat with ${friendName} coming soon! ðŸ”œ`, 'info', 3000);
}

function openPrivateChatWithFriend(friendId, friendName) {
    showToast(`Private chat with ${friendName} coming soon!`, 'info', 3000);
    console.log("ðŸ”œ Opening private chat with:", friendId);
}

async function removeFriend(friendId) {
    if (!currentUser) return;

    if (!confirm('Remove this friend?')) return;

    try {
        const updates = {};
        updates[`friends/${currentUser.uid}/${friendId}`] = null;
        updates[`friends/${friendId}/${currentUser.uid}`] = null;

        await update(ref(db), updates);

        showToast('Friend removed', 'info');
        loadMyFriendsList();
        loadSocialsPageData();

    } catch (error) {
        console.error('âŒ Remove friend error:', error);
        showToast(`Failed to remove: ${error.message}`, 'error');
    }
}

function loadPrivateChats() {
    const listEl = document.getElementById('chatsListEl');
    if (!listEl) return;

    listEl.innerHTML = `
        <div class="empty-state" style="padding: 40px 20px; text-align: center;">
            <i class="bi bi-chat-dots" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i>
            <h4 style="margin-top: 15px; color: var(--text-primary); font-weight: 600;">Private Chat Coming Soon!</h4>
            <p style="margin-top: 10px; color: var(--text-secondary);">
                We're working on private messaging between friends.<br>
                For now, use the Live Chat to communicate with other players!
            </p>
            <button class="btn btn-custom btn-custom-accent mt-3 ripple" onclick="closeModalAndOpenLiveChat()" style="padding: 12px 24px;">
                <i class="bi bi-chat-dots-fill"></i> Go to Live Chat
            </button>
        </div>
    `;
}

function closeModalAndOpenLiveChat() {
    const modalEl = document.getElementById('friendsSystemModalEl');
    if (modalEl) {
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) modalInstance.hide();
    }
    showSection('chat-section');
}

function setupFriendSearch() {
    const searchInput = document.getElementById('searchFriendsInputEl');
    const resultsEl = document.getElementById('searchFriendsResultsEl');

    if (!searchInput || !resultsEl) return;

    searchInput.value = '';
    resultsEl.innerHTML = '<p class="text-secondary text-center small">Enter a username or email to search</p>';

    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim().toLowerCase();

        if (query.length < 2) {
            resultsEl.innerHTML = '<p class="text-secondary text-center small">Enter at least 2 characters to search</p>';
            return;
        }

        resultsEl.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></div>';

        searchTimeout = setTimeout(async () => {
            await searchFriends(query);
        }, 500);
    });
}

async function searchFriends(query) {
    if (!currentUser) return;

    const resultsEl = document.getElementById('searchFriendsResultsEl');
    if (!resultsEl) return;

    try {
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);

        resultsEl.innerHTML = '';

        if (snapshot.exists()) {
            const users = snapshot.val();
            const matchedUsers = Object.entries(users)
                .filter(([uid, userData]) => {
                    if (uid === currentUser.uid) return false; // Exclude self
                    const displayName = (userData.displayName || '').toLowerCase();
                    const email = (userData.email || '').toLowerCase();
                    return displayName.includes(query) || email.includes(query);
                })
                .slice(0, 10); // Limit to 10 results

            if (matchedUsers.length > 0) {
                for (const [userId, userData] of matchedUsers) {
                    // Check if already friends
                    const friendsRef = ref(db, `friends/${currentUser.uid}/${userId}`);
                    const friendSnapshot = await get(friendsRef);
                    const isFriend = friendSnapshot.exists();

                    // Check if request already sent
                    const requestsRef = ref(db, `friendRequests/${userId}`);
                    const requestsSnapshot = await get(requestsRef);
                    let requestSent = false;
                    if (requestsSnapshot.exists()) {
                        const requests = requestsSnapshot.val();
                        requestSent = Object.values(requests).some(r => 
                            r.fromUserId === currentUser.uid && r.status === 'pending'
                        );
                    }

                    const userCard = document.createElement('div');
                    userCard.className = 'search-result-card';
                    userCard.style.cssText = 'background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; gap: 15px; border: 1px solid rgba(255, 255, 255, 0.05);';

                    const avatar = userData.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(userData.displayName);

                    let actionButton = '';
                    if (isFriend) {
                        actionButton = '<span class="badge bg-success">Already Friends</span>';
                    } else if (requestSent) {
                        actionButton = '<span class="badge bg-warning">Request Sent</span>';
                    } else {
                        actionButton = `<button class="btn btn-sm btn-custom-accent ripple" onclick="sendFriendRequestFromSearch('${userId}', '${userData.displayName}')" style="padding: 8px 16px; font-size: 0.85rem;"><i class="bi bi-person-plus-fill"></i> Add Friend</button>`;
                    }

                    userCard.innerHTML = `
                        <img src="${avatar}" alt="${userData.displayName}" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--accent-color); object-fit: cover; cursor: pointer;" onclick="openUserProfileModal({uid: '${userId}', displayName: '${userData.displayName}', photoURL: '${avatar}', totalMatches: ${userData.totalMatches || 0}, wonMatches: ${userData.wonMatches || 0}, totalBalance: ${(userData.winningCash || 0) + (userData.cashBalance || 0) + (userData.bonusCash || 0)}, totalEarnings: ${userData.totalEarnings || 0}})">
                        <div style="flex: 1; cursor: pointer;" onclick="openUserProfileModal({uid: '${userId}', displayName: '${userData.displayName}', photoURL: '${avatar}', totalMatches: ${userData.totalMatches || 0}, wonMatches: ${userData.wonMatches || 0}, totalBalance: ${(userData.winningCash || 0) + (userData.cashBalance || 0) + (userData.bonusCash || 0)}, totalEarnings: ${userData.totalEarnings || 0}})">
                            <h5 style="margin: 0 0 5px 0; font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">${userData.displayName}</h5>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.8rem;">
                                <i class="bi bi-trophy-fill"></i> ${userData.totalMatches || 0} matches
                            </p>
                        </div>
                        ${actionButton}
                    `;

                    resultsEl.appendChild(userCard);
                }
            } else {
                resultsEl.innerHTML = '<div class="empty-state" style="padding: 40px 20px; text-align: center;"><i class="bi bi-search" style="font-size: 3rem; color: var(--text-secondary); opacity: 0.5;"></i><p style="margin-top: 15px; color: var(--text-secondary);">No users found matching your search</p></div>';
            }
        } else {
            resultsEl.innerHTML = '<p class="text-secondary text-center">No users found</p>';
        }
    } catch (error) {
        console.error('âŒ Search error:', error);
        resultsEl.innerHTML = '<p class="text-danger text-center">Error searching users</p>';
    }
}

async function sendFriendRequestFromSearch(userId, userName) {
    if (!currentUser) {
        showToast('Please login first', 'warning');
        return;
    }

    try {
        // Send friend request
        const newRequestRef = push(ref(db, `friendRequests/${userId}`));
        await set(newRequestRef, {
            fromUserId: currentUser.uid,
            fromUserName: userProfile.displayName || currentUser.email,
            fromUserAvatar: userProfile.photoURL || null,
            toUserId: userId,
            status: 'pending',
            timestamp: Date.now()
        });

        // Send notification WITH requestId and userId
const notifRef = ref(db, `notifications/${userId}`);
await push(notifRef, {
    title: 'Friend Request',
    message: `${userProfile.displayName || currentUser.email} sent you a friend request!`,
    timestamp: Date.now(),
    read: false,
    type: 'friend_request', // âœ… Mark as friend request
    requestId: newRequestRef.key, // âœ… Store request ID
    fromUserId: currentUser.uid, // âœ… Store sender ID
    imageUrl: userProfile.photoURL || null
});

        showToast('âœ… Friend request sent!', 'success');
        
        // Refresh search results
        const searchInput = document.getElementById('searchFriendsInputEl');
        if (searchInput && searchInput.value) {
            await searchFriends(searchInput.value.trim().toLowerCase());
        }

    } catch (error) {
        console.error('âŒ Send request error:', error);
        showToast(`Failed to send request: ${error.message}`, 'error');
    }
}

async function sendFriendRequestTo(userId, userName) {
    if (!currentUser) {
        showToast('Please login first', 'warning');
        return;
    }

    try {
        // Check if already friends
        const friendsRef = ref(db, `friends/${currentUser.uid}/${userId}`);
        const friendSnapshot = await get(friendsRef);
        
        if (friendSnapshot.exists()) {
            showToast('Already friends with this user', 'info');
            return;
        }
        
        // Check if request already sent
        const requestsRef = ref(db, `friendRequests/${userId}`);
        const requestsSnapshot = await get(requestsRef);
        
        if (requestsSnapshot.exists()) {
            const requests = requestsSnapshot.val();
            const existingRequest = Object.values(requests).find(r => 
                r.fromUserId === currentUser.uid && r.status === 'pending'
            );
            
            if (existingRequest) {
                showToast('Friend request already sent', 'info');
                return;
            }
        }
        
        // Send friend request
        const newRequestRef = push(ref(db, `friendRequests/${userId}`));
        await set(newRequestRef, {
            fromUserId: currentUser.uid,
            fromUserName: userProfile.displayName || currentUser.email,
            fromUserAvatar: userProfile.photoURL || null,
            toUserId: userId,
            status: 'pending',
            timestamp: Date.now()
        });
        
        // Send notification
        await sendNotification(
            userId,
            'Friend Request',
            `${userProfile.displayName || currentUser.email} sent you a friend request!`
        );
        
        showToast('âœ… Friend request sent!', 'success');
        console.log("âœ… Friend request sent to:", userId);
        
    } catch (error) {
        console.error("âŒ Friend request error:", error);
        showToast(`Failed: ${error.message}`, 'error');
    }
}

// ========================================
// ðŸ”” NOTIFICATION FRIEND REQUEST ACCEPT/REJECT
// ========================================

async function acceptFriendRequestFromNotification(requestId, fromUserId, notificationId) {
    if (!currentUser) return;

    try {
        // Add to friends list (both users)
        const updates = {};
        updates[`friends/${currentUser.uid}/${fromUserId}`] = {
            status: 'accepted',
            timestamp: Date.now()
        };
        updates[`friends/${fromUserId}/${currentUser.uid}`] = {
            status: 'accepted',
            timestamp: Date.now()
        };

        // Update request status
        updates[`friendRequests/${currentUser.uid}/${requestId}/status`] = 'accepted';
        
        // Mark notification as read
        updates[`notifications/${currentUser.uid}/${notificationId}/read`] = true;

        await update(ref(db), updates);

        // Send notification to requester
        await sendNotification(
            fromUserId,
            'Friend Request Accepted',
            `${userProfile.displayName || currentUser.email} accepted your friend request!`
        );

        showToast('âœ… Friend request accepted!', 'success');
        
        // Reload notifications
        loadNotifications();
        loadSocialsPageData();

        console.log("âœ… Friend request accepted from notification");

    } catch (error) {
        console.error('âŒ Accept request error:', error);
        showToast(`Failed to accept: ${error.message}`, 'error');
        loadNotifications(); // Reload to reset button
    }
}

async function rejectFriendRequestFromNotification(requestId, notificationId) {
    if (!currentUser) return;

    try {
        const updates = {};
        
        // Update request status
        updates[`friendRequests/${currentUser.uid}/${requestId}/status`] = 'rejected';
        
        // Mark notification as read
        updates[`notifications/${currentUser.uid}/${notificationId}/read`] = true;

        await update(ref(db), updates);

        showToast('Friend request rejected', 'info');
        
        // Reload notifications
        loadNotifications();
        loadSocialsPageData();

        console.log("âœ… Friend request rejected from notification");

    } catch (error) {
        console.error('âŒ Reject request error:', error);
        showToast(`Failed to reject: ${error.message}`, 'error');
        loadNotifications(); // Reload to reset button
    }
}

// ========================================
// ðŸ†• END FRIENDS SYSTEM FUNCTIONS
// ========================================

        async function sendFriendRequestFromModal() {
            if (!currentUser || !currentViewedUser) {
        showToast('Please login first', 'warning');
        return;
    }
    
    if (currentUser.uid === currentViewedUser.uid) {
        showToast('You cannot send friend request to yourself', 'warning');
        return;
    }
    
    const sendBtn = document.getElementById('sendFriendRequestBtnEl');
    if (!sendBtn) return;
    
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
    
    try {
        // Check if already friends
        const friendsRef = ref(db, `friends/${currentUser.uid}/${currentViewedUser.uid}`);
        const friendSnapshot = await get(friendsRef);
        
        if (friendSnapshot.exists()) {
            showToast('Already friends with this user', 'info');
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="bi bi-person-plus-fill"></i><span>Send Friend Request</span>';
            return;
        }
        
        // Check if request already sent
        const requestsRef = ref(db, `friendRequests/${currentViewedUser.uid}`);
        const requestsSnapshot = await get(requestsRef);
        
        if (requestsSnapshot.exists()) {
            const requests = requestsSnapshot.val();
            const existingRequest = Object.values(requests).find(r => 
                r.fromUserId === currentUser.uid && r.status === 'pending'
            );
            
            if (existingRequest) {
                showToast('Friend request already sent', 'info');
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="bi bi-person-plus-fill"></i><span>Send Friend Request</span>';
                return;
            }
        }
        
        // Send friend request
        const newRequestRef = push(ref(db, `friendRequests/${currentViewedUser.uid}`));
        await set(newRequestRef, {
            fromUserId: currentUser.uid,
            fromUserName: userProfile.displayName || currentUser.email,
            fromUserAvatar: userProfile.photoURL || null,
            toUserId: currentViewedUser.uid,
            status: 'pending',
            timestamp: Date.now() // Use Date.now() instead of serverTimestamp()
        });
        
        // Send notification
        await sendNotification(
            currentViewedUser.uid,
            'Friend Request',
            `${userProfile.displayName || currentUser.email} sent you a friend request!`
        );
        
        showToast('âœ… Friend request sent!', 'success');
        console.log("âœ… Friend request sent to:", currentViewedUser.uid);
        
        sendBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i><span>Request Sent</span>';
        sendBtn.disabled = true;
        
    } catch (error) {
        console.error("âŒ Friend request error:", error);
        showToast(`Failed to send friend request: ${error.message}`, 'error');
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="bi bi-person-plus-fill"></i><span>Send Friend Request</span>';
    }
}

        function openPrivateChatFromModal() {
            if (!currentUser || !currentViewedUser) {
                showToast('Please login first', 'warning');
                return;
            }
            
            if (currentUser.uid === currentViewedUser.uid) {
                showToast('You cannot chat with yourself', 'warning');
                return;
            }
            
            // Close profile modal
            closeUserProfileModal();
            
            // Open chat section with this user
            showSection('chat-section');
            
            // TODO: Implement private chat functionality
            showToast(`Opening chat with ${currentViewedUser.displayName}...`, 'info', 3000);
            
            // For now, just show a message
            setTimeout(() => {
                showToast('Private chat feature coming soon! Use Live Chat for now.', 'warning', 5000);
            }, 1500);
        }

        function initializeEventListeners() {
            console.log("ðŸŽ¯ Initializing event listeners");

            elements.bottomNavItems?.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(item.dataset.section);
                });
            });

            elements.headerBackBtn?.addEventListener('click', () => showSection('home-section'));

            elements.tournamentTabs?.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const s = e.currentTarget.dataset.status;
                    if (currentTournamentGameId && s) {
                        elements.tournamentTabs.forEach(t => t.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        filterTournaments(currentTournamentGameId, s);
                    }
                });
            });

            elements.myGamesTabs?.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const status = e.currentTarget.dataset.myGamesStatus;
                    if (status) {
                        elements.myGamesTabs.forEach(t => t.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        loadMyGames(status);
                    }
                });
            });

            elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
            elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
            elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false));
            elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true));
            elements.forgotPasswordLink?.addEventListener('click', (e) => {
                e.preventDefault();
                resetPassword();
            });
            elements.forgotPasswordFromSettings?.addEventListener('click', (e) => {
                e.preventDefault();
                showSection('login-section');
                setTimeout(() => {
                    if (elements.forgotPasswordLink) {
                        elements.forgotPasswordLink.click();
                    }
                }, 300);
            });

            elements.logoutProfileBtn?.addEventListener('click', logoutUser);
            elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick));
            elements.notificationSwitch?.addEventListener('change', (e) => {
                console.log("ðŸ”” Notification toggle:", e.target.checked);
            });

            elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
            elements.withdrawBtn2?.addEventListener('click', handleWithdrawClick);
            elements.addAmountWalletBtn?.addEventListener('click', () => {
                if (currentUser) {
                    elements.addAmountInput.value = '';
                    elements.addUtrInput.value = '';
                    elements.addUtrInput.classList.remove('is-valid', 'is-invalid');
                    clearStatusMessage(elements.addAmountStatusMessage);

                    selectedUtrType = '11';
                    document.querySelectorAll('.utr-type-btn').forEach(btn => {
                        if (btn.dataset.utrType === '11') {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });

                    const modalEl = document.getElementById('addAmountModalEl');
                    const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    modalInstance.show();
                } else {
                    showToast("Please login first", 'warning');
                    showSection('login-section');
                }
            });

            elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);

            if (elements.submitAddAmountBtn) {
                elements.submitAddAmountBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log("ðŸŸ¢ Submit Add Amount button clicked!");
                    submitAddAmountRequest();
                });

                console.log("âœ… Submit Add Amount button listeners attached");
            }

            if (elements.submitTeamDetailsBtn) {
                elements.submitTeamDetailsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log("ðŸŸ¢ Submit Team Details button clicked!");
                    submitTeamDetails();
                });
                console.log("âœ… Submit Team Details button listener attached");
            }

            setupUtrTypeSelector();

            setupUtrValidation();

            document.addEventListener('click', (event) => {
                if (event.target.matches('.quick-amount')) {
                    const amount = event.target.dataset.amount;
                    if (elements.addAmountInput && amount) {
                        elements.addAmountInput.value = amount;
                        console.log(`ðŸ’° Quick amount selected: ${amount}`);
                    }
                }
            });

            elements.notificationBtn?.addEventListener('click', () => {
                if (currentUser) {
                    showSection('notifications-section');
                } else {
                    showToast('Please login to view notifications', 'warning');
                    showSection('login-section');
                }
            });

            elements.allTransactionsBtn?.addEventListener('click', () => {
                if (currentUser) {
                    showSection('transaction-history-section');
                } else {
                    showToast('Please login to view transaction history', 'warning');
                    showSection('login-section');
                }
            });

            elements.viewEarningsHistoryBtn?.addEventListener('click', () => {
                if (currentUser) {
                    loadEarningsHistory();
                } else {
                    showToast('Please login to view earnings history', 'warning');
                    showSection('login-section');
                }
            });

            elements.updateNicknameBtn?.addEventListener('click', handleUpdateNickname);
            elements.redeemCouponBtn?.addEventListener('click', handleRedeemCoupon);
            elements.sendFeedbackBtn?.addEventListener('click', handleSendFeedback);
            elements.changePasswordBtn?.addEventListener('click', changePassword);

            // âœ… Chat listeners - prevent duplicates
            if (elements.chatSendBtn) {
                const oldBtn = elements.chatSendBtn;
                const newBtn = oldBtn.cloneNode(true);
                oldBtn.parentNode.replaceChild(newBtn, oldBtn);
                elements.chatSendBtn = newBtn;
                newBtn.addEventListener('click', sendChatMessage);
            }
            
            if (elements.chatInput) {
                const oldInput = elements.chatInput;
                const newInput = oldInput.cloneNode(true);
                oldInput.parentNode.replaceChild(newInput, oldInput);
                elements.chatInput = newInput;
                newInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }

// Profile Picture Long Press Handler
let profilePicturePressTimer;
const profileAvatar = document.getElementById('profileAvatarEl');

if (profileAvatar) {
    // Mobile Long Press
    profileAvatar.addEventListener('touchstart', (e) => {
        e.preventDefault();
        profilePicturePressTimer = setTimeout(() => {
            if (currentUser) {
                openUpdateProfilePictureSection();
            } else {
                showToast('Please login to update profile picture', 'warning');
            }
        }, 800); // 800ms long press
    });

    profileAvatar.addEventListener('touchend', () => {
        clearTimeout(profilePicturePressTimer);
    });

    profileAvatar.addEventListener('touchmove', () => {
        clearTimeout(profilePicturePressTimer);
    });

    // Desktop Right Click
    profileAvatar.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        if (currentUser) {
            openUpdateProfilePictureSection();
        } else {
            showToast('Please login to update profile picture', 'warning');
        }
    });

    // Desktop Click (Optional - remove if you only want long press)
    profileAvatar.addEventListener('click', () => {
        if (currentUser) {
            showToast('Long press to update profile picture', 'info');
        }
    });
}

// Profile Picture Preview Button
const previewImageBtn = document.getElementById('previewImageBtn');
if (previewImageBtn) {
    previewImageBtn.addEventListener('click', handleProfilePicturePreview);
}

// Save Profile Picture Button
const saveProfilePictureBtn = document.getElementById('saveProfilePictureBtn');
if (saveProfilePictureBtn) {
    saveProfilePictureBtn.addEventListener('click', handleSaveProfilePicture);
}

            document.querySelectorAll('[data-action]').forEach(element => {
    element.addEventListener('click', (e) => {
        e.preventDefault();
        const action = element.dataset.action;
        switch (action) {
            case 'update-profile-avatar':
                openUpdateProfilePictureSection();
                break;
            case 'edit-nickname':
                showSection('edit-nickname-section');
                break;
            case 'redeem-coupon':
                showSection('redeem-coupon-section');
                break;
            case 'send-feedback':
                showSection('send-feedback-section');
                break;
            case 'change-password':
                showSection('change-password-section');
                break;
            case 'match-history':
                showSection('match-history-section');
                break;
            case 'withdraw-history':
                showSection('withdraw-history-section');
                break;
            case 'transaction-history':
                showSection('transaction-history-section');
                break;
            case 'view-vip-program':
                showSection('vip-program-section');
                loadVIPProgramPage();
                break;
            case 'view-socials':
                showSection('socials-section');
                loadSocialsPageData();
                break;
            case 'view-achievements':
                showSection('achievements-section');
                loadAchievements();
                break;
            case 'view-my-badges':
                showSection('my-badges-section');
                loadMyBadges();
                break;
        }
    });
});;

// Social Section Button Listeners - NEW
document.getElementById('openFriendRequestsBtn')?.addEventListener('click', (e) => {
    e.preventDefault();
    openFriendsSystemModal();
    setTimeout(() => switchFriendsTab('requests'), 100);
});

document.getElementById('openMyFriendsBtn')?.addEventListener('click', (e) => {
    e.preventDefault();
    openFriendsSystemModal();
    setTimeout(() => switchFriendsTab('friends'), 100);
});

document.getElementById('openChatsBtn')?.addEventListener('click', (e) => {
    e.preventDefault();
    openFriendsSystemModal();
    setTimeout(() => switchFriendsTab('chats'), 100);
});

document.getElementById('openSearchFriendsBtn')?.addEventListener('click', (e) => {
    e.preventDefault();
    openFriendsSystemModal();
    setTimeout(() => switchFriendsTab('search'), 100);
});

// Friends System Modal Listeners - NEW
            const friendsTabs = document.querySelectorAll('.friends-tab');
            friendsTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchFriendsTab(tab.dataset.friendsTab);
                });
            });

// User Profile Modal Listeners
            const closeUserProfileModalBtn = document.getElementById('closeUserProfileModalEl');
            if (closeUserProfileModalBtn) {
                closeUserProfileModalBtn.addEventListener('click', closeUserProfileModal);
            }
            
            const userProfileModal = document.getElementById('userProfileModalEl');
            if (userProfileModal) {
                userProfileModal.addEventListener('click', (e) => {
                    if (e.target === userProfileModal) {
                        closeUserProfileModal();
                    }
                });
            }
            
            const sendFriendRequestBtn = document.getElementById('sendFriendRequestBtnEl');
            if (sendFriendRequestBtn) {
                sendFriendRequestBtn.addEventListener('click', sendFriendRequestFromModal);
            }
            
            const openPrivateChatBtn = document.getElementById('openPrivateChatBtnEl');
            if (openPrivateChatBtn) {
                openPrivateChatBtn.addEventListener('click', openPrivateChatFromModal);
            }

            console.log("âœ… Event listeners initialized");
        }

// Congratulations Modal Close
            const congratsCloseBtn = document.getElementById('congratsCloseEl');
            if (congratsCloseBtn) {
                congratsCloseBtn.addEventListener('click', () => {
                    const congratsModal = document.getElementById('congratsModalEl');
                    if (congratsModal) {
                        congratsModal.classList.remove('active');
                    }
                });
            }
            
            const congratsModal = document.getElementById('congratsModalEl');
            if (congratsModal) {
                congratsModal.addEventListener('click', (e) => {
                    if (e.target === congratsModal) {
                        congratsModal.classList.remove('active');
                    }
                });
            };

        document.addEventListener('DOMContentLoaded', () => {
            console.log("=== ðŸš€ App Initialization Started ===");

            if (typeof initializeApp !== 'function' || !auth || !db) {
                console.error("âŒ Firebase SDK not ready");
                return;
            }

            showLoader(true);

            // âœ… CRITICAL FIX: Clear any cached auth on page load
            if (!sessionStorage.getItem('sessionActive')) {
                console.log("ðŸ†• New session - clearing cached auth");
                try {
                    // Clear Firebase auth cache
                    const authKeys = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith('firebase:') || key.includes('authUser'))) {
                            authKeys.push(key);
                        }
                    }
                    authKeys.forEach(k => {
                        try {
                            localStorage.removeItem(k);
                        } catch(e) {}
                    });
                    
                    // Mark this session as active
                    sessionStorage.setItem('sessionActive', 'true');
                    console.log("âœ… Cleared", authKeys.length, "cached auth keys");
                } catch(e) {
                    console.warn("Cache clear warning:", e);
                }
            }

            initializeEventListeners();

            updateGlobalUI(false);

            loadAppSettings();

            onAuthStateChanged(auth, handleAuthStateChange);
    
            isAppInitialized = true;
            console.log("=== âœ… App Initialization Complete ===");
        });

    </script>

</body>

</html>